# blueprint: portable-skills-no-npx

implementation plan to eliminate npx dependency for package manager portability


# summary

replace `npx tsx` dispatch with direct `node` dispatch via dynamic `import()`.

**from:**
```bash
exec npx tsx -e "import('rhachet-roles-bhuild').then(m => m.cli.X())" -- "$@"
```

**to:**
```bash
exec node -e "import('rhachet-roles-bhuild').then(m => m.cli.X())" -- "$@"
```

this works because:
- dynamic `import()` works in node's default CommonJS context [research claim 21]
- node's module resolution is identical across npm, pnpm, yarn, bun [claim 15]
- no tsx/esbuild compilation occurs at runtime [claim 11]
- no npx package discovery/execution overhead


# step.1 = update shell skills

## 1.1 = modify behaver skills

update dispatch line in each skill file:

| file | change |
|------|--------|
| `src/domain.roles/behaver/skills/init.behavior.sh` | `npx tsx` → `node` |
| `src/domain.roles/behaver/skills/bind.behavior.sh` | `npx tsx` → `node` |
| `src/domain.roles/behaver/skills/give.feedback.sh` | `npx tsx` → `node` |
| `src/domain.roles/behaver/skills/review.behavior.sh` | no change (pure shell) |
| `src/domain.roles/behaver/skills/review.deliverable.sh` | verify dispatch pattern |

## 1.2 = modify decomposer skills

| file | change |
|------|--------|
| `src/domain.roles/decomposer/skills/decompose.behavior.sh` | `npx tsx` → `node` |
| `src/domain.roles/decomposer/skills/review.behavior.sh` | verify dispatch pattern |

## 1.3 = pattern to apply

```bash
# before
exec npx tsx -e "import('rhachet-roles-bhuild').then(m => m.cli.initBehavior())" -- "$@"

# after
exec node -e "import('rhachet-roles-bhuild').then(m => m.cli.initBehavior())" -- "$@"
```

the `-- "$@"` passthrough remains unchanged.


# step.2 = verify package.json exports

## 2.1 = check exports field

current package.json has:
```json
{
  "main": "dist/index.js"
}
```

node's self-reference requires both `name` and `exports` fields [claim 12].

add explicit exports:
```json
{
  "name": "rhachet-roles-bhuild",
  "main": "dist/index.js",
  "exports": {
    ".": "./dist/index.js"
  }
}
```

## 2.2 = verify type field

current package.json does not have `"type": "module"`.

this is correct - the compiled output is CommonJS, and dynamic `import()` works in CJS context [claim 21].

## 2.3 = update engines field

current:
```json
{
  "engines": {
    "node": ">=8.0.0"
  }
}
```

update to require node 18 LTS for:
- stable ESM support
- self-reference support (v12.17+)
- modern dynamic import() behavior

```json
{
  "engines": {
    "node": ">=18.0.0"
  }
}
```


# step.3 = test coverage

## 3.1 = unit tests

minimal new domain logic - the dispatch mechanism change is in shell, not TypeScript.

verify prior unit tests still pass after changes:
- `src/contract/cli/*.ts` entry points unchanged
- `src/domain.operations/**/*.test.ts` unchanged

## 3.2 = integration tests

create new integration test to verify skill dispatch:

**file:** `src/contract/cli/dispatch.integration.test.ts`

```typescript
import { given, when, then, useBeforeAll } from 'test-fns';
import { execSync } from 'child_process';
import * as path from 'path';

describe('skill dispatch via node', () => {
  given('[case1] skill invoked via node -e pattern', () => {
    when('[t0] dispatch command executed', () => {
      then('import resolves to package exports', async () => {
        const result = execSync(
          'node -e "import(\'rhachet-roles-bhuild\').then(m => console.log(typeof m.cli))"',
          { encoding: 'utf-8', cwd: process.cwd() }
        );
        expect(result.trim()).toEqual('object');
      });

      then('cli entry points are accessible', async () => {
        const result = execSync(
          'node -e "import(\'rhachet-roles-bhuild\').then(m => console.log(Object.keys(m.cli).join(\',\')))"',
          { encoding: 'utf-8', cwd: process.cwd() }
        );
        expect(result).toContain('initBehavior');
        expect(result).toContain('bindBehavior');
      });
    });
  });

  given('[case2] skill invoked without npx in PATH', () => {
    when('[t0] PATH excludes npm/npx directories', () => {
      then('skill still executes via node', async () => {
        const minimalPath = '/usr/bin:/bin';
        const result = execSync(
          'node -e "import(\'rhachet-roles-bhuild\').then(m => console.log(\'ok\'))"',
          {
            encoding: 'utf-8',
            cwd: process.cwd(),
            env: { ...process.env, PATH: `${process.execPath.replace('/node', '')}:${minimalPath}` }
          }
        );
        expect(result.trim()).toEqual('ok');
      });
    });
  });
});
```

## 3.3 = acceptance tests

create blackbox acceptance test:

**file:** `src/contract/cli/portable-dispatch.acceptance.test.ts`

```typescript
import { given, when, then } from 'test-fns';
import { execSync, spawnSync } from 'child_process';
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';

describe('portable skill dispatch', () => {
  given('[case1] consumer repo with rhachet-roles-bhuild installed', () => {
    when('[t0] skill invoked via shell', () => {
      then('init.behavior executes without npx', async () => {
        const skillPath = path.join(
          process.cwd(),
          'dist/domain.roles/behaver/skills/init.behavior.sh'
        );

        // verify skill does not contain npx
        const content = fs.readFileSync(skillPath, 'utf-8');
        expect(content).not.toContain('npx tsx');
        expect(content).toContain('node -e');
      });

      then('bind.behavior executes without npx', async () => {
        const skillPath = path.join(
          process.cwd(),
          'dist/domain.roles/behaver/skills/bind.behavior.sh'
        );

        const content = fs.readFileSync(skillPath, 'utf-8');
        expect(content).not.toContain('npx tsx');
        expect(content).toContain('node -e');
      });
    });
  });

  given('[case2] package.json configured for portability', () => {
    when('[t0] exports field checked', () => {
      then('exports field is present', () => {
        const pkgPath = path.join(process.cwd(), 'package.json');
        const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));
        expect(pkg.exports).toBeDefined();
        expect(pkg.exports['.']).toBeDefined();
      });

      then('engines requires node 18+', () => {
        const pkgPath = path.join(process.cwd(), 'package.json');
        const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));
        expect(pkg.engines.node).toMatch(/>=18/);
      });
    });
  });
});
```


# step.4 = update documentation

## 4.1 = update portable-skills-pattern brief

the brief at `.agent/repo=.this/role=any/briefs/portable-skills-pattern.md` references the old pattern.

update from:
```bash
exec npx tsx -e "import('rhachet-roles-bhuild').then(m => m.cli.mySkill())" -- "$@"
```

to:
```bash
exec node -e "import('rhachet-roles-bhuild').then(m => m.cli.mySkill())" -- "$@"
```

## 4.2 = remove tsx runtime dependency note

the brief mentions tsx for TypeScript execution - update to clarify:
- development uses tsx for fast iteration
- production dispatch uses compiled JS via node directly


# step.5 = verify build pipeline

## 5.1 = build and link

```bash
npm run build
npx rhachet roles link --role behaver
npx rhachet roles init --role behaver
```

## 5.2 = test skill execution

```bash
# should work without npx in critical path
npx rhachet run --skill init.behavior --name test-portable
```


# dependencies

## required changes

1. shell skill files (step.1) - direct code changes
2. package.json exports (step.2.1) - enables self-reference
3. package.json engines (step.2.3) - documents requirement

## optional changes

1. documentation updates (step.4) - can follow implementation
2. additional test coverage (step.3) - validates but doesn't block


# risks

## risk.1 = node version requirement

**risk:** consumers on node < 18 will fail
**mitigation:** engines field prevents install, clear error message
**probability:** low (node 18 is LTS, most projects already require it)

## risk.2 = package resolution edge cases

**risk:** some package manager configurations may not resolve correctly
**mitigation:** integration tests across npm/pnpm/yarn/bun
**probability:** low (standard node module resolution)

## risk.3 = self-reference in development

**risk:** development mode (file:. self-reference) may behave differently
**mitigation:** test both installed and development contexts
**probability:** low (already works with npx tsx)


# validation checklist

- [ ] all shell skills use `node -e` instead of `npx tsx`
- [ ] package.json has `exports` field
- [ ] package.json engines requires node >= 18
- [ ] `npm run build` succeeds
- [ ] `npm run test` passes
- [ ] skills execute without npx in PATH
- [ ] skills work when installed via pnpm
- [ ] documentation updated
