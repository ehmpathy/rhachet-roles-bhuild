# roadmap: portable-skills-no-npx

execution checklist with ordered dependencies and behavioral verification


# phase.1 = package configuration

## task.1.1 = add exports field to package.json

- [ ] **do**: add `"exports": { ".": "./dist/index.js" }` to package.json
- **depends on**: none
- **acceptance**: package.json contains exports field with root entry
- **verify**:
  ```bash
  node -e "const pkg = require('./package.json'); console.log(pkg.exports['.'])" | grep -q "dist/index.js" && echo "✓ pass" || echo "✗ fail"
  ```

## task.1.2 = update engines field to node >= 18

- [ ] **do**: change `"engines": { "node": ">=8.0.0" }` to `"engines": { "node": ">=18.0.0" }`
- **depends on**: none
- **acceptance**: package.json engines field requires node 18+
- **verify**:
  ```bash
  node -e "const pkg = require('./package.json'); console.log(pkg.engines.node)" | grep -q ">=18" && echo "✓ pass" || echo "✗ fail"
  ```


# phase.2 = shell skill updates

## task.2.1 = update init.behavior.sh

- [ ] **do**: replace `exec npx tsx -e` with `exec node -e` in `src/domain.roles/behaver/skills/init.behavior.sh`
- **depends on**: task.1.1 (exports field required for import resolution)
- **acceptance**: file contains `node -e` and does not contain `npx tsx`
- **verify**:
  ```bash
  grep -q "node -e" src/domain.roles/behaver/skills/init.behavior.sh && \
  ! grep -q "npx tsx" src/domain.roles/behaver/skills/init.behavior.sh && \
  echo "✓ pass" || echo "✗ fail"
  ```

## task.2.2 = update bind.behavior.sh

- [ ] **do**: replace `exec npx tsx -e` with `exec node -e` in `src/domain.roles/behaver/skills/bind.behavior.sh`
- **depends on**: task.1.1
- **acceptance**: file contains `node -e` and does not contain `npx tsx`
- **verify**:
  ```bash
  grep -q "node -e" src/domain.roles/behaver/skills/bind.behavior.sh && \
  ! grep -q "npx tsx" src/domain.roles/behaver/skills/bind.behavior.sh && \
  echo "✓ pass" || echo "✗ fail"
  ```

## task.2.3 = update give.feedback.sh

- [ ] **do**: replace `exec npx tsx -e` with `exec node -e` in `src/domain.roles/behaver/skills/give.feedback.sh`
- **depends on**: task.1.1
- **acceptance**: file contains `node -e` and does not contain `npx tsx`
- **verify**:
  ```bash
  grep -q "node -e" src/domain.roles/behaver/skills/give.feedback.sh && \
  ! grep -q "npx tsx" src/domain.roles/behaver/skills/give.feedback.sh && \
  echo "✓ pass" || echo "✗ fail"
  ```

## task.2.4 = update decompose.behavior.sh

- [ ] **do**: replace `exec npx tsx -e` with `exec node -e` in `src/domain.roles/decomposer/skills/decompose.behavior.sh`
- **depends on**: task.1.1
- **acceptance**: file contains `node -e` and does not contain `npx tsx`
- **verify**:
  ```bash
  grep -q "node -e" src/domain.roles/decomposer/skills/decompose.behavior.sh && \
  ! grep -q "npx tsx" src/domain.roles/decomposer/skills/decompose.behavior.sh && \
  echo "✓ pass" || echo "✗ fail"
  ```


# phase.3 = build and verify

## task.3.1 = build project

- [ ] **do**: run `npm run build`
- **depends on**: task.2.1, task.2.2, task.2.3, task.2.4
- **acceptance**: build completes without error, dist/ contains updated skill files
- **verify**:
  ```bash
  npm run build && \
  grep -q "node -e" dist/domain.roles/behaver/skills/init.behavior.sh && \
  echo "✓ pass" || echo "✗ fail"
  ```

## task.3.2 = verify node dispatch works locally

- [ ] **do**: test that `node -e "import('rhachet-roles-bhuild').then(m => console.log(typeof m.cli))"` outputs `object`
- **depends on**: task.3.1
- **acceptance**: dynamic import resolves package and cli object is accessible
- **verify**:
  ```bash
  node -e "import('rhachet-roles-bhuild').then(m => console.log(typeof m.cli))" | grep -q "object" && echo "✓ pass" || echo "✗ fail"
  ```

## task.3.3 = verify cli entry points accessible

- [ ] **do**: test that all cli entry points are accessible via dynamic import
- **depends on**: task.3.2
- **acceptance**: initBehavior, bindBehavior, giveFeedback, decomposeBehavior all accessible
- **verify**:
  ```bash
  node -e "import('rhachet-roles-bhuild').then(m => console.log(Object.keys(m.cli).join(',')))" | \
  grep -q "initBehavior" && echo "✓ pass" || echo "✗ fail"
  ```


# phase.4 = test coverage

## task.4.1 = run prior unit tests

- [ ] **do**: run `npm run test:unit`
- **depends on**: task.3.1
- **acceptance**: all prior unit tests pass
- **verify**:
  ```bash
  npm run test:unit && echo "✓ pass" || echo "✗ fail"
  ```

## task.4.2 = run prior integration tests

- [ ] **do**: run `npm run test:integration`
- **depends on**: task.3.1
- **acceptance**: all prior integration tests pass
- **verify**:
  ```bash
  npm run test:integration && echo "✓ pass" || echo "✗ fail"
  ```

## task.4.3 = create dispatch integration test

- [ ] **do**: create `src/contract/cli/dispatch.integration.test.ts` per blueprint
- **depends on**: task.3.2
- **acceptance**: test file created, tests pass
- **verify**:
  ```bash
  test -f src/contract/cli/dispatch.integration.test.ts && \
  npm run test:integration -- dispatch.integration.test.ts && \
  echo "✓ pass" || echo "✗ fail"
  ```

## task.4.4 = create portable-dispatch acceptance test

- [ ] **do**: create `src/contract/cli/portable-dispatch.acceptance.test.ts` per blueprint
- **depends on**: task.3.1
- **acceptance**: test file created, tests pass
- **verify**:
  ```bash
  test -f src/contract/cli/portable-dispatch.acceptance.test.ts && \
  npm run test:acceptance:locally -- portable-dispatch.acceptance.test.ts && \
  echo "✓ pass" || echo "✗ fail"
  ```


# phase.5 = end-to-end validation

## task.5.1 = link and init roles

- [ ] **do**: run `npx rhachet roles link --role behaver && npx rhachet roles init --role behaver`
- **depends on**: task.3.1
- **acceptance**: skills symlinked to .agent/ directory
- **verify**:
  ```bash
  test -L .agent/repo=.this/role=behaver/skills/init.behavior.sh && echo "✓ pass" || echo "✗ fail"
  ```

## task.5.2 = test skill invocation via rhachet

- [ ] **do**: invoke a skill via rhachet to verify end-to-end
- **depends on**: task.5.1
- **acceptance**: skill executes without error
- **verify**:
  ```bash
  npx rhachet run --skill bind.behavior get --dir /tmp 2>&1 | grep -v "error" && echo "✓ pass" || echo "✗ fail"
  ```

## task.5.3 = verify no npx in critical path

- [ ] **do**: check that skill execution does not invoke npx tsx
- **depends on**: task.5.2
- **acceptance**: strace/ltrace shows no npx process spawned (or skill works with npx removed from PATH)
- **verify**:
  ```bash
  PATH=$(echo $PATH | tr ':' '\n' | grep -v npm | tr '\n' ':') \
  node -e "import('rhachet-roles-bhuild').then(m => console.log('ok'))" | grep -q "ok" && \
  echo "✓ pass" || echo "✗ fail"
  ```


# phase.6 = documentation

## task.6.1 = update portable-skills-pattern brief

- [ ] **do**: update `.agent/repo=.this/role=any/briefs/portable-skills-pattern.md` to use `node -e` pattern
- **depends on**: task.5.3 (validate pattern works before we document it)
- **acceptance**: brief contains `node -e` pattern, not `npx tsx` pattern
- **verify**:
  ```bash
  grep -q "node -e" .agent/repo=.this/role=any/briefs/portable-skills-pattern.md && \
  ! grep "npx tsx" .agent/repo=.this/role=any/briefs/portable-skills-pattern.md && \
  echo "✓ pass" || echo "✗ fail"
  ```


# phase.7 = final validation

## task.7.1 = run full test suite

- [ ] **do**: run `npm run test`
- **depends on**: task.4.1, task.4.2, task.4.3, task.4.4
- **acceptance**: all tests pass
- **verify**:
  ```bash
  npm run test && echo "✓ pass" || echo "✗ fail"
  ```

## task.7.2 = verify blackbox criteria satisfied

- [ ] **do**: manually verify each criterion in `2.criteria.blackbox.md`
- **depends on**: task.7.1
- **acceptance**: all criteria pass

| criterion | verification |
|-----------|--------------|
| npm install works | `npm install` in fresh consumer repo |
| pnpm install works | `pnpm install` in fresh consumer repo |
| skill executes without npx | PATH excludes npx, skill still works |
| skill produces correct output | compare output to prior version |
| no tsx compilation at runtime | cold start < 100ms |


# dependency graph

```
phase.1 (package config)
  ├── task.1.1 (exports)
  └── task.1.2 (engines)
           │
           ▼
phase.2 (skill updates) ──────────────────┐
  ├── task.2.1 (init.behavior.sh)         │
  ├── task.2.2 (bind.behavior.sh)         │
  ├── task.2.3 (give.feedback.sh)         │
  └── task.2.4 (decompose.behavior.sh)    │
           │                              │
           ▼                              │
phase.3 (build + verify)                  │
  ├── task.3.1 (build)                    │
  ├── task.3.2 (node dispatch)            │
  └── task.3.3 (cli entry points)         │
           │                              │
           ├──────────────────────────────┘
           ▼
phase.4 (test coverage)
  ├── task.4.1 (unit tests)
  ├── task.4.2 (integration tests)
  ├── task.4.3 (dispatch test)
  └── task.4.4 (acceptance test)
           │
           ▼
phase.5 (e2e validation)
  ├── task.5.1 (link roles)
  ├── task.5.2 (skill invocation)
  └── task.5.3 (no npx in path)
           │
           ▼
phase.6 (documentation)
  └── task.6.1 (update brief)
           │
           ▼
phase.7 (final validation)
  ├── task.7.1 (full test suite)
  └── task.7.2 (blackbox criteria)
```


# execution summary

| phase | tasks | scope |
|-------|-------|-------|
| 1. package config | 2 | trivial |
| 2. skill updates | 4 | trivial |
| 3. build + verify | 3 | trivial |
| 4. test coverage | 4 | moderate |
| 5. e2e validation | 3 | trivial |
| 6. documentation | 1 | trivial |
| 7. final validation | 2 | moderate |

**total tasks**: 19
**critical path**: phase.1 → phase.2 → phase.3 → phase.5 → phase.7
