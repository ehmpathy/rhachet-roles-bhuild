# roadmap: review.deliverable skill

## overview

ordered execution plan for implementing the `review.deliverable` skill as specified in `3.3.blueprint.v1.i1.md`.

each phase has:
- dependencies (what must be complete first)
- deliverables (what gets created)
- acceptance criteria (behavioral requirements)
- verification (how to prove it works)


---

## phase.0: scaffold directory structure

### dependencies
- none (first phase)

### deliverables
- [ ] `src/domain.roles/behaver/skills/.test/` directory
- [ ] `src/domain.roles/behaver/skills/.test/assets/` directory
- [ ] `src/domain.roles/behaver/skills/.test/assets/example.repo/` directory

### acceptance criteria
```
given('skills directory exists')
  when('scaffold directories are created')
    then('.test/assets/example.repo/ structure exists')
```

### verification
```sh
ls -la src/domain.roles/behaver/skills/.test/assets/example.repo/
# expect: directory exists
```


---

## phase.1: create test fixtures - valid-behavior

### dependencies
- phase.0 complete

### deliverables
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/0.wish.md`
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/1.vision.md`
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/2.criteria.md`
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/3.3.blueprint.v1.i1.md`
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/3.3.blueprint.v2.i1.md` (for version selection test)
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/4.1.roadmap.v1.i1.md`
- [ ] `.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/.ref.[feedback].v1.[given].by_human.md`
- [ ] `.test/assets/example.repo/valid-behavior/src/domain.operations/getWeatherEmoji/getWeatherEmoji.ts`
- [ ] `.test/assets/example.repo/valid-behavior/src/domain.operations/getWeatherEmoji/getWeatherEmoji.test.ts`

### acceptance criteria
```
given('valid-behavior fixture')
  when('fixture is inspected')
    then('contains .behavior/ with complete declaration files')
    then('contains src/ with deliverable implementation')
    then('has multiple blueprint versions (v1.i1, v2.i1) for version selection test')
    then('deliverable implementation satisfies all criteria (no blockers)')
```

### verification
```sh
ls -la src/domain.roles/behaver/skills/.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/
# expect: all declaration files present

ls -la src/domain.roles/behaver/skills/.test/assets/example.repo/valid-behavior/src/domain.operations/getWeatherEmoji/
# expect: getWeatherEmoji.ts and getWeatherEmoji.test.ts present
```


---

## phase.2: create test fixtures - valid-behavior-with-blocker

### dependencies
- phase.1 complete (can copy and modify)

### deliverables
- [ ] `.test/assets/example.repo/valid-behavior-with-blocker/.behavior/v2025_01_01.get-weather-emoji/*` (same as valid-behavior)
- [ ] `.test/assets/example.repo/valid-behavior-with-blocker/src/domain.operations/getWeatherEmoji/getWeatherEmoji.ts` (with intentional defect)

### acceptance criteria
```
given('valid-behavior-with-blocker fixture')
  when('fixture is inspected')
    then('contains .behavior/ with complete declaration files')
    then('contains src/ with deliverable that violates criteria')
    then('deliverable is missing snowy condition handling per blueprint')
```

### verification
```sh
grep -c "snowy" src/domain.roles/behaver/skills/.test/assets/example.repo/valid-behavior-with-blocker/src/domain.operations/getWeatherEmoji/getWeatherEmoji.ts
# expect: 0 (snowy is missing - intentional defect)

grep -c "snowy" src/domain.roles/behaver/skills/.test/assets/example.repo/valid-behavior/src/domain.operations/getWeatherEmoji/getWeatherEmoji.ts
# expect: 1 (snowy present in valid fixture)
```


---

## phase.3: create test fixtures - missing-criteria and ambiguous-behavior

### dependencies
- phase.0 complete

### deliverables
- [ ] `.test/assets/example.repo/missing-criteria/.behavior/v2025_01_01.foo/0.wish.md` (only wish, no criteria)
- [ ] `.test/assets/example.repo/missing-criteria/src/foo.ts`
- [ ] `.test/assets/example.repo/ambiguous-behavior/.behavior/v2025_01_01.weather/0.wish.md`
- [ ] `.test/assets/example.repo/ambiguous-behavior/.behavior/v2025_01_02.weather/0.wish.md`
- [ ] `.test/assets/example.repo/ambiguous-behavior/src/weather.ts`

### acceptance criteria
```
given('missing-criteria fixture')
  when('fixture is inspected')
    then('contains .behavior/ with only 0.wish.md')
    then('does NOT contain 2.criteria.md')
    then('contains src/ with deliverable')

given('ambiguous-behavior fixture')
  when('fixture is inspected')
    then('contains two behavior directories matching "weather"')
    then('both v2025_01_01.weather and v2025_01_02.weather exist')
```

### verification
```sh
ls src/domain.roles/behaver/skills/.test/assets/example.repo/missing-criteria/.behavior/v2025_01_01.foo/
# expect: only 0.wish.md

ls src/domain.roles/behaver/skills/.test/assets/example.repo/ambiguous-behavior/.behavior/
# expect: v2025_01_01.weather and v2025_01_02.weather
```


---

## phase.4: implement review.deliverable.sh - argument parsing

### dependencies
- phase.0 complete (need directory structure)

### deliverables
- [ ] `src/domain.roles/behaver/skills/review.deliverable.sh` with:
  - header comment block
  - `set -euo pipefail`
  - trap for error reporting
  - argument parsing for `--for.behavior`, `--against`, `--interactive`, `--dir`
  - rhachet passthrough arg handling (`--skill`, `--repo`, `--role`, `-s`)
  - required argument validation

### acceptance criteria
```
given('review.deliverable.sh exists')
  when('invoked without --for.behavior')
    then('fails fast with "error: --for.behavior is required"')
  when('invoked without --against')
    then('fails fast with "error: --against is required"')
  when('invoked with unknown argument')
    then('fails fast with usage guidance')
```

### verification
```sh
bash src/domain.roles/behaver/skills/review.deliverable.sh 2>&1 || true
# expect: "error: --for.behavior is required"

bash src/domain.roles/behaver/skills/review.deliverable.sh --for.behavior test 2>&1 || true
# expect: "error: --against is required"

bash src/domain.roles/behaver/skills/review.deliverable.sh --unknown arg 2>&1 || true
# expect: "error: unknown argument '--unknown'"
```


---

## phase.5: implement review.deliverable.sh - behavior resolution

### dependencies
- phase.4 complete (argument parsing)

### deliverables
- [ ] extend `review.deliverable.sh` with:
  - behavior directory resolution from `--for.behavior`
  - `.behavior/` directory existence check
  - pattern matching for behavior name
  - fail-fast on no match
  - fail-fast on ambiguous match (multiple matches)

### acceptance criteria
```
given('review.deliverable.sh with behavior resolution')
  when('invoked in directory without .behavior/')
    then('fails fast with ".behavior/ directory not found"')
  when('invoked with non-matching behavior name')
    then('fails fast with "no behavior found matching"')
    then('lists available behaviors')
  when('invoked with ambiguous behavior name')
    then('fails fast with "multiple behaviors match"')
    then('lists matching behaviors')
  when('invoked with unique matching behavior name')
    then('resolves behavior directory path')
```

### verification
```sh
# test against fixtures once created
cd src/domain.roles/behaver/skills/.test/assets/example.repo/ambiguous-behavior
bash ../../../../review.deliverable.sh --for.behavior weather --against wish 2>&1 || true
# expect: "error: multiple behaviors match 'weather'"
```


---

## phase.6: implement review.deliverable.sh - declaration file resolution

### dependencies
- phase.5 complete (behavior resolution)

### deliverables
- [ ] extend `review.deliverable.sh` with:
  - `get_target_file()` function mapping target to file pattern
  - version selection for blueprint/roadmap (latest major version)
  - comma-separated target parsing
  - target validation
  - file existence validation

### acceptance criteria
```
given('--against wish')
  when('0.wish.md exists')
    then('resolves to 0.wish.md path')
  when('0.wish.md does not exist')
    then('fails fast with "declaration file not found"')

given('--against blueprint')
  when('multiple versions exist (v1.i1, v2.i1, v3.i2)')
    then('selects v3.i2 (latest major version)')

given('--against wish,vision,criteria')
  when('all targets exist')
    then('resolves all three file paths')
  when('any target missing')
    then('fails fast identifying missing target')
```

### verification
```sh
# manual inspection of version selection logic
# will be fully verified via integration tests in phase.8
```


---

## phase.7: implement review.deliverable.sh - prompt and invocation

### dependencies
- phase.6 complete (declaration file resolution)

### deliverables
- [ ] extend `review.deliverable.sh` with:
  - prompt construction with declaration paths
  - output file path construction (`7.1.review.behavior.per_{targets}.[feedback].v1.[given].by_robot.v1.md`)
  - template file reference
  - claude code invocation (interactive and non-interactive modes)

### acceptance criteria
```
given('all resolution complete')
  when('--interactive flag is set')
    then('invokes claude with --print (interactive shell)')
  when('--interactive flag is not set')
    then('invokes claude with --print --no-input (non-interactive)')
  when('invocation completes')
    then('output file path matches 7.1.review.behavior.per_{targets_slug}.[feedback].v1.[given].by_robot.v1.md')
```

### verification
```sh
# will be verified via integration tests in phase.8
# manual test: run against valid-behavior fixture and confirm output file created
```


---

## phase.8: create integration test suite

### dependencies
- phase.1-3 complete (all fixtures)
- phase.4-7 complete (full skill implementation)

### deliverables
- [ ] `src/domain.roles/behaver/skills/review.deliverable.integration.test.ts` with:
  - `prepareFixtureWithGit()` helper (copies to /tmp, inits git)
  - [case1] valid behavior with complete deliverable
  - [case2] behavior with missing declaration file
  - [case3] ambiguous behavior name
  - [case4] missing required arguments
  - [case5] no .behavior directory
  - [case6] deliverable with intentional blocker

### acceptance criteria
```
given('integration test suite')
  when('npm run test:integration -- review.deliverable')
    then('all test cases pass')
    then('[case1] creates feedback file with review output')
    then('[case2] fails fast with "declaration file not found"')
    then('[case3] fails fast with "multiple behaviors match"')
    then('[case4] fails fast with usage guidance')
    then('[case5] fails fast with ".behavior/ directory not found"')
    then('[case6] feedback file contains blocker')
```

### verification
```sh
npm run test:integration -- review.deliverable.integration.test.ts
# expect: all tests pass
```


---

## phase.9: make script executable and register skill

### dependencies
- phase.8 complete (tests pass)

### deliverables
- [ ] `chmod +x src/domain.roles/behaver/skills/review.deliverable.sh`
- [ ] verify skill is discoverable via rhachet

### acceptance criteria
```
given('review.deliverable.sh is executable')
  when('invoked via rhachet')
    then('npx rhachet run --repo bhuild --skill review.deliverable --for.behavior X --against Y executes')
```

### verification
```sh
ls -la src/domain.roles/behaver/skills/review.deliverable.sh
# expect: -rwxrwxr-x (executable)

# manual test via rhachet if registration is automatic
```


---

## phase.10: end-to-end verification

### dependencies
- phase.9 complete (skill registered)

### deliverables
- [ ] successful review against this behavior's own blueprint

### acceptance criteria
```
given('review.deliverable skill is complete')
  when('run against .behavior/v2025_12_23.review.deliverable/ --against blueprint')
    then('feedback file is created')
    then('no BLOCKERs are reported (skill implementation matches blueprint)')
```

### verification
```sh
npx rhachet run --repo bhuild --skill review.deliverable \
  --for.behavior review.deliverable \
  --against blueprint

cat .behavior/v2025_12_23.review.deliverable/7.1.review.behavior.per_blueprint.[feedback].v1.[given].by_robot.v1.md
# expect: feedback file exists, no blockers
```


---

## execution order summary

```
phase.0 ─────────────────────┐
                             │
phase.1 (valid-behavior) ────┼──┐
                             │  │
phase.2 (with-blocker) ──────┤  │
                             │  │
phase.3 (missing/ambiguous) ─┘  │
                                │
phase.4 (arg parsing) ──────────┤
         │                      │
phase.5 (behavior resolution) ──┤
         │                      │
phase.6 (declaration resolution)│
         │                      │
phase.7 (prompt + invocation) ──┘
         │
phase.8 (integration tests) ────┐
         │                      │
phase.9 (executable + register) ┤
         │                      │
phase.10 (e2e verification) ────┘
```

parallel tracks:
- fixtures (phase.1-3) can proceed in parallel
- skill implementation (phase.4-7) can proceed in parallel with fixtures
- phase.8+ requires both tracks complete
