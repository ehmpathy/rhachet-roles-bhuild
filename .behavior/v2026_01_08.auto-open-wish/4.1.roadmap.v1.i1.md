# roadmap: auto-open-wish

## execution order

```
phase 1: pure domain operations (parallel)
  â”œâ”€ step 1.1: computeOutputTree + tests
  â””â”€ step 1.2: computeFooterOutput + tests

phase 2: infra operations (sequential)
  â”œâ”€ step 2.1: OpenerUnavailableError
  â””â”€ step 2.2: openFileWithOpener + tests (depends on 2.1)

phase 3: orchestrator integration
  â””â”€ step 3.1: modify init.behavior.ts (depends on 1.1, 1.2, 2.2)

phase 4: acceptance verification
  â””â”€ step 4.1: acceptance tests (depends on 3.1)

phase 5: manual verification
  â””â”€ step 5.1: run init.behavior manually (depends on 4.1)
```

---

## phase 1: pure domain operations

### step 1.1: computeOutputTree

- [ ] create `src/domain.operations/behavior/init/computeOutputTree.ts`
- [ ] create `src/domain.operations/behavior/init/computeOutputTree.test.ts`
- [ ] run unit tests

**acceptance criteria:**
```
given('computeOutputTree')
  when('all files created')
    then('header is "ðŸ¦« oh, behave!"')
    then('all lines show "+" prefix')
    then('tree uses â”œâ”€ for non-last, â””â”€ for last')
  when('all files kept')
    then('all lines show "âœ“" prefix')
  when('mixed created and kept')
    then('correct symbol per file')
    then('files sorted alphabetically')
  when('empty input')
    then('returns header only')
```

**verify:**
```sh
npm run test:unit -- computeOutputTree.test.ts
```

---

### step 1.2: computeFooterOutput

- [ ] create `src/domain.operations/behavior/render/` directory
- [ ] create `src/domain.operations/behavior/render/computeFooterOutput.ts`
- [ ] create `src/domain.operations/behavior/render/computeFooterOutput.test.ts`
- [ ] run unit tests

**acceptance criteria:**
```
given('computeFooterOutput')
  when('wishPathRel is ".behavior/v2026_01_08.test/0.wish.md"')
    then('output line 1 is "ðŸŒ² go on then,"')
    then('output line 2 is "   â””â”€ .behavior/v2026_01_08.test/0.wish.md"')
  when('path has special chars')
    then('path preserved exactly')
```

**verify:**
```sh
npm run test:unit -- computeFooterOutput.test.ts
```

---

## phase 2: infra operations

### step 2.1: OpenerUnavailableError

- [ ] create `src/infra/shell/` directory (if absent)
- [ ] create `src/infra/shell/OpenerUnavailableError.ts`

**acceptance criteria:**
```
given('OpenerUnavailableError')
  then('extends HelpfulError')
  then('uses default constructor')
  then('instanceof check works')
```

**verify:**
```sh
npm run test:types
```

---

### step 2.2: openFileWithOpener

**depends on:** step 2.1

- [ ] create `src/infra/shell/openFileWithOpener.ts`
- [ ] create `src/infra/shell/openFileWithOpener.integration.test.ts`
- [ ] run integration tests

**acceptance criteria:**
```
given('openFileWithOpener')
  when('opener is "echo"')
    then('completes without error')
  when('opener is "nonexistent-cmd-xyz"')
    then('throws OpenerUnavailableError')
    then('error.cause contains shell error')
  when('filePath has spaces')
    then('command executes correctly')
```

**verify:**
```sh
npm run test:integration -- openFileWithOpener.integration.test.ts
```

---

## phase 3: orchestrator integration

### step 3.1: modify init.behavior.ts

**depends on:** steps 1.1, 1.2, 2.2

- [ ] add `open: z.string().optional()` to schema
- [ ] import `computeOutputTree` from domain.operations
- [ ] import `computeFooterOutput` from domain.operations
- [ ] import `openFileWithOpener` from infra/shell
- [ ] import `OpenerUnavailableError` from infra/shell
- [ ] replace file list console.log loop with `computeOutputTree()` call
- [ ] compute `wishPathRel = ${behaviorDirRel}/0.wish.md`
- [ ] replace success message with `computeFooterOutput()` call
- [ ] add opener execution block:
  - [ ] check if `named.open` is provided
  - [ ] try `openFileWithOpener({ opener: named.open, filePath: wishPathRel })`
  - [ ] catch `OpenerUnavailableError` specifically
  - [ ] warn user on catch (do not exit with error)
  - [ ] rethrow unexpected errors

**acceptance criteria:**
```
given('init.behavior orchestrator')
  when('--open not provided')
    then('output uses tree format with symbols')
    then('footer shows relative wish path')
    then('no opener executed')
  when('--open echo provided')
    then('output uses tree format')
    then('echo command executed with wish path')
  when('--open nonexistent provided')
    then('behavior files created')
    then('warn shown for opener failure')
    then('exit code is 0')
```

**verify:**
```sh
npm run test:types
npm run build
```

---

## phase 4: acceptance verification

### step 4.1: acceptance tests

**depends on:** step 3.1

- [ ] create `src/contract/cli/init.behavior.acceptance.test.ts`
- [ ] run acceptance tests

**acceptance criteria:**
```
given('[case1] fresh behavior init')
  when('[t0] init.behavior executed')
    then('output contains "ðŸ¦« oh, behave!"')
    then('all files show "+" (created)')
    then('output contains "ðŸŒ² go on then,"')
    then('relative wish path shown')

given('[case2] rerun (idempotent)')
  when('[t0] init.behavior executed again')
    then('all files show "âœ“" (kept)')

given('[case3] with --open echo')
  when('[t0] init.behavior --open echo executed')
    then('echo command invoked')
    then('wish path passed to echo')

given('[case4] with --open nonexistent')
  when('[t0] init.behavior --open nonexistent-xyz executed')
    then('behavior files created')
    then('warn contains "opener" and "unavailable"')
    then('process exits with code 0')
```

**verify:**
```sh
npm run test:acceptance -- init.behavior.acceptance.test.ts
```

---

## phase 5: manual verification

### step 5.1: manual smoke test

**depends on:** step 4.1

- [ ] create fresh git branch
- [ ] run `npx rhachet run --skill init.behavior --name test-smoke`
- [ ] verify output matches expected format

**acceptance criteria:**
```
output should look like:
ðŸ¦« oh, behave!
   â”œâ”€ + .ref.[feedback].v1.[given].by_human.md
   â”œâ”€ + 0.wish.md
   â”œâ”€ + 1.vision.md
   ...
   â””â”€ + 5.1.execution.phase0_to_phaseN.v1.src

ðŸŒ² go on then,
   â””â”€ .behavior/v2026_01_08.test-smoke/0.wish.md
```

- [ ] run with `--open cat` to verify opener works
- [ ] run with `--open nonexistent-xyz` to verify warn behavior
- [ ] cleanup test branch

**verify:**
```sh
# manual visual inspection
npx rhachet run --skill init.behavior --name test-smoke
npx rhachet run --skill init.behavior --name test-smoke --open cat
npx rhachet run --skill init.behavior --name test-smoke --open nonexistent-xyz
```

---

## summary checklist

```
[ ] phase 1.1: computeOutputTree + tests
[ ] phase 1.2: computeFooterOutput + tests
[ ] phase 2.1: OpenerUnavailableError
[ ] phase 2.2: openFileWithOpener + tests
[ ] phase 3.1: init.behavior.ts orchestrator
[ ] phase 4.1: acceptance tests
[ ] phase 5.1: manual smoke test
[ ] all tests pass: npm run test
[ ] build passes: npm run build
```

---

## rollback plan

if issues found after integration:
1. revert init.behavior.ts to prior version
2. keep new domain operations (they're additive, not destructive)
3. debug in isolation via unit/integration tests
4. re-integrate once fixed
