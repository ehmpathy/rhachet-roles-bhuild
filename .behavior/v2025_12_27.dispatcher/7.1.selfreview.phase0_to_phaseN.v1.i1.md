# self-review: dispatcher role implementation v1

this document compares the implementation (git diff) against the blackbox criteria in `2.criteria.blackbox.md`.

---

## legend

- **BLOCKER** = missing or incorrect functionality that prevents feature from working as specified
- **NITPICK** = minor deviation that doesn't affect core functionality

---

## BLOCKERs

### B1: prioritization.md table format missing columns

**criteria (2.criteria.blackbox.md:153-158)**:
```markdown
| behavior | repo | priority | gain(+$) | cost(-$) | effect(~$) | readiness | bandwidth |
```

**implementation (renderBehaviorTriagedPrioritizationMd.ts:84-85)**:
```typescript
lines.push('| priority | behavior | effect | readiness | bandwidth |');
```

**gap**: missing columns:
- `repo` column
- `gain(+$)` column
- `cost(-$)` column

**impact**: user cannot see full gain/cost breakdown or which repo behavior belongs to

---

### B2: prioritization.json missing gain/cost/effect data

**criteria (2.criteria.blackbox.md:107-109)**:
- prioritization.json should include full measurement data

**implementation (getAllBehaviorPrioritized.ts:69-79)**:
```typescript
triagedBasket.map((t) => ({
  behavior: t.gathered.behavior.name,
  priority: t.priority,
  decision: t.decision,
  readiness: t.dimensions.readiness,
  bandwidth: t.dimensions.bandwidth,
}))
```

**gap**: missing fields:
- `repo`
- `gain` (gain(+$))
- `cost` (cost(-$))
- `effect` (effect(~$))

**impact**: downstream tools cannot access measurement data from json output

---

### B3: CLI output format does not match blackbox spec

**criteria (2.criteria.blackbox.md:386-420)**:
```
ğŸ¦« lets prioritize!
â”‚
â”œâ”€ ğŸŒ² gather behaviors
â”‚  â”œâ”€ âœ“ done in 1.2s
â”‚  â”œâ”€ 3 repos scanned
â”‚  â”œâ”€ 12 behaviors found
â”‚  â””â”€ 12 behaviors changed
â”‚     â”œâ”€ + v2025_01_01.auth-flow
```

**implementation (getAllBehaviorPrioritized.ts CLI)**:
```
ğŸ¦« prioritize
â”œâ”€ ğŸ”­ gathering behaviors...
â”œâ”€ ğŸŒ² gathered 12 behaviors
```

**gap**:
- no timing information (`done in X.Xs`)
- no cache stats (`N new, M cached`)
- no change indicators (`+` = created, `~` = updated)
- no repo count

**impact**: user cannot assess performance or understand what changed

---

### B4: remote sources not implemented

**criteria (2.criteria.blackbox.md:40-44)**:
```yaml
remote:
  repos:
    - url: github.com/myorg/myrepo
      pr_labels: [behavior]
      issue_labels: [behavior.wish]
```

**implementation (getAllBehaviorGathered.ts)**:
- only handles local sources via `enumBehaviorDirs`
- no remote source enumeration
- no PR/issue fetching

**impact**: multi-repo coordination across github not supported

---

### B5: coordination.md missing bottleneck section

**criteria (2.criteria.blackbox.md:245-254)**:
```markdown
## bottlenecks

- rank 2 blocked on rank 1 at step 2 (cache-layer depends on auth-flow)

## review order

if multiple workstreams blocked on human review, review in rank order:
```

**implementation (renderBehaviorWorkstreamCoordinationMd.ts)**:
- has workstream sections
- has execution order section
- missing: bottleneck detection/display
- missing: review order guidance section

**impact**: user cannot quickly identify cross-workstream blockers

---

### B6: individual skill invocations not wired to rhachet runner

**criteria (2.criteria.blackbox.md:314-326)**:
```bash
npx rhachet run --repo bhuild --skill gather
npx rhachet run --repo bhuild --skill deptrace
```

**implementation**:
- shell wrappers exist (`gather.sh`, `prioritize.sh`, `coordinate.sh`)
- they call `npx tsx ./src/contract/cli/...` directly
- not integrated with `npx rhachet run` command

**impact**: skills not invocable via standard rhachet CLI pattern

---

### B7: config criteria.gain.leverage.weights not used

**criteria (2.criteria.blackbox.md:51-53)**:
```yaml
leverage:
  weights:
    author: 0.5
    support: 0.5
```

**implementation (computeBehaviorMeasuredGainLeverage.ts)**:
- uses hardcoded complexity scoring
- does not read weights from config

**impact**: user cannot customize leverage calculation

---

## NITPICKs

### N1: different emojis in CLI output

**criteria**: uses ğŸŒ² consistently for all stages

**implementation**: mixes ğŸ”­ (gather), ğŸŒ² (gathered), ğŸ•ï¸ (triage), ğŸŒŠ (output)

**note**: current emoji scheme is descriptive; may prefer consistency

---

### N2: readme.md content abbreviated

**criteria (2.criteria.blackbox.md:115-144)**: detailed readme with cache behavior, archive behavior sections

**implementation (findsertBehaviorDispatchDir.ts:33-56)**: condensed version, less detail

**note**: functional but less explanatory

---

### N3: prioritization.md header differs

**criteria**: `# prioritization`

**implementation**: `# behavior prioritization`

**note**: minor naming difference

---

### N4: coordination.md format differs from blackbox

**criteria (2.criteria.blackbox.md:222-255)**:
```markdown
## rank 1: auth foundation
priority: p0 (critical)

1. [now] v2025_01_01.auth-flow (myorg/api)
2. [blocked by #1] v2025_01_01.session-mgmt (myorg/api)
```

**implementation**:
```markdown
### 1: auth-flow-workstream
- **priority**: ğŸ”´ p0
| decision | priority | behavior |
```

**note**: uses table format instead of numbered list with blockage indicators

---

### N5: dollar formatting differs

**criteria**: `+$6,360`, `-$1,813`, `~$4,547` with explicit +/- signs

**implementation**: `$6k`, `$2k` without +/- signs

**note**: less explicit direction indication

---

### N6: missing gathered.md output

**criteria (2.criteria.blackbox.md:52-55)**: readme mentions `gathered.md`

**implementation**: no gathered.md file produced

**note**: readme references it but file not created

---

## summary

| category | count | severity |
|----------|-------|----------|
| BLOCKER  | 7     | must fix for compliance |
| NITPICK  | 6     | nice to have |

### priority order for fixes

1. **B1, B2** - add missing columns to prioritization outputs
2. **B3** - enhance CLI output with timing and cache stats
3. **B5** - add bottleneck detection to coordination.md
4. **B4** - implement remote source support (larger scope)
5. **B6** - integrate with rhachet run command
6. **B7** - use config weights for leverage calculation

---

## fixes applied (2025-12-29)

### completed

- **B1**: added repo, gain(+$), cost(-$), effect(~$) columns to prioritization.md table
- **B2**: added repo, gain, cost, effect fields to prioritization.json output
- **B3**: rewrote CLI output with tree format, timing, and cache stats
- **B5**: added bottleneck section and review order section to coordination.md
- **B7**: updated config to use criteria.gain.leverage.weights and criteria.convert.equate
- **N2**: updated readme.md content to match blackbox spec
- **N3**: changed header from "# behavior prioritization" to "# prioritization"
- **N4**: changed coordination.md workstreams to use numbered list format
- **N5**: added +/- signs to dollar formatting (+$6,360 format)
- **N6**: removed gathered.md reference from readme (not produced)

### deferred (larger scope)

- **B4**: remote source support (requires github api integration)
- **B6**: rhachet run integration (requires rhachet framework changes)

---

*reviewed at 2025-12-29*
*fixes applied at 2025-12-29*
