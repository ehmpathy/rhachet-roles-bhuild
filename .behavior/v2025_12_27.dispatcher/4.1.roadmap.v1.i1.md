# implementation roadmap: dispatcher role v1

this document declares the ordered execution roadmap for implementing the dispatcher role, with behavioral acceptance criteria and verification at each step.

---

## dependencies

```
phase.0 (brief research)
    â”‚
    â””â”€â†’ phase.1 (foundation)
            â”‚
            â”œâ”€â†’ phase.2 (gather)
            â”‚       â”‚
            â”‚       â””â”€â†’ phase.3 (deptrace)
            â”‚               â”‚
            â”‚               â””â”€â†’ phase.4 (measure)
            â”‚                       â”‚
            â”‚                       â””â”€â†’ phase.5 (triage)
            â”‚                               â”‚
            â”‚                               â”œâ”€â†’ phase.6 (prioritize)
            â”‚                               â”‚
            â”‚                               â””â”€â†’ phase.7 (coordinate)
            â”‚
            â””â”€â†’ phase.8 (role + skills)
```

---

## phase.0: brief research

**goal**: research knowledge domains and create briefs per scope.2 criteria

**depends on**: nothing

### checklist

- [ ] **0.1** identify knowledge domains relevant to dispatcher skills
  - [ ] prioritization concepts (leverage, yieldage, cost, effect, priority levels)
  - [ ] coordination concepts (workstreams, ranking, urgency levels)
  - [ ] caching concepts (content hash, cache invalidation)

- [ ] **0.2** research best practices with citations
  - [ ] leverage measurement (time savings multipliers)
    - [ ] minimum 3 citations from industry sources (SAFe, WSJF, RICE)
  - [ ] yieldage measurement (probabilistic value realization)
    - [ ] minimum 3 citations
  - [ ] cost estimation patterns (attend: time, expend: cash)
    - [ ] minimum 3 citations

- [ ] **0.3** create brief files with format tags
  - [ ] format tag assigned based on content type per usecase.2.3
    - [ ] [article] = curated external knowledge with citations
    - [ ] [catalog] = enumerated options or patterns
    - [ ] [demo] = worked examples
    - [ ] [lesson] = distilled learnings
    - [ ] [seed] = original definitions for this domain
  - [ ] briefs placed under `src/domain.roles/dispatcher/briefs/practices/`

### acceptance criteria

```
given('phase.0 is complete')
  when('briefs directory is examined')
    then('at least one brief exists for leverage measurement')
      sothat('leverage scoring has knowledge foundation')
    then('at least one brief exists for yieldage measurement')
      sothat('yieldage scoring has knowledge foundation')
    then('all briefs include citations per usecase.2.2')
      sothat('claims are grounded in evidence')
```

### verification

```bash
# verify briefs exist
ls -la src/domain.roles/dispatcher/briefs/practices/behavior.prioritization/
ls -la src/domain.roles/dispatcher/briefs/practices/behavior.coordination/

# verify citations present (grep for common citation patterns)
grep -r "http" src/domain.roles/dispatcher/briefs/ | head -10
```

---

## phase.1: foundation

**goal**: create directory structure, domain objects, and context types

**depends on**: phase.0 (brief research)

### checklist

- [ ] **1.1** create directory structure
  - [ ] `src/domain.roles/dispatcher/` directory
  - [ ] `src/domain.roles/dispatcher/skills/` directory
  - [ ] `src/domain.roles/dispatcher/briefs/` directory (from phase.0)
  - [ ] `src/domain.objects/` additions
  - [ ] `src/domain.operations/behavior/dispatch/` directory tree

- [ ] **1.2** implement root entity: Behavior
  - [ ] file: `src/domain.objects/Behavior.ts`
  - [ ] interface with org, repo, name
  - [ ] class extends DomainEntity
  - [ ] unique = ['org', 'repo', 'name']

- [ ] **1.3** implement entity: BehaviorGathered
  - [ ] file: `src/domain.objects/BehaviorGathered.ts`
  - [ ] interface with gatheredAt, behavior, contentHash, status, files, wish, vision, criteria
  - [ ] unique = ['behavior', 'contentHash']
  - [ ] uses RefByUnique<typeof Behavior>

- [ ] **1.4** implement entity: BehaviorDeptraced
  - [ ] file: `src/domain.objects/BehaviorDeptraced.ts`
  - [ ] interface with deptracedAt, gathered, dependsOnDirect, dependsOnTransitive
  - [ ] unique = ['gathered']

- [ ] **1.5** implement entity: BehaviorMeasured
  - [ ] file: `src/domain.objects/BehaviorMeasured.ts`
  - [ ] interface with measuredAt, gathered, gain, cost, effect, priority
  - [ ] unique = ['gathered']

- [ ] **1.6** implement entity: BehaviorTriaged
  - [ ] file: `src/domain.objects/BehaviorTriaged.ts`
  - [ ] interface with triagedAt, gathered, dimensions, decision, priority
  - [ ] unique = ['gathered']

- [ ] **1.7** implement entity: BehaviorWorkstream
  - [ ] file: `src/domain.objects/BehaviorWorkstream.ts`
  - [ ] interface with slug, name, rank, priority, deliverables
  - [ ] unique = ['slug']
  - [ ] type BehaviorWorkstreamRank = `r${number}`

- [ ] **1.8** implement literals
  - [ ] BehaviorMeasuredGain (dimensions + composite)
  - [ ] BehaviorMeasuredCost (dimensions + composite)
  - [ ] BehaviorMeasuredGainLeverage (direct + transitive)
  - [ ] BehaviorMeasuredGainYieldage (direct.chances, direct.expected, transitive)
  - [ ] BehaviorMeasuredGainYieldageChance (yieldage, probability)
  - [ ] BehaviorMeasuredCostAttend (hours, complexity, composite)
  - [ ] BehaviorMeasuredCostExpend (direct, indirect, composite)
  - [ ] BehaviorWorkstreamDeliverable (triaged, position, urgency, blockedBy)

- [ ] **1.9** implement config literal: BehaviorDispatchConfig
  - [ ] file: `src/domain.objects/BehaviorDispatchConfig.ts`
  - [ ] output, sources (local + remote), criteria, constraints
  - [ ] @example comments per blocker.16

- [ ] **1.10** implement context type: BehaviorDispatchContext
  - [ ] config, cacheDir, brain, log
  - [ ] cacheDir structure: { mounted: { path: string } }

- [ ] **1.11** implement enum types (as string literals)
  - [ ] BehaviorGatheredStatus
  - [ ] BehaviorMeasuredPriorityLevel
  - [ ] BehaviorTriagedUrgencyLevel

### acceptance criteria

```
given('phase.1 is complete')
  when('npm run test:types is executed')
    then('all domain object types compile without errors')
      sothat('type system validates our domain model')
  when('domain objects are instantiated')
    then('all required fields are enforced by types')
      sothat('domain objects are type-safe')
```

### verification

```bash
# type check passes
npm run test:types

# unit tests pass (domain object instantiation + validation)
npm run test:unit -- Behavior
npm run test:unit -- BehaviorGathered
npm run test:unit -- BehaviorDispatchConfig
```

---

## phase.2: gather skill

**goal**: implement behavior collection from local sources

**depends on**: phase.1 (foundation)

### checklist

- [ ] **2.1** implement computeBehaviorGatheredContentHash
  - [ ] file: `src/domain.operations/behavior/dispatch/gather/computeBehaviorGatheredContentHash.ts`
  - [ ] unit test: `computeBehaviorGatheredContentHash.test.ts`
  - [ ] tests: determinism, content change detection, file ordering

- [ ] **2.2** implement enumBehaviorDirs
  - [ ] file: `src/domain.operations/behavior/dispatch/gather/enumBehaviorDirs.ts`
  - [ ] unit test: `enumBehaviorDirs.test.ts`
  - [ ] tests: finds .behavior/*/ directories, ignores non-behavior dirs

- [ ] **2.3** implement parseBehaviorDir
  - [ ] file: `src/domain.operations/behavior/dispatch/gather/parseBehaviorDir.ts`
  - [ ] unit test: `parseBehaviorDir.test.ts`
  - [ ] tests: parses wish/vision/criteria, handles missing files

- [ ] **2.4** implement loadBehaviorDispatchConfig
  - [ ] file: `src/domain.operations/behavior/dispatch/gather/loadBehaviorDispatchConfig.ts`
  - [ ] unit test: `loadBehaviorDispatchConfig.test.ts`
  - [ ] tests: valid YAML, invalid YAML, missing file

- [ ] **2.5** implement getOneBehaviorGathered (cache-critical)
  - [ ] file: `src/domain.operations/behavior/dispatch/gather/getOneBehaviorGathered.ts`
  - [ ] private/public pattern: `_getOneBehaviorGathered` + wrapped export
  - [ ] unit test: `getOneBehaviorGathered.test.ts`
  - [ ] tests: cache hit, cache miss, stale contentHash failfast

- [ ] **2.6** implement getAllBehaviorGathered
  - [ ] file: `src/domain.operations/behavior/dispatch/gather/getAllBehaviorGathered.ts`
  - [ ] polymorphic: by.sources, by.local, by.remote
  - [ ] integration test: `getAllBehaviorGathered.integration.test.ts`
  - [ ] tests: local repo scanning, file copying, contentHash computation

- [ ] **2.7** implement findsertBehaviorDispatchDir
  - [ ] file: `src/domain.operations/behavior/dispatch/findsertBehaviorDispatchDir.ts`
  - [ ] unit test: `findsertBehaviorDispatchDir.test.ts`
  - [ ] tests: creates if missing, idempotent if exists

- [ ] **2.8** implement genBehaviorDispatchContext
  - [ ] file: `src/domain.operations/behavior/dispatch/genBehaviorDispatchContext.ts`
  - [ ] unit test: `genBehaviorDispatchContext.test.ts`
  - [ ] tests: generates context with cacheDir

- [ ] **2.9** implement gather contract.cli
  - [ ] file: `src/contract/cli/getAllBehaviorGathered.ts`
  - [ ] acceptance test: `getAllBehaviorGathered.acceptance.test.ts`
  - [ ] tests: valid config, missing config, empty sources

### acceptance criteria

```
given('phase.2 is complete')
  when('gather skill is invoked on a repo with .behavior/ directories')
    then('behaviors are copied to {output}/.gathered/{org}/{repo}/{name}/')
      sothat('behaviors are organized by source origin')
    then('.gathered.json is created for each behavior')
      sothat('provenance is tracked')
    then('contentHash is computed and stored')
      sothat('downstream skills can detect changes')
  when('gather skill is invoked again with unchanged sources')
    then('output is identical')
      sothat('gather is idempotent (scope.9 usecase.9.7)')
```

### verification

```bash
# unit tests pass
npm run test:unit -- gather

# integration tests pass
npm run test:integration -- getAllBehaviorGathered

# acceptance tests pass
npm run test:acceptance -- getAllBehaviorGathered
```

---

## phase.3: deptrace skill

**goal**: implement dependency tracing with failfast on missing deps

**depends on**: phase.2 (gather)

### checklist

- [ ] **3.1** implement parseBehaviorDeptracedDependencies
  - [ ] file: `src/domain.operations/behavior/dispatch/deptrace/parseBehaviorDeptracedDependencies.ts`
  - [ ] unit test: `parseBehaviorDeptracedDependencies.test.ts`
  - [ ] tests: no deps, single dep, multiple deps, malformed input

- [ ] **3.2** implement computeBehaviorDeptracedTransitiveDeps
  - [ ] file: `src/domain.operations/behavior/dispatch/deptrace/computeBehaviorDeptracedTransitiveDeps.ts`
  - [ ] unit test: `computeBehaviorDeptracedTransitiveDeps.test.ts`
  - [ ] tests: linear chain, diamond deps, no deps, circular deps

- [ ] **3.3** implement getOneBehaviorDeptraced (cache-critical)
  - [ ] file: `src/domain.operations/behavior/dispatch/deptrace/getOneBehaviorDeptraced.ts`
  - [ ] private/public pattern: `_getOneBehaviorDeptraced` + wrapped export
  - [ ] uses .gathered/latest/ for dependency resolution
  - [ ] failfast if dependency not found (blocker.37)
  - [ ] integration test: `getOneBehaviorDeptraced.integration.test.ts`
  - [ ] **critical test**: missing dependency scenario (blocker.37)
    - [ ] test verifies failfast occurs
    - [ ] test verifies error message includes missing behavior name
    - [ ] test verifies error message includes dependent behavior name

- [ ] **3.4** implement renderBehaviorDeptracedDependenciesMd
  - [ ] file: `src/domain.operations/behavior/dispatch/deptrace/renderBehaviorDeptracedDependenciesMd.ts`
  - [ ] unit test: `renderBehaviorDeptracedDependenciesMd.test.ts`
  - [ ] tests: output format, empty deps, nested deps

### acceptance criteria

```
given('phase.3 is complete')
  when('deptrace is computed for a behavior with dependencies')
    then('dependsOnDirect contains direct blockers')
      sothat('immediate blockers are known')
    then('dependsOnTransitive contains full closure')
      sothat('all upstream blockers are visible')
  when('deptrace references a behavior not in .gathered/latest/')
    then('operation fails fast with clear error message (blocker.37)')
      sothat('missing dependencies are caught immediately')
    then('error includes missing behavior name AND dependent behavior name')
      sothat('user knows what is missing and why it matters')
  when('deptrace is invoked on unchanged behavior')
    then('cached result is returned')
      sothat('cache invalidation via contentHash works')
```

### verification

```bash
# unit tests pass
npm run test:unit -- deptrace

# integration tests pass (including blocker.37 scenario)
npm run test:integration -- getOneBehaviorDeptraced

# verify blocker.37 test exists and passes
grep -l "dependency not found" src/domain.operations/behavior/dispatch/deptrace/*.test.ts
npm run test:integration -- "missing dependency"
```

---

## phase.4: measure skill

**goal**: implement gain/cost scoring with transitive impact

**depends on**: phase.3 (deptrace)

### checklist

- [ ] **4.1** implement computeBehaviorMeasuredGainLeverage
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredGainLeverage.ts`
  - [ ] unit test: `computeBehaviorMeasuredGainLeverage.test.ts`
  - [ ] tests: direct leverage, transitive leverage, zero leverage

- [ ] **4.2** implement computeBehaviorMeasuredGainYieldage
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredGainYieldage.ts`
  - [ ] unit test: `computeBehaviorMeasuredGainYieldage.test.ts`
  - [ ] tests: deterministic yield, probabilistic yield, zero yield

- [ ] **4.3** implement computeBehaviorMeasuredGainComposite
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredGainComposite.ts`
  - [ ] unit test: `computeBehaviorMeasuredGainComposite.test.ts`
  - [ ] tests: time-to-cash conversion, sum of dimensions

- [ ] **4.4** implement computeBehaviorMeasuredCostAttend
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredCostAttend.ts`
  - [ ] unit test: `computeBehaviorMeasuredCostAttend.test.ts`
  - [ ] tests: hours * complexity formula

- [ ] **4.5** implement computeBehaviorMeasuredCostExpend
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredCostExpend.ts`
  - [ ] unit test: `computeBehaviorMeasuredCostExpend.test.ts`
  - [ ] tests: direct + indirect formula

- [ ] **4.6** implement computeBehaviorMeasuredCostComposite
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredCostComposite.ts`
  - [ ] unit test: `computeBehaviorMeasuredCostComposite.test.ts`
  - [ ] tests: time-to-cash conversion, sum of dimensions

- [ ] **4.7** implement computeBehaviorMeasuredReverseDeps
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/computeBehaviorMeasuredReverseDeps.ts`
  - [ ] unit test: `computeBehaviorMeasuredReverseDeps.test.ts`
  - [ ] tests: graph inversion, no deps, all deps

- [ ] **4.8** implement assignBehaviorMeasuredPriority
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/assignBehaviorMeasuredPriority.ts`
  - [ ] unit test: `assignBehaviorMeasuredPriority.test.ts`
  - [ ] tests: p0/p1/p3/p5 thresholds

- [ ] **4.9** implement getOneBehaviorMeasured (cache-critical)
  - [ ] file: `src/domain.operations/behavior/dispatch/measure/getOneBehaviorMeasured.ts`
  - [ ] private/public pattern: `_getOneBehaviorMeasured` + wrapped export
  - [ ] integration test: `getOneBehaviorMeasured.integration.test.ts`
  - [ ] tests: full measurement pipeline, cache interaction

### acceptance criteria

```
given('phase.4 is complete')
  when('measure is computed for a behavior')
    then('gain.composite = leverage + yieldage in $$')
      sothat('time and cash gains are combined (scope.1 usecase.1.1)')
    then('cost.composite = attend + expend in $$')
      sothat('time and cash costs are combined (scope.1 usecase.1.1)')
    then('effect = gain.composite - cost.composite')
      sothat('net value is comparable across behaviors')
    then('priority is assigned (p0/p1/p3/p5)')
      sothat('absolute priority label exists')
  when('behavior unblocks other behaviors')
    then('gain includes transitive leverage + yieldage')
      sothat('blocker impact is captured (wish: "which unblocks the most?")')
```

### verification

```bash
# unit tests pass for all compute functions
npm run test:unit -- measure

# integration tests pass
npm run test:integration -- getOneBehaviorMeasured

# verify transitive impact is included
grep -l "transitive" src/domain.operations/behavior/dispatch/measure/*.ts
```

---

## phase.5: triage skill

**goal**: implement urgency assignment (now/soon/later)

**depends on**: phase.4 (measure)

### checklist

- [ ] **5.1** implement computeBehaviorTriagedReadiness
  - [ ] file: `src/domain.operations/behavior/dispatch/triage/computeBehaviorTriagedReadiness.ts`
  - [ ] unit test: `computeBehaviorTriagedReadiness.test.ts`
  - [ ] tests: unblocked=now, 1-hop=soon, 2+-hop=later, paused=later

- [ ] **5.2** implement computeBehaviorTriagedBandwidth
  - [ ] file: `src/domain.operations/behavior/dispatch/triage/computeBehaviorTriagedBandwidth.ts`
  - [ ] unit test: `computeBehaviorTriagedBandwidth.test.ts`
  - [ ] tests: capacity limits, overflow behavior

- [ ] **5.3** implement getAllBehaviorTriaged (cache-critical)
  - [ ] file: `src/domain.operations/behavior/dispatch/triage/getAllBehaviorTriaged.ts`
  - [ ] private/public pattern: `_getAllBehaviorTriaged` + wrapped export
  - [ ] integration test: `getAllBehaviorTriaged.integration.test.ts`
  - [ ] tests: collective triage, sorting, bandwidth limits

- [ ] **5.4** implement renderBehaviorTriagedPrioritizationMd
  - [ ] file: `src/domain.operations/behavior/dispatch/triage/renderBehaviorTriagedPrioritizationMd.ts`
  - [ ] unit test: `renderBehaviorTriagedPrioritizationMd.test.ts`
  - [ ] tests: output format, grouping by urgency

### acceptance criteria

```
given('phase.5 is complete')
  when('triage is computed for behaviors')
    then('dimensions.readiness reflects dependency status')
      sothat('blocked behaviors are deferred (scope.6 usecase.6.3)')
    then('dimensions.bandwidth reflects concurrency constraints')
      sothat('capacity is respected (scope.6 usecase.6.4)')
    then('decision = min(readiness, bandwidth)')
      sothat('lowest dimension wins')
  when('triage runs with unchanged inputs')
    then('output is identical')
      sothat('triage is deterministic and idempotent (scope.6 usecase.6.6)')
```

### verification

```bash
# unit tests pass
npm run test:unit -- triage

# integration tests pass
npm run test:integration -- getAllBehaviorTriaged

# verify determinism (no brain.repl)
grep -L "brain.repl" src/domain.operations/behavior/dispatch/triage/*.ts
```

---

## phase.6: prioritize composite skill

**goal**: implement gather â†’ deptrace â†’ measure â†’ triage pipeline

**depends on**: phase.5 (triage)

### checklist

- [ ] **6.1** implement archiveBehaviorIfChanged
  - [ ] file: `src/domain.operations/behavior/dispatch/archiveBehaviorIfChanged.ts`
  - [ ] unit test: `archiveBehaviorIfChanged.test.ts`
  - [ ] tests: archives on change, skips if unchanged

- [ ] **6.2** implement getAllBehaviorPrioritized (cache-critical)
  - [ ] file: `src/domain.operations/behavior/dispatch/prioritize/getAllBehaviorPrioritized.ts`
  - [ ] private/public pattern: `_getAllBehaviorPrioritized` + wrapped export
  - [ ] composes: triage â†’ render outputs
  - [ ] writes: prioritization.md, prioritization.json, dependencies.md
  - [ ] archives prior outputs if changed
  - [ ] integration test: `getAllBehaviorPrioritized.integration.test.ts`

- [ ] **6.3** implement prioritize contract.cli
  - [ ] file: `src/contract/cli/getAllBehaviorPrioritized.ts`
  - [ ] gathers first, then calls operation with refs
  - [ ] acceptance test: `getAllBehaviorPrioritized.acceptance.test.ts`
  - [ ] tests: full pipeline, output files created, idempotent

### acceptance criteria

```
given('phase.6 is complete')
  when('prioritize skill is invoked')
    then('gather â†’ deptrace â†’ measure â†’ triage runs in sequence')
      sothat('full pipeline is encapsulated (scope.7 usecase.7.1)')
    then('prioritization.md is written with behaviors by urgency')
      sothat('human-readable summary is available')
    then('prioritization.json is written')
      sothat('machine-readable data is available')
    then('dependencies.md is written')
      sothat('dependency tree is visible')
  when('prior output files exist and new output differs')
    then('prior files are archived to .archive/')
      sothat('history is preserved (scope.7 usecase.7.3)')
  when('output matches prior files exactly')
    then('no archive is created')
      sothat('unchanged runs do not pollute archive')
```

### verification

```bash
# integration tests pass
npm run test:integration -- getAllBehaviorPrioritized

# acceptance tests pass
npm run test:acceptance -- getAllBehaviorPrioritized
```

---

## phase.7: coordinate skill

**goal**: implement workstream grouping and ranking

**depends on**: phase.5 (triage)

### checklist

- [ ] **7.1** implement groupBehaviorWorkstreams
  - [ ] file: `src/domain.operations/behavior/dispatch/coordinate/groupBehaviorWorkstreams.ts`
  - [ ] unit test: `groupBehaviorWorkstreams.test.ts`
  - [ ] tests: independent behaviors, dependent chains

- [ ] **7.2** implement rankBehaviorWorkstreams
  - [ ] file: `src/domain.operations/behavior/dispatch/coordinate/rankBehaviorWorkstreams.ts`
  - [ ] unit test: `rankBehaviorWorkstreams.test.ts`
  - [ ] tests: priority-based ranking, effect tie-breaking

- [ ] **7.3** implement renderBehaviorWorkstreamCoordinationMd
  - [ ] file: `src/domain.operations/behavior/dispatch/coordinate/renderBehaviorWorkstreamCoordinationMd.ts`
  - [ ] unit test: `renderBehaviorWorkstreamCoordinationMd.test.ts`
  - [ ] tests: output format, bottleneck detection

- [ ] **7.4** implement getAllBehaviorCoordinated (cache-critical)
  - [ ] file: `src/domain.operations/behavior/dispatch/coordinate/getAllBehaviorCoordinated.ts`
  - [ ] private/public pattern: `_getAllBehaviorCoordinated` + wrapped export
  - [ ] integration test: `getAllBehaviorCoordinated.integration.test.ts`
  - [ ] tests: workstream grouping, ranking, output files

- [ ] **7.5** implement coordinate contract.cli
  - [ ] file: `src/contract/cli/getAllBehaviorCoordinated.ts`
  - [ ] acceptance test: `getAllBehaviorCoordinated.acceptance.test.ts`

### acceptance criteria

```
given('phase.7 is complete')
  when('coordinate skill is invoked')
    then('triaged behaviors are grouped into workstreams')
      sothat('parallel execution is visible (scope.8 usecase.8.1)')
    then('workstreams are ranked by priority')
      sothat('review order is clear (scope.8 usecase.8.5)')
    then('coordination.md is written with workstream map')
      sothat('human-readable map is available')
    then('bottlenecks are detected and annotated')
      sothat('constraints are visible (scope.8 usecase.8.4)')
  when('multiple workstreams blocked on human review')
    then('workstreams are listed in rank order')
      sothat('user knows which to review first (wish: "which to review first?")')
```

### verification

```bash
# unit tests pass
npm run test:unit -- coordinate

# integration tests pass
npm run test:integration -- getAllBehaviorCoordinated

# acceptance tests pass
npm run test:acceptance -- getAllBehaviorCoordinated
```

---

## phase.8: role + skills

**goal**: implement dispatcher role and shell skill wrappers

**depends on**: phase.6 (prioritize), phase.7 (coordinate)

### checklist

- [ ] **8.1** implement getDispatcherRole
  - [ ] file: `src/domain.roles/dispatcher/getDispatcherRole.ts`
  - [ ] Role.build({ slug: 'dispatcher', briefs, skills })
  - [ ] unit test: `getDispatcherRole.test.ts`

- [ ] **8.2** implement skill shell wrappers (invoke contract/cli directly)
  - [ ] gather.sh â†’ contract/cli/getAllBehaviorGathered.ts
  - [ ] deptrace.sh â†’ contract/cli/getOneBehaviorDeptraced.ts (if exposed)
  - [ ] measure.sh â†’ contract/cli/getOneBehaviorMeasured.ts (if exposed)
  - [ ] triage.sh â†’ contract/cli/getAllBehaviorTriaged.ts (if exposed)
  - [ ] prioritize.sh â†’ contract/cli/getAllBehaviorPrioritized.ts
  - [ ] coordinate.sh â†’ contract/cli/getAllBehaviorCoordinated.ts

- [ ] **8.3** implement CLI output format
  - [ ] tree structure with branch characters (â”œâ”€, â””â”€, â”‚)
  - [ ] nature emojis: ğŸ¦« skill start, ğŸŒ² steps, ğŸ•ï¸ archived, ğŸŒŠ output
  - [ ] step timing (âœ“ done in Xs)
  - [ ] change prefixes (+ created, ~ updated)

- [ ] **8.4** implement acceptance tests for rhachet integration
  - [ ] acceptance test: skill invocation via npx rhachet run
  - [ ] acceptance test: CLI output format (tree structure, emojis)
  - [ ] acceptance test: exit codes on success/failure

### acceptance criteria

```
given('phase.8 is complete')
  when('npx rhachet run --repo bhuild --skill prioritize is invoked')
    then('CLI renders with tree structure')
      sothat('output is visually clear (scope.9 usecase.9.8)')
    then('nature emojis are used (ğŸ¦« ğŸŒ² ğŸ•ï¸ ğŸŒŠ)')
      sothat('output is scannable and zen')
    then('step timing is shown')
      sothat('user knows performance')
  when('role is booted via rhachet')
    then('briefs are loaded')
      sothat('knowledge is available to skills')
    then('skills are available')
      sothat('npx rhachet run --skill X works')
```

### verification

```bash
# role unit tests pass
npm run test:unit -- getDispatcherRole

# acceptance tests pass (covers skill invocation + CLI output format)
npm run test:acceptance -- dispatcher
```

---

## critical test scenarios (must-have coverage)

these scenarios are explicitly required by criteria and must have test coverage:

| scenario | phase | criteria reference | test type |
|----------|-------|-------------------|-----------|
| behavior depends on behavior not yet gathered | phase.3 | scope.4 usecase.4.10 / blocker.37 | integration |
| error message includes behavior names | phase.3 | scope.4 usecase.4.10 | integration |
| circular dependency detection | phase.3 | scope.4 usecase.4.7 | unit + integration |
| cache hit on unchanged contentHash | all | scope.12 usecase.12.2 | integration |
| idempotent output for all skills | all | scope.9 usecase.9.7 | acceptance |
| archive on change, skip on unchanged | phase.6 | scope.7 usecase.7.3 | integration |
| transitive leverage + yieldage | phase.4 | wish: "which unblocks the most?" | unit + integration |
| gain(+$), cost(-$), effect(~$) notation | phase.5 | scope.1 usecase.1.1 | unit |

---

## success metrics

- [ ] all unit tests pass: `npm run test:unit -- dispatcher`
- [ ] all integration tests pass: `npm run test:integration -- dispatcher`
- [ ] all acceptance tests pass: `npm run test:acceptance -- dispatcher`
- [ ] blocker.37 (missing dep failfast) has test coverage
- [ ] cache reduces re-execution time by >80% on unchanged inputs
- [ ] idempotent output for all skills
- [ ] CLI renders with nature emojis (ğŸ¦«, ğŸŒ², ğŸ•ï¸, ğŸŒŠ)
- [ ] brief research phase complete (scope.2 criteria)

---

## execution order summary

```
phase.0 â†’ phase.1 â†’ phase.2 â†’ phase.3 â†’ phase.4 â†’ phase.5 â†’ phase.6
                                                          â†’ phase.7
                                                          â†’ phase.8
```

parallelizable after phase.5:
- phase.6 (prioritize) and phase.7 (coordinate) can proceed in parallel
- phase.8 (role + skills) can start after phase.6 and phase.7

---

## appendix: file inventory

### domain.objects (phase.1)
- Behavior.ts
- BehaviorGathered.ts
- BehaviorDeptraced.ts
- BehaviorMeasured.ts
- BehaviorTriaged.ts
- BehaviorWorkstream.ts
- BehaviorMeasuredGain.ts
- BehaviorMeasuredCost.ts
- BehaviorMeasuredGainLeverage.ts
- BehaviorMeasuredGainYieldage.ts
- BehaviorMeasuredGainYieldageChance.ts
- BehaviorMeasuredCostAttend.ts
- BehaviorMeasuredCostExpend.ts
- BehaviorWorkstreamDeliverable.ts
- BehaviorDispatchConfig.ts
- BehaviorSourceRepoRemote.ts

### domain.operations (phase.2-7)
- behavior/dispatch/findsertBehaviorDispatchDir.ts
- behavior/dispatch/archiveBehaviorIfChanged.ts
- behavior/dispatch/genBehaviorDispatchContext.ts
- behavior/dispatch/gather/getAllBehaviorGathered.ts
- behavior/dispatch/gather/getOneBehaviorGathered.ts
- behavior/dispatch/gather/enumBehaviorDirs.ts
- behavior/dispatch/gather/parseBehaviorDir.ts
- behavior/dispatch/gather/computeBehaviorGatheredContentHash.ts
- behavior/dispatch/gather/loadBehaviorDispatchConfig.ts
- behavior/dispatch/deptrace/getOneBehaviorDeptraced.ts
- behavior/dispatch/deptrace/parseBehaviorDeptracedDependencies.ts
- behavior/dispatch/deptrace/computeBehaviorDeptracedTransitiveDeps.ts
- behavior/dispatch/deptrace/renderBehaviorDeptracedDependenciesMd.ts
- behavior/dispatch/measure/getOneBehaviorMeasured.ts
- behavior/dispatch/measure/computeBehaviorMeasuredGainLeverage.ts
- behavior/dispatch/measure/computeBehaviorMeasuredGainYieldage.ts
- behavior/dispatch/measure/computeBehaviorMeasuredGainComposite.ts
- behavior/dispatch/measure/computeBehaviorMeasuredCostAttend.ts
- behavior/dispatch/measure/computeBehaviorMeasuredCostExpend.ts
- behavior/dispatch/measure/computeBehaviorMeasuredCostComposite.ts
- behavior/dispatch/measure/computeBehaviorMeasuredReverseDeps.ts
- behavior/dispatch/measure/assignBehaviorMeasuredPriority.ts
- behavior/dispatch/triage/getAllBehaviorTriaged.ts
- behavior/dispatch/triage/computeBehaviorTriagedReadiness.ts
- behavior/dispatch/triage/computeBehaviorTriagedBandwidth.ts
- behavior/dispatch/triage/renderBehaviorTriagedPrioritizationMd.ts
- behavior/dispatch/prioritize/getAllBehaviorPrioritized.ts
- behavior/dispatch/coordinate/getAllBehaviorCoordinated.ts
- behavior/dispatch/coordinate/groupBehaviorWorkstreams.ts
- behavior/dispatch/coordinate/rankBehaviorWorkstreams.ts
- behavior/dispatch/coordinate/renderBehaviorWorkstreamCoordinationMd.ts

### contract/cli (phase.2, 6, 7)
- cli/getAllBehaviorGathered.ts
- cli/getOneBehaviorDeptraced.ts
- cli/getOneBehaviorMeasured.ts
- cli/getAllBehaviorTriaged.ts
- cli/getAllBehaviorPrioritized.ts
- cli/getAllBehaviorCoordinated.ts

### role (phase.8)
- domain.roles/dispatcher/getDispatcherRole.ts
- domain.roles/dispatcher/skills/gather.sh
- domain.roles/dispatcher/skills/deptrace.sh
- domain.roles/dispatcher/skills/measure.sh
- domain.roles/dispatcher/skills/triage.sh
- domain.roles/dispatcher/skills/prioritize.sh
- domain.roles/dispatcher/skills/coordinate.sh
