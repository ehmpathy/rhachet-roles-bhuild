# feedback response: domain distillation v2 → v3 (contract vs operation separation)

## checklist

- [x] blocker.36: getOneBehaviorDeptraced uses `.gathered/latest/` to find deps ✓
- [x] blocker.37: support deps on behaviors not yet gathered (failfast + test criteria) ✓
- [x] blocker.38: add dependency resolution criteria to 2.criteria.md ✓
- [x] blocker.39: separate contracts (`{ by: config }`) from operations (`{ over: { behaviors } }`) ✓
- [x] blocker.40: rename `getAllBehaviorWorkstream` → `getAllBehaviorCoordinated` ✓

---

## response plan

### blocker.36: getOneBehaviorDeptraced uses `.gathered/latest/`

`getOneBehaviorDeptraced` needs to find which behaviors it depends on. rather than passing the full basket of gathered behaviors, the operation will:
- look in `.gathered/latest/` directory to find available behaviors
- resolve dependency refs against that directory
- this is implicit context, not explicit input

add comment explaining this lookup behavior.

### blocker.37: support deps on behaviors not yet gathered

when a behavior declares a dependency on a behavior that hasn't been gathered:
- failfast with clear error message
- error should include: which behavior is missing, which behavior depends on it
- **key criteria**: this scenario must have test coverage

add `.note` comment in implementation highlighting this as critical test case.

### blocker.38: add dependency resolution criteria

add to `2.criteria.md`:
- criterion for dependency resolution via `.gathered/latest/`
- criterion for failfast on missing dependency
- criterion for test coverage on missing dependency scenario

### blocker.39: separate contracts from operations

**contracts** (in `contract/cmd/`):
- `getAllBehaviorPrioritized({ by: BehaviorDispatchConfig })`
- `getAllBehaviorCoordinated({ by: BehaviorDispatchConfig })`
- agnostic of content hash
- invoke `getAllBehaviorGathered` first to get latest refs
- then call domain.operations with those refs

**domain.operations** (in `domain.operations/behavior/`):
- `getAllBehaviorPrioritized({ over: { behaviors: RefByUnique<typeof BehaviorGathered>[] } })`
- `getAllBehaviorCoordinated({ over: { behaviors: RefByUnique<typeof BehaviorGathered>[] } })`
- operate on specific versioned refs
- leverage caching via contentHash in refs

### blocker.40: rename to getAllBehaviorCoordinated

`getAllBehaviorWorkstream` → `getAllBehaviorCoordinated` for consistency with contract naming.

the result type still returns `workstreams: BehaviorWorkstream[]`.
