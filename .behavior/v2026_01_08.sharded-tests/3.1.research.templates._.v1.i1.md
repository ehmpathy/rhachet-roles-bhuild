# research: test shard template from rhachet-roles-bhrain PR #21

## source

**template**: https://github.com/ehmpathy/rhachet-roles-bhrain/pull/21/files [1]

**pr title**: `fix(cicd): drop walltime with integ test shards` [1]

---

## overview

the template implements a **hybrid shard strategy** for integration tests:
- **explicit shards**: slow tests get dedicated shards (1 shard per explicit entry)
- **dynamic shards**: rest of tests distributed via Jest's `--shard` across N shards

---

## key patterns

### pattern 1: config-driven shards via `jest.integration.shards.jsonc`

the shard behavior is controlled by a single config file:

```jsonc
{
  // run these slowpokes individually, cause they're the longest poles in the wall time
  "explicit": [
    {
      "patterns": [
        "src/roles/reviewer/skills/reflect/reflect.casePriorRules.sonnet.integration.test.ts"
      ]
    },
    {
      "patterns": [
        "src/roles/reviewer/skills/reflect/reflect.casePriorRules.haiku.integration.test.ts"
      ]
    },
    {
      "patterns": [
        "src/roles/reviewer/skills/reflect/reflect.caseTypescriptQuality.integration.test.ts"
      ]
    }
  ],
  // run the rest on one shard
  "dynamic": {
    "shards": 1
  }
}
```
[2: jest.integration.shards.jsonc in PR diff]

**key insight**: explicit shards isolate known-slow tests; dynamic shards handle the rest automatically.

---

### pattern 2: `shards-setup` job generates matrix from config

the workflow has a dedicated job that reads the config and outputs a matrix:

```yaml
shards-setup:
  runs-on: ubuntu-24.04
  outputs:
    enabled: ${{ steps.generate.outputs.enabled }}
    matrix: ${{ steps.generate.outputs.matrix }}
    explicit-patterns: ${{ steps.generate.outputs.explicit-patterns }}
  steps:
    - name: checkout
      uses: actions/checkout@v4
      with:
        sparse-checkout: jest.integration.shards.jsonc
        sparse-checkout-cone-mode: false

    - name: generate matrix
      id: generate
      run: |
        # check if config exists
        if [[ ! -f jest.integration.shards.jsonc ]]; then
          echo "::notice::jest.integration.shards.jsonc not found, shard mode disabled"
          echo 'enabled=false' >> $GITHUB_OUTPUT
          exit 0
        fi

        echo 'enabled=true' >> $GITHUB_OUTPUT

        # read config (strip comments for jq)
        config=$(grep -v '^\s*//' jest.integration.shards.jsonc | jq -c '.')

        # extract explicit shards
        explicit=$(echo "$config" | jq -c '.explicit // []')
        explicit_count=$(echo "$explicit" | jq 'length')

        # extract dynamic shard count
        dynamic_count=$(echo "$config" | jq '.dynamic.shards // 0')

        # build matrix
        matrix="[]"

        # add explicit shards
        for i in $(seq 0 $((explicit_count - 1))); do
          patterns=$(echo "$explicit" | jq -c ".[$i].patterns")
          matrix=$(echo "$matrix" | jq -c ". + [{\"type\": \"explicit\", \"index\": $i, \"patterns\": $patterns}]")
        done

        # add dynamic shards
        for i in $(seq 1 $dynamic_count); do
          matrix=$(echo "$matrix" | jq -c ". + [{\"type\": \"dynamic\", \"shard\": $i, \"total\": $dynamic_count}]")
        done

        # collect all explicit patterns for exclusion
        explicit_patterns=$(echo "$explicit" | jq -r '.[].patterns[]' | paste -sd '|')

        echo "matrix=$matrix" >> $GITHUB_OUTPUT
        echo "explicit-patterns=$explicit_patterns" >> $GITHUB_OUTPUT

        echo "::notice::shard mode enabled with $(echo "$matrix" | jq 'length') shards"
```
[3: .github/workflows/.test.yml shards-setup job in PR diff]

**key outputs**:
- `enabled`: `'true'` if config exists, `'false'` otherwise
- `matrix`: JSON array of shard configs
- `explicit-patterns`: all explicit patterns joined with `|` for exclusion

---

### pattern 3: `test-shards-integration` job runs the matrix

a new job consumes the matrix and runs tests in parallel:

```yaml
test-shards-integration:
  runs-on: ubuntu-24.04
  needs: [install, shards-setup]
  if: needs.shards-setup.outputs.enabled == 'true'
  strategy:
    fail-fast: false
    matrix:
      shard: ${{ fromJson(needs.shards-setup.outputs.matrix) }}
```
[4: .github/workflows/.test.yml test-shards-integration job in PR diff]

**explicit shard execution**:
```yaml
- name: test:integration (explicit ${{ matrix.shard.index }})
  if: matrix.shard.type == 'explicit'
  run: |
    patterns='${{ join(matrix.shard.patterns, '|') }}'
    THOROUGH=true npm run test:integration -- --testPathPatterns="$patterns"
```
[5: explicit shard step in PR diff]

**dynamic shard execution**:
```yaml
- name: test:integration (dynamic ${{ matrix.shard.shard }}/${{ matrix.shard.total }})
  if: matrix.shard.type == 'dynamic'
  run: |
    exclude='${{ needs.shards-setup.outputs.explicit-patterns }}'
    if [[ -n "$exclude" ]]; then
      THOROUGH=true npm run test:integration -- --testPathIgnorePatterns="$exclude" --shard=${{ matrix.shard.shard }}/${{ matrix.shard.total }}
    else
      THOROUGH=true npm run test:integration -- --shard=${{ matrix.shard.shard }}/${{ matrix.shard.total }}
    fi
```
[6: dynamic shard step in PR diff]

**key insight**: explicit shards use `--testPathPatterns`; dynamic shards use `--shard` + `--testPathIgnorePatterns` to exclude explicit files.

---

### pattern 4: dual-purpose `test-integration` job for backwards compatibility

the original `test-integration` job remains but becomes dual-purpose:

```yaml
test-integration:
  runs-on: ubuntu-24.04
  needs: [install, shards-setup, test-shards-integration]
  if: always() && needs.install.result == 'success' && needs.shards-setup.result == 'success'
  steps:
    # early return: if shard mode enabled, just report results
    - name: report shard results
      if: needs.shards-setup.outputs.enabled == 'true'
      run: |
        if [[ "${{ needs.test-shards-integration.result }}" == "success" ]]; then
          echo "ðŸ‘Œ all integration test shards passed"
        else
          echo "::error::integration test shards failed"
          exit 1
        fi

    # otherwise: full test flow (no shards, backwards compatible)
    - name: checkout
      if: needs.shards-setup.outputs.enabled != 'true'
      uses: actions/checkout@v4
```
[7: test-integration dual-purpose job in PR diff]

**key insight**: when config file is absent, behaves exactly like before â€” no shards, just runs `npm run test:integration`.

---

### pattern 5: visual alignment placeholder job

a placeholder job exists solely for github actions visualization alignment:

```yaml
# placeholder job to align test-* jobs with test-shards-integration column
# note: github actions visualization has no column position controls;
#       this job exists solely to push test-* jobs one column to the right
test-shards-omit:
  runs-on: ubuntu-24.04
  needs: [install]
  steps:
    - run: echo "ðŸ‘Œ placeholder for column alignment"
```
[8: test-shards-omit job in PR diff]

---

## relation to wish

| wish requirement | template pattern | how it satisfies |
|------------------|------------------|------------------|
| "explicitly declared shards; allowlists of files per shards" | `"explicit"` array in config [2] | each entry becomes a dedicated shard with `--testPathPatterns` [5] |
| "the REST go into dynamicly computed shards" | `"dynamic"` object in config [2] | uses Jest's `--shard` flag with `--testPathIgnorePatterns` to exclude explicit files [6] |
| "atleast 3 dynamic shards on the acceptance tests" | `"dynamic": { "shards": 3 }` | directly supported by config format [2] |
| "find which tests are the slowest and put them into their own shards explicitly" | explicit patterns in config [2] | manual curation of slow tests into explicit shards |
| backwards compatibility when config absent | dual-purpose `test-integration` job [7] | falls back to non-sharded execution |

---

## blueprint summary from template

from the blueprint document in the PR [9]:

> **total shards** = `explicit.length + dynamic.shards`

> **edge cases**:
> - **no explicit shards**: matrix contains only dynamic shards; `explicit-patterns` is empty, `--testPathIgnorePatterns` is skipped
> - **no dynamic shards**: matrix contains only explicit shards; all tests must be covered by explicit patterns
> - **config file absent**: `setup-shards` outputs `enabled=false`; `test-shards-integration` is skipped; `test-integration` runs tests directly â€” **fully backwards compatible**

---

## citations

[1] PR metadata: `gh pr view 21 --repo ehmpathy/rhachet-roles-bhrain --json title,url`
```
{"title":"fix(cicd): drop walltime with integ test shards","url":"https://github.com/ehmpathy/rhachet-roles-bhrain/pull/21"}
```

[2] `jest.integration.shards.jsonc` from PR diff

[3] `shards-setup` job from `.github/workflows/.test.yml` diff

[4] `test-shards-integration` job header from `.github/workflows/.test.yml` diff

[5] explicit shard step from `.github/workflows/.test.yml` diff

[6] dynamic shard step from `.github/workflows/.test.yml` diff

[7] `test-integration` dual-purpose job from `.github/workflows/.test.yml` diff

[8] `test-shards-omit` job from `.github/workflows/.test.yml` diff

[9] `.behavior/v2025_12_26.integ-shards/3.3.blueprint.v1.i1.md` from PR diff

---

## applicability to this repo

to replicate for **both integration and acceptance tests**:

1. create `jest.integration.shards.jsonc` â€” explicit + dynamic config for integration tests
2. create `jest.acceptance.shards.jsonc` â€” explicit + dynamic config for acceptance tests (start with 3 dynamic shards per wish)
3. update `.github/workflows/.test.yml`:
   - add `shards-setup` job (or generalize to read both configs)
   - add `test-shards-integration` job
   - add `test-shards-acceptance` job (parallel to integration pattern)
   - update `test-integration` and `test-acceptance` jobs to be dual-purpose
4. identify slowest tests (via local time measurements or CI logs) and add to explicit shards
