# execution log: test shards implementation

## status: complete (phases 0-6)

---

## phase 0: prerequisites

### step 0.1: verify base workflow exists

- [x] `.github/workflows/.test.yml` exists
- [x] `test-integration` job present
- [x] `test-acceptance-locally` job present

**status**: ✅ complete

**verification output**:
```
test-integration:
  test-acceptance-locally:
```

---

## phase 1: create composite action

### step 1.1: create action directory

- [x] create `.github/actions/test-shards-setup/` directory

**status**: ✅ complete

---

### step 1.2: create composite action file

- [x] create `.github/actions/test-shards-setup/action.yml`
- [x] action accepts `config-file` input
- [x] action accepts `test-type` input
- [x] action outputs `enabled`, `matrix`, `explicit-patterns`
- [x] action runs with `composite` runner and bash steps
- [x] action strips jsonc comments before jq parse
- [x] action builds matrix from explicit + dynamic shards
- [x] action outputs `enabled=false` when config absent

**status**: ✅ complete

---

## phase 2: create config files

### step 2.1: create integration shards config

- [x] create `jest.integration.shards.jsonc`
- [x] set `explicit: []`
- [x] set `dynamic.shards: 2`

**status**: ✅ complete

---

### step 2.2: create acceptance shards config

- [x] create `jest.acceptance.shards.jsonc`
- [x] set `explicit: []`
- [x] set `dynamic.shards: 3`

**status**: ✅ complete

---

## phase 3: update workflow - setup jobs

### step 3.1: add integration shard setup job

- [x] add `test-shards-setup-integration` job

**status**: ✅ complete

---

### step 3.2: add acceptance shard setup job

- [x] add `test-shards-setup-acceptance` job

**status**: ✅ complete

---

## phase 4: update workflow - shard runner jobs

### step 4.1: add integration shard runner job

- [x] add `test-shards-integration` job
- [x] job depends on `install` and `test-shards-setup-integration`
- [x] matrix strategy with `fromJson`
- [x] `fail-fast: false`
- [x] explicit shard step with `--testPathPattern`
- [x] dynamic shard step with `--shard=N/M`

**status**: ✅ complete

---

### step 4.2: add acceptance shard runner job

- [x] add `test-shards-acceptance` job
- [x] job depends on `install` and `test-shards-setup-acceptance`
- [x] matrix strategy with `fromJson`
- [x] `fail-fast: false`
- [x] explicit shard step with `--testPathPattern`
- [x] dynamic shard step with `--shard=N/M`

**status**: ✅ complete

---

## phase 5: update workflow - dual-purpose jobs

### step 5.1: update test-integration to dual-purpose

- [x] add `test-shards-setup-integration` and `test-shards-integration` to `needs`
- [x] add `if: always() && ...` condition
- [x] add "report shard results" step for shard mode
- [x] add conditional guards on all fallback steps

**status**: ✅ complete

---

### step 5.2: update test-acceptance-locally to dual-purpose

- [x] add `test-shards-setup-acceptance` and `test-shards-acceptance` to `needs`
- [x] add `if: always() && ...` condition
- [x] add "report shard results" step for shard mode
- [x] add conditional guards on all fallback steps

**status**: ✅ complete

---

## phase 6: local validation

### step 6.1: validate yaml syntax

- [x] workflow file is valid yaml
- [x] composite action is valid yaml

**status**: ✅ complete

---

### step 6.2: validate config files

- [x] integration config parses as json

**verification output**:
```json
{
  "explicit": [],
  "dynamic": {
    "shards": 2
  }
}
```

- [x] acceptance config parses as json

**verification output**:
```json
{
  "explicit": [],
  "dynamic": {
    "shards": 3
  }
}
```

**status**: ✅ complete

---

### step 6.3: test matrix generation locally

- [x] matrix output format is correct
- [x] dynamic shards count = 3 for acceptance

**status**: ✅ complete

---

## execution log

```
2026-01-08 phase 0: verified base workflow exists
2026-01-08 phase 1: created .github/actions/test-shards-setup/action.yml
2026-01-08 phase 2: created jest.integration.shards.jsonc (2 dynamic shards)
2026-01-08 phase 2: created jest.acceptance.shards.jsonc (3 dynamic shards)
2026-01-08 phase 3: added test-shards-setup-integration job
2026-01-08 phase 3: added test-shards-setup-acceptance job
2026-01-08 phase 4: added test-shards-integration job with matrix strategy
2026-01-08 phase 4: added test-shards-acceptance job with matrix strategy
2026-01-08 phase 5: updated test-integration to dual-purpose
2026-01-08 phase 5: updated test-acceptance-locally to dual-purpose
2026-01-08 phase 6: validated all yaml and jsonc files
2026-01-08 phase 6: tested matrix generation locally
2026-01-08 phase 7: [fix] sparse-checkout must include composite action directory
```

---

## files created

| file | description |
|------|-------------|
| `.github/actions/test-shards-setup/action.yml` | composite action for matrix generation |
| `jest.integration.shards.jsonc` | integration test shard config (2 dynamic) |
| `jest.acceptance.shards.jsonc` | acceptance test shard config (3 dynamic) |

## files modified

| file | changes |
|------|---------|
| `.github/workflows/.test.yml` | added 4 new jobs, updated 2 jobs to dual-purpose |

---

## next steps

phases 7-9 require CI execution:

- [ ] phase 7: push branch and verify CI runs with shards
- [ ] phase 8: verify backwards compatibility when config absent
- [ ] phase 9: optimize (identify slow tests, tune shard count)
