# roadmap: test shards for integration + acceptance tests

## overview

ordered execution plan to implement hybrid shard strategy per blueprint.

**goal**: drop acceptance test walltime from ~7 minutes to ~2-3 minutes via parallel shards.

---

## phase 0: prerequisites

### step 0.1: verify base workflow exists

- [ ] `.github/workflows/.test.yml` exists
- [ ] `test-integration` job present
- [ ] `test-acceptance-locally` job present

**acceptance criteria**:
- workflow file contains both jobs with standard step structure

**verification**:
```bash
grep -E "test-integration:|test-acceptance-locally:" .github/workflows/.test.yml
```

**expected**: both job names appear in output

---

## phase 1: create composite action

> **depends on**: phase 0

### step 1.1: create action directory

- [ ] create `.github/actions/test-shards-setup/` directory

**acceptance criteria**:
- directory exists at `.github/actions/test-shards-setup/`

**verification**:
```bash
ls -la .github/actions/test-shards-setup/
```

**expected**: directory exists (may be empty)

---

### step 1.2: create composite action file

- [ ] create `.github/actions/test-shards-setup/action.yml`
- [ ] action accepts `config-file` input
- [ ] action accepts `test-type` input
- [ ] action outputs `enabled`, `matrix`, `explicit-patterns`
- [ ] action runs with `composite` runner and bash steps
- [ ] action strips jsonc comments before jq parse
- [ ] action builds matrix from explicit + dynamic shards
- [ ] action outputs `enabled=false` when config absent

**acceptance criteria**:
- composite action file exists
- inputs and outputs declared per blueprint
- bash script generates matrix correctly

**verification**:
```bash
# file exists
test -f .github/actions/test-shards-setup/action.yml && echo "action.yml exists"

# has required inputs
grep -E "config-file:|test-type:" .github/actions/test-shards-setup/action.yml

# has required outputs
grep -E "enabled:|matrix:|explicit-patterns:" .github/actions/test-shards-setup/action.yml

# uses composite
grep "using: composite" .github/actions/test-shards-setup/action.yml
```

**expected**: all checks pass

---

## phase 2: create config files

> **depends on**: none (can run parallel with phase 1)

### step 2.1: create integration shards config

- [ ] create `jest.integration.shards.jsonc`
- [ ] set `explicit: []` (no explicit shards initially)
- [ ] set `dynamic.shards: 2`

**acceptance criteria**:
- file is valid jsonc
- dynamic shards set to 2

**verification**:
```bash
# file exists
test -f jest.integration.shards.jsonc && echo "integration config exists"

# parse (strip comments, validate json)
grep -v '^\s*//' jest.integration.shards.jsonc | jq '.dynamic.shards'
```

**expected**: outputs `2`

---

### step 2.2: create acceptance shards config

- [ ] create `jest.acceptance.shards.jsonc`
- [ ] set `explicit: []` (no explicit shards initially)
- [ ] set `dynamic.shards: 3` (per wish: at least 3)

**acceptance criteria**:
- file is valid jsonc
- dynamic shards set to 3

**verification**:
```bash
# file exists
test -f jest.acceptance.shards.jsonc && echo "acceptance config exists"

# parse (strip comments, validate json)
grep -v '^\s*//' jest.acceptance.shards.jsonc | jq '.dynamic.shards'
```

**expected**: outputs `3`

---

## phase 3: update workflow - setup jobs

> **depends on**: phase 1, phase 2

### step 3.1: add integration shard setup job

- [ ] add `test-shards-setup-integration` job to `.github/workflows/.test.yml`
- [ ] job invokes sparse checkout for config file only
- [ ] job invokes composite action with `config-file: jest.integration.shards.jsonc`
- [ ] job outputs `enabled`, `matrix`, `explicit-patterns`

**acceptance criteria**:
- job defined with correct structure
- invokes composite action from `./.github/actions/test-shards-setup`

**verification**:
```bash
grep -A 20 "test-shards-setup-integration:" .github/workflows/.test.yml | head -20
```

**expected**: job invokes `./.github/actions/test-shards-setup` with integration config

---

### step 3.2: add acceptance shard setup job

- [ ] add `test-shards-setup-acceptance` job to `.github/workflows/.test.yml`
- [ ] job invokes sparse checkout for config file only
- [ ] job invokes composite action with `config-file: jest.acceptance.shards.jsonc`
- [ ] job outputs `enabled`, `matrix`, `explicit-patterns`

**acceptance criteria**:
- job defined with correct structure
- invokes composite action from `./.github/actions/test-shards-setup`

**verification**:
```bash
grep -A 20 "test-shards-setup-acceptance:" .github/workflows/.test.yml | head -20
```

**expected**: job invokes `./.github/actions/test-shards-setup` with acceptance config

---

## phase 4: update workflow - shard runner jobs

> **depends on**: phase 3

### step 4.1: add integration shard runner job

- [ ] add `test-shards-integration` job
- [ ] job depends on `install` and `test-shards-setup-integration`
- [ ] job has `if: needs.test-shards-setup-integration.outputs.enabled == 'true'`
- [ ] job applies matrix strategy with `fromJson(needs.test-shards-setup-integration.outputs.matrix)`
- [ ] job has `fail-fast: false`
- [ ] explicit shard step applies `--testPathPattern`
- [ ] dynamic shard step applies `--shard=N/M` and `--testPathIgnorePatterns`

**acceptance criteria**:
- matrix job spawns correct number of shards
- explicit and dynamic steps have correct conditional execution

**verification**:
```bash
# job exists with matrix
grep -A 30 "test-shards-integration:" .github/workflows/.test.yml | grep -E "matrix:|fail-fast:|fromJson"

# has explicit and dynamic steps
grep -E "testPathPattern|--shard=" .github/workflows/.test.yml
```

**expected**: matrix strategy and both shard types present

---

### step 4.2: add acceptance shard runner job

- [ ] add `test-shards-acceptance` job
- [ ] job depends on `install` and `test-shards-setup-acceptance`
- [ ] job has `if: needs.test-shards-setup-acceptance.outputs.enabled == 'true'`
- [ ] job applies matrix strategy with `fromJson(needs.test-shards-setup-acceptance.outputs.matrix)`
- [ ] job has `fail-fast: false`
- [ ] explicit shard step applies `--testPathPattern`
- [ ] dynamic shard step applies `--shard=N/M` and `--testPathIgnorePatterns`

**acceptance criteria**:
- matrix job spawns correct number of shards
- explicit and dynamic steps have correct conditional execution

**verification**:
```bash
# job exists with matrix
grep -A 30 "test-shards-acceptance:" .github/workflows/.test.yml | grep -E "matrix:|fail-fast:|fromJson"
```

**expected**: matrix strategy for acceptance shards present

---

## phase 5: update workflow - dual-purpose jobs

> **depends on**: phase 4

### step 5.1: update test-integration to dual-purpose

- [ ] add `test-shards-setup-integration` and `test-shards-integration` to `needs`
- [ ] add `if: always() && needs.install.result == 'success' && needs.test-shards-setup-integration.result == 'success'`
- [ ] add "report shard results" step for shard mode (early return)
- [ ] add conditional `if: needs.test-shards-setup-integration.outputs.enabled != 'true'` to all other steps

**acceptance criteria**:
- job reports shard results when shard mode enabled
- job runs tests directly when shard mode disabled (backwards compatible)

**verification**:
```bash
# has dual needs
grep -A 5 "test-integration:" .github/workflows/.test.yml | grep "needs:"

# has report shard results step
grep -A 5 "report shard results" .github/workflows/.test.yml
```

**expected**: job has both shard and fallback logic

---

### step 5.2: update test-acceptance-locally to dual-purpose

- [ ] add `test-shards-setup-acceptance` and `test-shards-acceptance` to `needs`
- [ ] add `if: always() && needs.install.result == 'success' && needs.test-shards-setup-acceptance.result == 'success'`
- [ ] add "report shard results" step for shard mode (early return)
- [ ] add conditional `if: needs.test-shards-setup-acceptance.outputs.enabled != 'true'` to all other steps

**acceptance criteria**:
- job reports shard results when shard mode enabled
- job runs tests directly when shard mode disabled (backwards compatible)

**verification**:
```bash
# has dual needs
grep -A 5 "test-acceptance-locally:" .github/workflows/.test.yml | grep "needs:"

# has report shard results step
grep -B 2 -A 5 "all acceptance test shards" .github/workflows/.test.yml
```

**expected**: job has both shard and fallback logic

---

## phase 6: local validation

> **depends on**: phase 5

### step 6.1: validate yaml syntax

- [ ] workflow file is valid yaml
- [ ] no syntax errors in composite action

**acceptance criteria**:
- yaml parse succeeds without errors

**verification**:
```bash
# validate workflow
npx yaml-lint .github/workflows/.test.yml || python3 -c "import yaml; yaml.safe_load(open('.github/workflows/.test.yml'))"

# validate action
npx yaml-lint .github/actions/test-shards-setup/action.yml || python3 -c "import yaml; yaml.safe_load(open('.github/actions/test-shards-setup/action.yml'))"
```

**expected**: no parse errors

---

### step 6.2: validate config files

- [ ] integration config parses as json (after comment strip)
- [ ] acceptance config parses as json (after comment strip)

**acceptance criteria**:
- both configs are valid jsonc

**verification**:
```bash
grep -v '^\s*//' jest.integration.shards.jsonc | jq '.'
grep -v '^\s*//' jest.acceptance.shards.jsonc | jq '.'
```

**expected**: both output valid json objects

---

### step 6.3: test matrix generation locally

- [ ] simulate composite action bash script locally
- [ ] verify matrix output format is correct

**acceptance criteria**:
- matrix contains expected number of shards
- shard objects have correct structure

**verification**:
```bash
# simulate for acceptance (3 dynamic shards)
config=$(grep -v '^\s*//' jest.acceptance.shards.jsonc | jq -c '.')
dynamic_count=$(echo "$config" | jq '.dynamic.shards // 0')
echo "dynamic shards: $dynamic_count"
# should output: 3
```

**expected**: outputs `dynamic shards: 3`

---

## phase 7: CI validation

> **depends on**: phase 6

### step 7.1: push branch and trigger CI

- [ ] commit all changes
- [ ] push to feature branch
- [ ] CI workflow triggers

**acceptance criteria**:
- workflow runs without yaml parse errors

**verification**:
```bash
# check workflow status
gh run list --branch $(git branch --show-current) --limit 1
```

**expected**: workflow run appears in list

---

### step 7.2: verify shard jobs spawn

- [ ] `test-shards-setup-integration` outputs `enabled=true`
- [ ] `test-shards-setup-acceptance` outputs `enabled=true`
- [ ] `test-shards-integration` spawns 2 matrix jobs
- [ ] `test-shards-acceptance` spawns 3 matrix jobs

**acceptance criteria**:
- shard setup jobs complete successfully
- matrix jobs spawn with correct count

**verification**:
```bash
# view workflow run with job details
gh run view --log-failed || gh run view
```

**expected**: 2 integration shards + 3 acceptance shards visible in job list

---

### step 7.3: verify all tests pass

- [ ] all integration shard jobs pass
- [ ] all acceptance shard jobs pass
- [ ] `test-integration` reports success
- [ ] `test-acceptance-locally` reports success

**acceptance criteria**:
- all shard jobs green
- dual-purpose jobs green

**verification**:
```bash
gh run view --json conclusion -q '.conclusion'
```

**expected**: outputs `success`

---

### step 7.4: measure walltime improvement

- [ ] compare acceptance test walltime before vs after
- [ ] document improvement ratio

**acceptance criteria**:
- walltime reduced (target: ~7min → ~2-3min)

**verification**:
```bash
# view job times
gh run view --json jobs -q '.jobs[] | select(.name | contains("acceptance")) | "\(.name): \(.startedAt) - \(.completedAt)"'
```

**expected**: parallel jobs complete in less time than sequential baseline

---

## phase 8: backwards compatibility validation

> **depends on**: phase 7

### step 8.1: verify fallback when config absent

- [ ] temporarily rename/remove `jest.acceptance.shards.jsonc`
- [ ] push and verify `test-shards-setup-acceptance` outputs `enabled=false`
- [ ] verify `test-shards-acceptance` is skipped
- [ ] verify `test-acceptance-locally` runs tests directly

**acceptance criteria**:
- system falls back to non-sharded mode when config absent

**verification**:
- manual: observe CI logs for skipped shard jobs and direct test execution

**expected**: backwards compatible behavior preserved

---

### step 8.2: restore config

- [ ] restore `jest.acceptance.shards.jsonc`
- [ ] verify shard mode re-enables

**acceptance criteria**:
- shard mode re-enables when config present

---

## phase 9: optimization (future)

> **depends on**: phase 7

### step 9.1: identify slow tests

- [ ] analyze CI logs for test runtimes
- [ ] identify tests that take >30% of shard walltime

**acceptance criteria**:
- slow tests identified with runtime data

**verification**:
- review jest output for individual test times

---

### step 9.2: add explicit shards for slow tests

- [ ] add slow test patterns to `explicit` array in config
- [ ] adjust `dynamic.shards` count if needed
- [ ] push and verify explicit shards run dedicated jobs

**acceptance criteria**:
- slow tests isolated to explicit shards
- walltime further reduced

---

### step 9.3: tune shard count

- [ ] monitor walltime over multiple runs
- [ ] adjust dynamic shard count for optimal parallelism
- [ ] balance parallelism vs setup overhead

**acceptance criteria**:
- optimal shard count determined empirically

---

## summary: execution order

```
phase 0: prerequisites
    └── verify base workflow exists

phase 1: create composite action     ─┐
    ├── step 1.1: create directory    │
    └── step 1.2: create action.yml   │
                                      ├── parallel
phase 2: create config files         ─┤
    ├── step 2.1: integration config  │
    └── step 2.2: acceptance config  ─┘

phase 3: update workflow - setup jobs
    ├── step 3.1: integration setup job
    └── step 3.2: acceptance setup job

phase 4: update workflow - shard runner jobs
    ├── step 4.1: integration shard runner
    └── step 4.2: acceptance shard runner

phase 5: update workflow - dual-purpose jobs
    ├── step 5.1: test-integration dual-purpose
    └── step 5.2: test-acceptance-locally dual-purpose

phase 6: local validation
    ├── step 6.1: validate yaml syntax
    ├── step 6.2: validate config files
    └── step 6.3: test matrix generation locally

phase 7: CI validation
    ├── step 7.1: push and trigger CI
    ├── step 7.2: verify shard jobs spawn
    ├── step 7.3: verify all tests pass
    └── step 7.4: measure walltime improvement

phase 8: backwards compatibility validation
    ├── step 8.1: verify fallback when config absent
    └── step 8.2: restore config

phase 9: optimization (future)
    ├── step 9.1: identify slow tests
    ├── step 9.2: add explicit shards
    └── step 9.3: tune shard count
```

---

## files created/modified

| phase | file | action |
|-------|------|--------|
| 1 | `.github/actions/test-shards-setup/action.yml` | create |
| 2 | `jest.integration.shards.jsonc` | create |
| 2 | `jest.acceptance.shards.jsonc` | create |
| 3-5 | `.github/workflows/.test.yml` | modify |

---

## rollback plan

if shard implementation causes issues:

1. delete config files (`jest.*.shards.jsonc`)
2. composite action outputs `enabled=false`
3. dual-purpose jobs fall back to direct test execution
4. **no workflow rollback needed** — backwards compatible by design
