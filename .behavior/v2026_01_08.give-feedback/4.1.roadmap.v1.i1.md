# roadmap: give.feedback

## overview

execution checklist for `.behavior/v2026_01_08.give-feedback/3.3.blueprint.v1.i1.md`

**dependencies flow**:
```
phase.0 → phase.1 → phase.2 → phase.3 → phase.4 → phase.5 → phase.6
objects    leaf      compose    cli       skill     integ     acpt
           ops       ops                            tests     tests
```

---

## phase.0 = domain.objects

### 0.1 create BehaviorArtifact

- [ ] create `src/domain.objects/BehaviorArtifact.ts`
- [ ] create `src/domain.objects/BehaviorArtifact.test.ts`
- [ ] verify: `npm run test:unit -- BehaviorArtifact.test.ts`

**acceptance criteria**:
- instantiation with all fields (path, name, version, attempt, filename)
- unique key is `path`
- extends DomainLiteral

**verification**:
```sh
npm run test:unit -- BehaviorArtifact.test.ts
# expect: 2 tests pass (instantiation, unique key)
```

### 0.2 create BehaviorFeedback

**depends on**: 0.1

- [ ] create `src/domain.objects/BehaviorFeedback.ts`
- [ ] create `src/domain.objects/BehaviorFeedback.test.ts`
- [ ] verify: `npm run test:unit -- BehaviorFeedback.test.ts`

**acceptance criteria**:
- instantiation with RefByUnique against BehaviorArtifact
- unique key is `path`
- extends DomainLiteral

**verification**:
```sh
npm run test:unit -- BehaviorFeedback.test.ts
# expect: 2 tests pass (instantiation, unique key)
```

### phase.0 gate

- [ ] all domain.objects tests pass
- [ ] verify: `npm run test:unit -- domain.objects`

---

## phase.1 = domain.operations (leaf operations)

### 1.1 create computeBehaviorFeedbackName

- [ ] create `src/domain.operations/behavior/feedback/computeBehaviorFeedbackName.ts`
- [ ] create `src/domain.operations/behavior/feedback/computeBehaviorFeedbackName.test.ts`
- [ ] verify: `npm run test:unit -- computeBehaviorFeedbackName.test.ts`

**acceptance criteria**:
- appends `.[feedback].v${version}.[given].by_human.md` to artifact filename
- handles execution with version/attempt: `5.1.execution.phase0.v1.i1.md` → `....[feedback].v1.[given].by_human.md`
- handles criteria without version: `2.criteria.blackbox.md` → `....[feedback].v1.[given].by_human.md`
- handles wish without version: `0.wish.md` → `....[feedback].v1.[given].by_human.md`
- handles feedback v2: `0.wish.md` with version=2 → `....[feedback].v2.[given].by_human.md`

**verification**:
```sh
npm run test:unit -- computeBehaviorFeedbackName.test.ts
# expect: 4 tests pass (one per case in blueprint table)
```

### 1.2 create getLatestArtifactByName

- [ ] create `src/domain.operations/behavior/feedback/getLatestArtifactByName.ts`
- [ ] create `src/domain.operations/behavior/feedback/getLatestArtifactByName.test.ts`
- [ ] verify: `npm run test:unit -- getLatestArtifactByName.test.ts`

**acceptance criteria**:
- globs for `*.<artifactName>*.md` in behaviorDir
- excludes files with `[feedback]` in name
- excludes `.src` files (only `.md`)
- parses version (vX) and attempt (iX) from filenames
- sorts by version desc, then attempt desc
- returns first (latest) or null if none

**verification**:
```sh
npm run test:unit -- getLatestArtifactByName.test.ts
# expect: 7 tests pass (one per case in blueprint table)
# cases: single, multi-version, multi-attempt, excludes-feedback, criteria-subtype, no-version, no-match
```

### 1.3 create initFeedbackTemplate

- [ ] create `src/domain.operations/behavior/feedback/initFeedbackTemplate.ts`
- [ ] create `src/domain.operations/behavior/feedback/initFeedbackTemplate.test.ts`
- [ ] verify: `npm run test:unit -- initFeedbackTemplate.test.ts`

**acceptance criteria**:
- reads template content from templatePath
- replaces `$BEHAVIOR_REF_NAME` with artifactFileName
- replaces `$BEHAVIOR_DIR_REL` with behaviorDirRel
- writes to targetPath

**verification**:
```sh
npm run test:unit -- initFeedbackTemplate.test.ts
# expect: 3 tests pass (ref replace, dir replace, both replace)
```

### phase.1 gate

- [ ] all leaf operation tests pass
- [ ] verify: `npm run test:unit -- src/domain.operations/behavior/feedback`

---

## phase.2 = domain.operations (compose operations)

### 2.1 create getBehaviorDirForFeedback

**depends on**: phase.1 (uses internal deps: getBranchBehaviorBind, getBehaviorDir, getCurrentBranch)

- [ ] create `src/domain.operations/behavior/feedback/getBehaviorDirForFeedback.ts`
- [ ] create `src/domain.operations/behavior/feedback/getBehaviorDirForFeedback.test.ts`
- [ ] verify: `npm run test:unit -- getBehaviorDirForFeedback.test.ts`

**acceptance criteria**:
- bound + no flag → returns bind
- bound + flag matches → returns bind
- bound + flag differs + no force → throws
- bound + flag differs + force → returns flag
- not bound + flag → returns flag
- not bound + no flag → throws
- flag not found → throws (from getBehaviorDir)
- flag ambiguous → throws (from getBehaviorDir)

**verification**:
```sh
npm run test:unit -- getBehaviorDirForFeedback.test.ts
# expect: 8 tests pass (one per case in blueprint table)
```

### 2.2 create giveFeedback

**depends on**: 2.1, 1.1, 1.2, 1.3

- [ ] create `src/domain.operations/behavior/feedback/giveFeedback.ts`
- [ ] create `src/domain.operations/behavior/feedback/giveFeedback.test.ts`
- [ ] verify: `npm run test:unit -- giveFeedback.test.ts`

**acceptance criteria**:
- creates feedback for execution artifact
- creates feedback for criteria.blackbox
- creates feedback for wish
- respects --version flag
- uses custom --template
- fails if artifact not found (with pattern shown)
- fails if feedback file already present (with "already exists")
- fails if template not found (with "template not found")

**verification**:
```sh
npm run test:unit -- giveFeedback.test.ts
# expect: 8 tests pass (one per case in blueprint table)
```

### phase.2 gate

- [ ] all compose operation tests pass
- [ ] verify: `npm run test:unit -- src/domain.operations/behavior/feedback`

---

## phase.3 = contract/cli

### 3.1 create give.feedback.ts CLI entry point

**depends on**: phase.2

- [ ] create `src/contract/cli/give.feedback.ts`
- [ ] implement Zod schema with: against, behavior, version, template, force, rhachet passthrough
- [ ] implement CLI: parse args, call giveFeedback, log result

**acceptance criteria**:
- parses --against (required)
- parses --behavior (optional)
- parses --version (optional, coerced to number)
- parses --template (optional)
- parses --force (optional boolean)
- ignores rhachet passthrough args (repo, role, skill, s)
- logs feedback file path and target artifact on success

**verification**:
```sh
npm run test:types
# expect: no type errors in give.feedback.ts
```

### 3.2 export from index.ts

**depends on**: 3.1

- [ ] add import of giveFeedback from contract/cli
- [ ] add giveFeedback to cli export object

**acceptance criteria**:
- `import('rhachet-roles-bhuild').then(m => m.cli.giveFeedback)` resolves to function

**verification**:
```sh
npm run build
# expect: builds successfully with giveFeedback in exports
```

### phase.3 gate

- [ ] CLI module compiles without errors
- [ ] verify: `npm run test:types && npm run build`

---

## phase.4 = domain.roles skill

### 4.1 create give.feedback.sh

**depends on**: phase.3

- [ ] create `src/domain.roles/behaver/skills/give.feedback.sh`
- [ ] make executable: `chmod +x`
- [ ] implement: thin dispatcher to TypeScript via package export

**acceptance criteria**:
- shebang: `#!/usr/bin/env bash`
- set -euo pipefail
- dispatches via: `exec npx tsx -e "import('rhachet-roles-bhuild').then(m => m.cli.giveFeedback())" -- "$@"`
- header documents all args, examples, outputs, errors

**verification**:
```sh
# manual smoke test from repo root
./src/domain.roles/behaver/skills/give.feedback.sh --help 2>&1 || true
# expect: no "command not found" or syntax errors
```

### phase.4 gate

- [ ] skill command is executable
- [ ] verify: `ls -la src/domain.roles/behaver/skills/give.feedback.sh | grep -q 'x'`

---

## phase.5 = integration tests

### 5.1 giveFeedback operation integration test

**depends on**: phase.4

- [ ] create `src/domain.operations/behavior/feedback/giveFeedback.integration.test.ts`
- [ ] implement test cases with temp git repos (genTestGitRepo, genBehaviorFixture)

**acceptance criteria**:
- [case1] behavior with execution artifact:
  - [t0] feedback file is created
  - [t0] $BEHAVIOR_REF_NAME is replaced in content
  - [t0] $BEHAVIOR_DIR_REL is replaced in content
  - [t1] second invocation throws "already exists"
  - [t2] --version 2 creates v2 feedback file
- [case2] behavior with multiple artifact versions:
  - [t0] targets latest version (v2.i1)
  - [t0] feedback filename references v2.i1
- [case3] behavior without template:
  - [t0] throws "template not found"

**verification**:
```sh
npm run test:integration -- giveFeedback.integration.test.ts
# expect: 8 tests pass
```

### phase.5 gate

- [ ] all integration tests pass
- [ ] verify: `npm run test:integration -- giveFeedback.integration.test.ts`

---

## phase.6 = acceptance tests

### 6.1 symmetric skill invocation helpers

**depends on**: phase.5

- [ ] rename `blackbox/.test/infra/runRhachetSkill.ts` → `runSkillViaRhachetRun.ts`
- [ ] rename function: `runRhachetSkill` → `runSkillViaRhachetRun`
- [ ] rename type: `SkillResult` → `SkillRunResult`
- [ ] create `blackbox/.test/infra/runSkillViaDirectExec.ts`
- [ ] update `blackbox/.test/infra/index.ts` with new exports

**acceptance criteria**:
- runSkillViaRhachetRun invokes skill via `npx rhachet run`
- runSkillViaDirectExec invokes skill via direct bash spawn
- both return { stdout, exitCode } or { output, exitCode }

**verification**:
```sh
npm run test:types
# expect: no type errors in blackbox/.test/infra/
```

### 6.2 extend genBehaviorFixture

**depends on**: 6.1

- [ ] add `withFeedbackTemplate?: boolean` option
- [ ] add `withArtifacts?: string[]` option
- [ ] implement: create template file when withFeedbackTemplate=true
- [ ] implement: create artifact files from withArtifacts array

**acceptance criteria**:
- `withFeedbackTemplate: true` creates `.ref.[feedback].v1.[given].by_human.md`
- `withArtifacts: ['0.wish.md', '5.1.execution.v1.i1.md']` creates those files

**verification**:
```sh
npm run test:types
# expect: no type errors in genBehaviorFixture.ts
```

### 6.3 blackbox acceptance tests

**depends on**: 6.2

- [ ] create `blackbox/role=behaver/skill.give.feedback.acceptance.test.ts`
- [ ] implement consumer invocation tests (via rhachet)
- [ ] implement direct invocation tests (via bash spawn)

**acceptance criteria**:
- [case1] consumer: behavior with execution artifact
  - [t0] exits 0, creates feedback, confirms output
  - [t1] --version 2 creates v2 after v1
- [case2] consumer: artifact not found → exit non-zero, output mentions "no artifact"
- [case3] consumer: feedback file already present → exit non-zero, output mentions "already exists"
- [case4] direct: placeholders replaced in created file
- [case5] direct: selects latest artifact version (v2.i1)
- [case6] direct: template not found → fails with helpful error
- [case7] direct: artifact name pattern match (criteria.blackbox vs blueprint, research.domain vs claims)

**verification**:
```sh
npm run test:acceptance -- skill.give.feedback.acceptance.test.ts
# expect: all tests pass (see criteria coverage table in blueprint)
```

### phase.6 gate

- [ ] all acceptance tests pass
- [ ] verify: `npm run test:acceptance -- skill.give.feedback.acceptance.test.ts`

---

## final gate

- [ ] `npm run test:types` passes
- [ ] `npm run test:lint` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run test:integration -- giveFeedback` passes
- [ ] `npm run test:acceptance -- give.feedback` passes
- [ ] `npm run build` succeeds

**full verification**:
```sh
npm run test:types && \
npm run test:lint && \
npm run test:unit && \
npm run test:integration -- giveFeedback && \
npm run test:acceptance -- give.feedback && \
npm run build
# expect: all pass, build succeeds
```

---

## criteria coverage matrix

| criteria section | roadmap step | verification |
|------------------|--------------|--------------|
| usecase.1: resolve behavior directory | 2.1 | unit tests for 8 bind/flag cases |
| usecase.2: generate feedback file | 2.2, 5.1, 6.3 | unit, integration, acceptance |
| usecase.2: placeholder replace | 1.3, 5.1, 6.3 case4 | unit, integration, acceptance |
| usecase.2: --version flag | 2.2, 5.1 t2, 6.3 case1 t1 | unit, integration, acceptance |
| usecase.2: latest artifact | 1.2, 5.1 case2, 6.3 case5 | unit, integration, acceptance |
| usecase.3: artifact name pattern | 1.2, 6.3 case7 | unit, acceptance |
| usecase.4: template selection | 1.3, 2.2, 6.3 case6 | unit, acceptance |
| usecase.5: artifact not found | 2.2, 6.3 case2 | unit, acceptance |
| usecase.5: feedback file already present | 2.2, 5.1 t1, 6.3 case3 | unit, integration, acceptance |
| usecase.6: idempotency | 5.1 t1-t2, 6.3 case1 t1 | integration, acceptance |
