# research: test codepath patterns for give.feedback tune (v1)

## summary

| pattern | file | action | rationale |
|---------|------|--------|-----------|
| bdd integration | `giveFeedback.integration.test.ts` | **[REUSE]** | given/when/then with useBeforeAll |
| parametrized unit | `flattenBranchName.test.ts` | **[REUSE]** | TEST_CASES data-driven pattern |
| unit setup/teardown | `giveFeedback.test.ts` | **[REUSE]** | setupTestRepo + afterEach cleanup |
| error assertion | `openFileWithOpener.integration.test.ts` | **[REUSE]** | getError from test-fns |
| skill invocation | `invokeReviewBehaviorSkill.ts` | **[EXTEND]** | add invokeGiveFeedbackSkill |

---

## 1. bdd integration test pattern

**file**: `src/domain.operations/behavior/feedback/giveFeedback.integration.test.ts`

**action**: **[REUSE]**

**quote** [1]:
```typescript
import { given, then, useBeforeAll, when } from 'test-fns';

describe('giveFeedback.integration', () => {
  given('[case1] behavior with execution artifact', () => {
    const testDir = path.join(os.tmpdir(), 'giveFeedback-int-case1');

    const scene = useBeforeAll(async () => {
      // clean and setup test repo
      fs.rmSync(testDir, { recursive: true, force: true });
      fs.mkdirSync(testDir, { recursive: true });

      // init git repo
      execSync('git init', { cwd: testDir });
      // ...
      return { testDir, behaviorDir };
    });

    afterAll(() => {
      fs.rmSync(testDir, { recursive: true, force: true });
    });

    when('[t0] giveFeedback invoked for execution artifact', () => {
      then('feedback file is created with placeholders replaced', () => {
        const result = giveFeedback(
          { against: 'execution', behavior: 'test-feature' },
          { cwd: scene.testDir },
        );
        expect(fs.existsSync(result.feedbackFile)).toBe(true);
      });
    });
  });
});
```

**relation to wish**: tests for --talk mode, findsert behavior, and tree output require this pattern:
- `[case1]` for repl mode tests
- `[case2]` for findsert idempotent tests
- `scene = useBeforeAll(...)` for shared test repo setup

---

## 2. parametrized unit test pattern

**file**: `src/domain.operations/behavior/bind/flattenBranchName.test.ts`

**action**: **[REUSE]**

**quote** [2]:
```typescript
const TEST_CASES = [
  {
    description: 'replaces forward slashes with dots',
    given: { branchName: 'vlad/dispatch-behavior-hooks' },
    expect: { output: 'vlad.dispatch-behavior-hooks' },
  },
  {
    description: 'handles multiple nested slashes',
    given: { branchName: 'feature/epic/task/subtask' },
    expect: { output: 'feature.epic.task.subtask' },
  },
];

describe('flattenBranchName', () => {
  TEST_CASES.map((thisCase) =>
    test(thisCase.description, () => {
      const output = flattenBranchName(thisCase.given);
      expect(output).toEqual(thisCase.expect.output);
    }),
  );
});
```

**relation to wish**: unit tests for tree output computation, severity toggle, and header format can use this pattern:
- `computeOutputTree` output format cases
- `computeFeedbackHeader` severity/index cases

---

## 3. unit test setup/teardown pattern

**file**: `src/domain.operations/behavior/feedback/giveFeedback.test.ts`

**action**: **[REUSE]**

**quote** [3]:
```typescript
describe('giveFeedback', () => {
  let testDir: string;
  let behaviorDir: string;

  const setupTestRepo = () => {
    testDir = mkdtempSync(join(tmpdir(), 'give-feedback-test-'));

    // init git repo
    execSync('git init', { cwd: testDir });
    execSync('git config user.email "test@test.com"', { cwd: testDir });
    execSync('git config user.name "Test"', { cwd: testDir });
    writeFileSync(join(testDir, 'README.md'), '# test');
    execSync('git add . && git commit -m "init"', { cwd: testDir });

    // create behavior directory
    behaviorDir = join(testDir, '.behavior/v2025_01_01.test-feature');
    mkdirSync(behaviorDir, { recursive: true });
  };

  afterEach(() => {
    if (testDir) rmSync(testDir, { recursive: true, force: true });
  });

  test('creates feedback for execution artifact', () => {
    setupTestRepo();
    writeFileSync(join(behaviorDir, '5.1.execution.v1.i1.md'), '# execution');

    const result = giveFeedback(
      { against: 'execution', behavior: 'test-feature' },
      { cwd: testDir },
    );

    expect(existsSync(result.feedbackFile)).toBe(true);
  });
});
```

**relation to wish**: unit tests for findsert behavior and file mutation need this pattern:
- temp dir per test
- git repo init for realistic context
- cleanup in afterEach

---

## 4. error assertion pattern

**file**: `src/infra/shell/openFileWithOpener.integration.test.ts`

**action**: **[REUSE]**

**quote** [4]:
```typescript
import { getError, given, then, when } from 'test-fns';

given('opener is nonexistent command', () => {
  when('openFileWithOpener is called', () => {
    then('throws OpenerUnavailableError', async () => {
      const error = await getError(async () =>
        openFileWithOpener({
          opener: 'nonexistent-cmd-xyz-12345',
          filePath: testFile,
        }),
      );
      expect(error).toBeInstanceOf(OpenerUnavailableError);
    });

    then('error message contains opener name', async () => {
      const error = await getError(async () =>
        openFileWithOpener({
          opener: 'nonexistent-cmd-xyz-12345',
          filePath: testFile,
        }),
      );
      expect(error.message).toContain('nonexistent-cmd-xyz-12345');
    });
  });
});
```

**relation to wish**: tests for error cases need this pattern:
- artifact not found error
- template not found error
- `getError()` from test-fns for clean error capture

---

## 5. skill invocation utility pattern

**file**: `src/.test/utils/invokeReviewBehaviorSkill.ts`

**action**: **[EXTEND]**

**quote** [5]:
```typescript
const SCRIPT_PATH = path.join(
  __dirname,
  '../../domain.roles/decomposer/skills/review.behavior.sh',
);

/**
 * .what = invokes review.behavior.sh via subshell
 * .why = reusable test utility for skill invocation
 */
export const invokeReviewBehaviorSkill = (input: {
  behaviorName: string;
  dir: string;
}): { stdout: string; exitCode: number } => {
  try {
    const stdout = execSync(
      `bash "${SCRIPT_PATH}" --of "${input.behaviorName}" --dir "${input.dir}"`,
      { /* utf-8 charset */ },
    );
    return { stdout, exitCode: 0 };
  } catch (err: unknown) {
    const error = err as { stdout?: string; status?: number };
    return {
      stdout: error.stdout ?? '',
      exitCode: error.status ?? 1,
    };
  }
};
```

**relation to wish**: create new `invokeGiveFeedbackSkill.ts` that follows this pattern:
- invoke give.feedback skill via subshell
- capture stdout for tree output verification
- capture exitCode for error cases

---

## 6. idempotent behavior test pattern

**file**: `src/domain.operations/behavior/feedback/giveFeedback.integration.test.ts`

**action**: **[EXTEND]**

**quote** [6]:
```typescript
when('[t1] giveFeedback invoked second time for same artifact', () => {
  then('throws error about file already present', () => {
    // ensure feedback file exists from prior test
    const behaviorDir = path.join(
      scene.testDir,
      '.behavior/v2025_01_01.test-feature',
    );
    const feedbackPath = path.join(
      behaviorDir,
      '5.1.execution.v1.i1.md.[feedback].v1.[given].by_human.md',
    );
    if (!fs.existsSync(feedbackPath)) {
      giveFeedback(
        { against: 'execution', behavior: 'test-feature' },
        { cwd: scene.testDir },
      );
    }

    expect(() =>
      giveFeedback(
        { against: 'execution', behavior: 'test-feature' },
        { cwd: scene.testDir },
      ),
    ).toThrow(/already exists/);
  });
});
```

**relation to wish**: current test expects throw on duplicate. need to extend for findsert behavior:
- change assertion from `toThrow(/already exists/)` to expect findsert return
- add test for output message "already exists"
- add test for --version tip in output

---

## implementation notes

### tests to add for open mode

| test case | pattern | description |
|-----------|---------|-------------|
| output format | parametrized | tree output with emoji header |
| findsert new | bdd integration | file created, output shows "created" |
| findsert found | bdd integration | file found, output shows "already exists" |
| --open flag | bdd integration | verify "opened in codium" in output |
| --open tip | bdd integration | verify tip when --open not used |
| error glob | bdd integration | verify error shows glob pattern |

### tests to add for --talk repl mode

| test case | pattern | description |
|-----------|---------|-------------|
| repl startup | bdd integration | verify repl starts with blocker default |
| severity toggle | unit | shift+tab toggles blocker/nitpick |
| multiline input | unit | shift+enter inserts newline |
| file mutation | bdd integration | submit mutates file in realtime |
| change log | bdd integration | changes appended to .log/changes.jsonl |
| undo/redo | bdd integration | ctrl-z restores prior content |
| footer update | unit | footer shows next header number |
| exit summary | bdd integration | ctrl-c shows summary of feedback added |

### new test utilities needed

| utility | purpose |
|---------|---------|
| `invokeGiveFeedbackSkill.ts` | invoke skill via subshell |
| `genTestFeedbackRepo.ts` | create test repo with feedback template |

---

## citations

[1] src/domain.operations/behavior/feedback/giveFeedback.integration.test.ts
[2] src/domain.operations/behavior/bind/flattenBranchName.test.ts
[3] src/domain.operations/behavior/feedback/giveFeedback.test.ts
[4] src/infra/shell/openFileWithOpener.integration.test.ts
[5] src/.test/utils/invokeReviewBehaviorSkill.ts
[6] src/domain.operations/behavior/feedback/giveFeedback.integration.test.ts (idempotent case)
