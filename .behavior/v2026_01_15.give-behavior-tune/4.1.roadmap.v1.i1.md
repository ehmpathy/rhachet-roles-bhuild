# roadmap: give.feedback tune (v1)

## overview

this roadmap implements the blueprint in 3 phases:
1. **phase 0: open mode tune** â€” findsert semantics, tree output, --open flag
2. **phase 1: repl mode core** â€” --talk flag, severity toggle, submit, file mutation
3. **phase 2: repl mode advanced** â€” undo/redo, history nav, change log

each step includes:
- [ ] checkbox for completion
- acceptance criteria in given/when/then format
- verification command to prove completion

---

## phase 0: open mode tune

### step 0.1: change giveFeedback to findsert semantics

- [ ] complete
- depends on: none

**files to modify:**
- `src/domain.operations/behavior/feedback/giveFeedback.ts`

**acceptance criteria:**
```
given('a user runs give.feedback')
  when('feedback file already exists')
    then('output says "already exists" with relative path')
    then('file is not overwritten')
    then('no error is thrown')
```

**verification:**
```sh
npm run test:unit -- giveFeedback.test.ts
```

---

### step 0.2: add computeOutputTree for feedback output

- [ ] complete
- depends on: step 0.1

**files to create:**
- `src/domain.operations/behavior/feedback/computeFeedbackOutputTree.ts`
- `src/domain.operations/behavior/feedback/computeFeedbackOutputTree.test.ts`

**acceptance criteria:**
```
given('feedback operation result')
  when('file was created')
    then('output tree shows "ðŸ¦« wassup?" header')
    then('output tree shows relative path with "+" symbol')
  when('file was found (prior)')
    then('output tree shows "âœ“" symbol')
    then('output tree shows "already exists" message')
```

**verification:**
```sh
npm run test:unit -- computeFeedbackOutputTree.test.ts
```

---

### step 0.3: add --open flag support

- [ ] complete
- depends on: step 0.2

**files to modify:**
- `src/domain.operations/behavior/feedback/giveFeedback.ts`
- `src/domain.roles/behaver/skills/give.feedback.sh`

**acceptance criteria:**
```
given('a user runs give.feedback --open codium')
  when('feedback is created successfully')
    then('feedback file opens in codium editor')
    then('output shows "opened in codium" as the action taken')

given('a user runs give.feedback without --open flag')
  when('feedback is created successfully')
    then('output shows tip about --open option')
```

**verification:**
```sh
npm run test:integration -- giveFeedback.integration.test.ts
```

---

### step 0.4: add --version tip for findsert case

- [ ] complete
- depends on: step 0.3

**files to modify:**
- `src/domain.operations/behavior/feedback/computeFeedbackOutputTree.ts`

**acceptance criteria:**
```
given('a user runs give.feedback')
  when('feedback file already exists')
    then('output shows tip about --version flag for new version creation')
```

**verification:**
```sh
npm run test:unit -- computeFeedbackOutputTree.test.ts
```

---

### step 0.5: integration test for open mode

- [ ] complete
- depends on: step 0.4

**files to modify:**
- `src/domain.operations/behavior/feedback/giveFeedback.integration.test.ts`

**acceptance criteria:**
```
given('[case1] behavior with execution artifact')
  when('[t0] giveFeedback invoked first time')
    then('feedback file is created')
    then('output shows tree format with "+" symbol')
  when('[t1] giveFeedback invoked second time')
    then('output says "already exists"')
    then('output shows tip about --version flag')
    then('file is not overwritten')
```

**verification:**
```sh
npm run test:integration -- giveFeedback.integration.test.ts
```

---

### phase 0 checkpoint

- [ ] all open mode tests pass

**verification:**
```sh
npm run test:unit -- giveFeedback
npm run test:integration -- giveFeedback
```

---

## phase 1: repl mode core

### step 1.1: add useFeedbackState hook

- [ ] complete
- depends on: phase 0 checkpoint

**files to create:**
- `src/domain.operations/behavior/feedback/repl/useFeedbackState.ts`
- `src/domain.operations/behavior/feedback/repl/useFeedbackState.test.ts`

**acceptance criteria:**
```
given('useFeedbackState hook')
  when('initialized')
    then('severity defaults to "blocker"')
    then('feedbackIndex starts at 1')
  when('toggleSeverity called')
    then('severity toggles between "blocker" and "nitpick"')
  when('submit called with text')
    then('feedbackIndex increments')
    then('input clears')
```

**verification:**
```sh
npm run test:unit -- useFeedbackState.test.ts
```

---

### step 1.2: add FeedbackRepl component scaffold

- [ ] complete
- depends on: step 1.1

**files to create:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.test.tsx`

**acceptance criteria:**
```
given('FeedbackRepl component')
  when('rendered')
    then('shows input area')
    then('shows footer with severity and index')
    then('footer shows "# blocker.1 >" initially')
```

**verification:**
```sh
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 1.3: add shift+tab severity toggle

- [ ] complete
- depends on: step 1.2

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.test.tsx`

**acceptance criteria:**
```
given('a user is in repl mode')
  when('user presses shift+tab')
    then('severity toggles between "blocker" and "nitpick"')
    then('severity indicator updates visually')
    then('footer shows updated header (e.g., "# nitpick.1 >")')
```

**verification:**
```sh
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 1.4: add multiline input support

- [ ] complete
- depends on: step 1.3

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`

**acceptance criteria:**
```
given('a user is in repl mode')
  when('user types text')
    then('multiline input is supported inline')
  when('user presses shift+enter')
    then('newline is inserted instead of submit')
  when('user presses alt+enter')
    then('newline is inserted instead of submit')
```

**verification:**
```sh
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 1.5: add computeFeedbackBlockContent

- [ ] complete
- depends on: step 1.4

**files to create:**
- `src/domain.operations/behavior/feedback/repl/computeFeedbackBlockContent.ts`
- `src/domain.operations/behavior/feedback/repl/computeFeedbackBlockContent.test.ts`

**acceptance criteria:**
```
given('feedback text and metadata')
  when('computeFeedbackBlockContent called')
    then('output has "---" delimiter before')
    then('output has "# {severity}.{index}" header')
    then('output has feedback text after header')
    then('output has "---" delimiter after')
```

**verification:**
```sh
npm run test:unit -- computeFeedbackBlockContent.test.ts
```

---

### step 1.6: add file mutation on submit

- [ ] complete
- depends on: step 1.5

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`

**files to create:**
- `src/domain.operations/behavior/feedback/repl/appendFeedbackBlock.ts`
- `src/domain.operations/behavior/feedback/repl/appendFeedbackBlock.test.ts`

**acceptance criteria:**
```
given('a user is in repl mode with feedback text entered')
  when('user presses enter')
    then('feedback file is mutated with "# blocker.N" or "# nitpick.N" block')
    then('N increments from shared counter across both severities')
    then('input area clears for next feedback')
    then('confirmation shows the header that was written')
```

**verification:**
```sh
npm run test:unit -- appendFeedbackBlock.test.ts
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 1.7: add --talk flag to skill

- [ ] complete
- depends on: step 1.6

**files to modify:**
- `src/domain.roles/behaver/skills/give.feedback.sh`
- `src/contract/cli/giveFeedback.ts`

**acceptance criteria:**
```
given('a user runs give.feedback --talk --against execution')
  when('command is invoked')
    then('repl mode starts with severity defaulted to "blocker"')
    then('repl displays current severity indicator')
```

**verification:**
```sh
npm run test:integration -- giveFeedback.integration.test.ts
```

---

### step 1.8: add ctrl+c exit behavior

- [ ] complete
- depends on: step 1.7

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`

**acceptance criteria:**
```
given('a user is in repl mode with empty input')
  when('user presses ctrl+c')
    then('repl mode exits gracefully')
    then('summary of feedback added is shown')

given('a user is in repl mode with feedback text entered but not yet submitted')
  when('user presses ctrl+c')
    then('current input buffer is cleared')
    then('hint shows "ctrl-z to restore" after clear')
```

**verification:**
```sh
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### phase 1 checkpoint

- [ ] all repl core tests pass

**verification:**
```sh
npm run test:unit -- repl/
npm run test:integration -- giveFeedback.integration.test.ts
```

---

## phase 2: repl mode advanced

### step 2.1: add change log infrastructure

- [ ] complete
- depends on: phase 1 checkpoint

**files to create:**
- `src/domain.operations/behavior/feedback/repl/appendChangeLog.ts`
- `src/domain.operations/behavior/feedback/repl/appendChangeLog.test.ts`

**acceptance criteria:**
```
given('a user submits or modifies feedback')
  when('file mutation occurs')
    then('change event is appended to .log/changes.jsonl in behavior dir')
    then('change event contains { index, severity, before, after }')
```

**verification:**
```sh
npm run test:unit -- appendChangeLog.test.ts
```

---

### step 2.2: add undo support (ctrl+z)

- [ ] complete
- depends on: step 2.1

**files to create:**
- `src/domain.operations/behavior/feedback/repl/undoLastChange.ts`
- `src/domain.operations/behavior/feedback/repl/undoLastChange.test.ts`

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`

**acceptance criteria:**
```
given('a user wants to undo a change')
  when('user presses ctrl-z after submit')
    then('prior content is restored from change log')
    then('undo confirmation shows what was restored')
```

**verification:**
```sh
npm run test:unit -- undoLastChange.test.ts
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 2.3: add redo support (ctrl+shift+z / ctrl+y)

- [ ] complete
- depends on: step 2.2

**files to create:**
- `src/domain.operations/behavior/feedback/repl/redoLastUndo.ts`
- `src/domain.operations/behavior/feedback/repl/redoLastUndo.test.ts`

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`

**acceptance criteria:**
```
given('a user wants to redo after undo')
  when('user presses ctrl-shift-z or ctrl-y after undo')
    then('undone content is reapplied')
```

**verification:**
```sh
npm run test:unit -- redoLastUndo.test.ts
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 2.4: add input buffer undo (ctrl+z after ctrl+c)

- [ ] complete
- depends on: step 2.3

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`

**acceptance criteria:**
```
given('a user just pressed ctrl-c to clear input buffer')
  when('user presses ctrl-z')
    then('cleared input text is restored to buffer')
```

**verification:**
```sh
npm run test:unit -- FeedbackRepl.test.tsx
```

---

### step 2.5: add history navigation (up/down arrows)

- [ ] complete
- depends on: step 2.4

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/FeedbackRepl.tsx`
- `src/domain.operations/behavior/feedback/repl/useFeedbackState.ts`

**acceptance criteria:**
```
given('a user is in repl mode with empty input')
  when('user presses up arrow')
    then('previous feedback text is loaded into input')

given('a user is in repl mode that shows previous feedback')
  when('user presses down arrow')
    then('next feedback in history is shown, or input clears if at end')
```

**verification:**
```sh
npm run test:unit -- FeedbackRepl.test.tsx
npm run test:unit -- useFeedbackState.test.ts
```

---

### step 2.6: add upsert semantics for duplicate headers

- [ ] complete
- depends on: step 2.5

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/appendFeedbackBlock.ts`

**acceptance criteria:**
```
given('a user submits feedback for a header that already exists')
  when('user presses enter')
    then('prior block content is replaced (upsert semantics)')
```

**verification:**
```sh
npm run test:unit -- appendFeedbackBlock.test.ts
```

---

### step 2.7: add repl startup with prior feedback

- [ ] complete
- depends on: step 2.6

**files to modify:**
- `src/domain.operations/behavior/feedback/repl/useFeedbackState.ts`

**acceptance criteria:**
```
given('a user runs --talk against an artifact with prior feedback file')
  when('repl mode starts')
    then('prompt shows next number based on prior items')
    then('repl shows count of prior feedback items')
```

**verification:**
```sh
npm run test:unit -- useFeedbackState.test.ts
npm run test:integration -- giveFeedback.integration.test.ts
```

---

### phase 2 checkpoint

- [ ] all repl advanced tests pass

**verification:**
```sh
npm run test:unit -- repl/
npm run test:integration -- giveFeedback.integration.test.ts
```

---

## final verification

### all tests pass

- [ ] complete

**verification:**
```sh
npm run test:types
npm run test:lint
npm run test:unit
npm run test:integration
```

---

### manual smoke test

- [ ] complete

**verification:**
```sh
# open mode
npm run build && npx rhachet roles link --role behaver && npx rhachet run --skill give.feedback --against execution --behavior give-behavior-tune

# open mode with --open
npm run build && npx rhachet roles link --role behaver && npx rhachet run --skill give.feedback --against execution --behavior give-behavior-tune --open codium

# repl mode
npm run build && npx rhachet roles link --role behaver && npx rhachet run --skill give.feedback --against execution --behavior give-behavior-tune --talk
```

---

## citations

- [blackbox criteria] .behavior/v2026_01_15.give-behavior-tune/2.criteria.blackbox.md
- [blueprint] .behavior/v2026_01_15.give-behavior-tune/3.3.blueprint.v1.i1.md
- [wish] .behavior/v2026_01_15.give-behavior-tune/0.wish.md
