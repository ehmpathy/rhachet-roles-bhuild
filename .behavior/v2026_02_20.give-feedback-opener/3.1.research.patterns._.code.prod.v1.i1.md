# research: prod code patterns

## pattern.1 = giveFeedback domain operation

**[EXTEND]** â€” needs findsert behavior, --version ++, and latest version detection

### current behavior

```typescript
// cite[1]: src/domain.operations/behavior/feedback/giveFeedback.ts:44-56
const feedbackVersion = input.version ?? 1;
const feedbackFilename = computeBehaviorFeedbackName({
  artifactFileName: artifact.filename,
  feedbackVersion,
});
const feedbackPath = join(behaviorDir, feedbackFilename);

// check if feedback file already exists
if (existsSync(feedbackPath)) {
  throw new BadRequestError(
    `feedback file already exists: ${feedbackFilename}. use --version ${feedbackVersion + 1} to create a new version.`,
  );
}
```

### changes needed

1. default version = latest (not 1)
2. support `++` as version value â†’ compute next version
3. findsert: if file exists, return it instead of throw

---

## pattern.2 = give.feedback CLI entry point

**[EXTEND]** â€” needs --open arg, new output format, version handle

### current behavior

```typescript
// cite[2]: src/contract/cli/give.feedback.ts:49-62
export const giveFeedback = (): void => {
  const { named } = getCliArgs({ schema: schemaOfArgs });

  const result = giveFeedbackOp({
    against: named.against,
    behavior: named.behavior,
    version: named.version,
    template: named.template,
    force: named.force,
  });

  console.log(`âœ“ feedback created: ${result.feedbackFile}`);
  console.log(`  against: ${result.artifactFile}`);
};
```

### changes needed

1. add `--open` to schema
2. validate `--open` not empty (like init.behavior)
3. call `openFileWithOpener` if `--open` provided
4. replace stdout with tree format (`ðŸ¦« wassup?`)
5. show relative filename only, not full path
6. add version tip line

---

## pattern.3 = init.behavior --open handle

**[REUSE]** â€” exact pattern to copy for give.feedback

### empty --open validation

```typescript
// cite[3]: src/contract/cli/init.behavior.ts:54-64
if (named.open !== undefined && named.open.trim() === '') {
  console.error('â›ˆï¸  error: --open requires an editor name');
  console.error('');
  console.error('please specify what editor to open with. for example:');
  console.error('  --open codium');
  console.error('  --open vim');
  console.error('  --open zed');
  console.error('  --open code');
  process.exit(1);
}
```

### opener invocation with error handle

```typescript
// cite[4]: src/contract/cli/init.behavior.ts:121-135
let openerUsed: string | undefined;
if (named.open) {
  try {
    openFileWithOpener({ opener: named.open, filePath: wishPathRel });
    openerUsed = named.open;
  } catch (error) {
    if (error instanceof OpenerUnavailableError) {
      console.log('');
      console.log(`âš ï¸  ${error.message}`);
    } else {
      throw error;
    }
  }
}
```

---

## pattern.4 = computeFooterOutput

**[EXTEND]** â€” similar pattern but different emoji, different content

### current pattern

```typescript
// cite[5]: src/domain.operations/behavior/render/computeFooterOutput.ts:5-25
export const computeFooterOutput = (input: {
  wishPathRel: string;
  opener?: string;
}): string => {
  const dim = '\x1b[2m';
  const reset = '\x1b[0m';

  const lines = [`ðŸŒ² go on then,`, `   â”œâ”€ ${input.wishPathRel}`];

  if (input.opener) {
    lines.push(`   â””â”€ ${dim}opened in ${input.opener}${reset}`);
  } else {
    lines.push(
      `   â””â”€ ${dim}tip: use --open to open the wish automatically${reset}`,
    );
  }

  return lines.join('\n');
};
```

### needed variant

- header: `ðŸ¦« wassup?`
- line 1: `âœ“ {filename}`
- line 2: `tip: use --version ++ to create a new version`
- line 3: opener line or opener tip

---

## pattern.5 = openFileWithOpener infra

**[REUSE]** â€” no changes needed

```typescript
// cite[6]: src/infra/shell/openFileWithOpener.ts:9-25
export const openFileWithOpener = (input: {
  opener: string;
  filePath: string;
}): void => {
  const command = `${input.opener} "${input.filePath}"`;

  try {
    execSync(command, { stdio: 'inherit' });
  } catch (error) {
    throw new OpenerUnavailableError(
      `opener '${input.opener}' unavailable or failed`,
      { cause: error instanceof Error ? error : undefined },
    );
  }
};
```

---

## pattern.6 = OpenerUnavailableError

**[REUSE]** â€” no changes needed

```typescript
// cite[7]: src/infra/shell/OpenerUnavailableError.ts:1-7
import { HelpfulError } from 'helpful-errors';

export class OpenerUnavailableError extends HelpfulError {}
```

---

## pattern.7 = getLatestArtifactByName

**[REUSE]** â€” use same approach for feedback version detection

### version parse pattern

```typescript
// cite[8]: src/domain.operations/behavior/feedback/getLatestArtifactByName.ts:30-31
const versionPattern = /\.v(\d+)/;
const attemptPattern = /\.i(\d+)/;
```

### sort by version desc

```typescript
// cite[9]: src/domain.operations/behavior/feedback/getLatestArtifactByName.ts:69-79
artifactsMatched.sort((a, b) => {
  const vA = a.version ?? -1;
  const vB = b.version ?? -1;
  if (vA !== vB) return vB - vA;

  const iA = a.attempt ?? -1;
  const iB = b.attempt ?? -1;
  return iB - iA;
});
```

---

## pattern.8 = computeBehaviorFeedbackName

**[REUSE]** â€” no changes needed

```typescript
// cite[10]: src/domain.operations/behavior/feedback/computeBehaviorFeedbackName.ts:5-11
export const computeBehaviorFeedbackName = (input: {
  artifactFileName: string;
  feedbackVersion: number;
}): string => {
  return `${input.artifactFileName}.[feedback].v${input.feedbackVersion}.[given].by_human.md`;
};
```

---

## summary

| pattern | disposition | rationale |
|---------|-------------|-----------|
| giveFeedback | EXTEND | add findsert, latest default, ++ support |
| give.feedback CLI | EXTEND | add --open, new output format |
| init.behavior --open | REUSE | copy validation + opener handle |
| computeFooterOutput | EXTEND | create variant for feedback output |
| openFileWithOpener | REUSE | works as-is |
| OpenerUnavailableError | REUSE | works as-is |
| getLatestArtifactByName | REUSE | use version parse approach for feedback |
| computeBehaviorFeedbackName | REUSE | works as-is |
