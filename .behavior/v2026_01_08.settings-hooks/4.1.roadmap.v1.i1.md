# roadmap: settings-hooks pattern upgrade

## overview

this roadmap implements the blueprint at `3.3.blueprint.v1.i1.md` in ordered phases with verification at each step.

---

## phase.0: create test fixtures

### tasks

- [ ] create `src/domain.roles/behaver/inits/.test/assets/` directory
- [ ] create `repo-empty-hooks/` fixture
- [ ] create `repo-stale-hook-ours/` fixture
- [ ] create `repo-stale-hook-other-role/` fixture
- [ ] create `repo-valid-boot-behavior/` fixture
- [ ] create `repo-multiple-matchers/` fixture
- [ ] create `repo-with-bound-behavior/` fixture
- [ ] create `repo-without-bound-behavior/` fixture

### acceptance criteria

```
given('test fixtures created')
  then('each fixture is a valid git repo')
  then('each fixture has .claude/settings.json')
  then('repo-stale-hook-ours has hook authored by repo=bhuild/role=behaver')
  then('repo-stale-hook-other-role has hook authored by repo=other/role=other')
  then('repo-valid-boot-behavior has hook with rhachet run --init pattern')
  then('repo-with-bound-behavior has .behavior/ with .bind/ flag')
```

### verification

```sh
# verify fixtures structure
ls -la src/domain.roles/behaver/inits/.test/assets/
# verify each fixture has required files
for dir in src/domain.roles/behaver/inits/.test/assets/repo-*/; do
  echo "=== $dir ==="
  ls -la "$dir"
  cat "$dir/.claude/settings.json"
done
```

---

## phase.1: update findsert to target settings.json

### depends on

- phase.0 (fixtures needed for tests)

### tasks

- [ ] update `init.claude.hooks.findsert.sh`: change `SETTINGS_FILE` from `settings.local.json` to `settings.json`
- [ ] update author format to `repo=bhuild/role=behaver`
- [ ] create `init.claude.hooks.findsert.integration.test.ts`

### acceptance criteria

```
given('findsert.sh updated')
  when('findsert is called on fresh repo')
    then('creates .claude/settings.json (not settings.local.json)')
  when('findsert is called with hook that already present')
    then('no duplicate hook added')
  when('findsert is called with position=prepend')
    then('hook is first in array')
```

### verification

```sh
npm run build && npm run test:integration -- findsert.integration.test
```

---

## phase.2: create cleanup script

### depends on

- phase.0 (fixtures needed for tests)
- phase.1 (findsert must work for cleanup to be meaningful)

### tasks

- [ ] create `init.claude.hooks.cleanup.sh`
- [ ] implement stale hook detection (command path does not exist)
- [ ] filter by author `repo=bhuild/role=behaver` (preserve hooks from other roles)
- [ ] create `init.claude.hooks.cleanup.integration.test.ts`

### acceptance criteria

```
given('cleanup.sh created')
  when('settings.json has stale hook authored by us')
    then('stale hook is removed')
  when('settings.json has stale hook authored by other role')
    then('hook is preserved (not our responsibility)')
  when('settings.json has valid hook')
    then('hook is preserved')
  when('settings.json has no hooks')
    then('script exits cleanly with no changes')
```

### verification

```sh
npm run build && npm run test:integration -- cleanup.integration.test
```

---

## phase.3: update orchestrator script

### depends on

- phase.1 (findsert must target settings.json)
- phase.2 (cleanup must be available)

### tasks

- [ ] update `init.claude.hooks.sh`: add cleanup call before findsert calls
- [ ] update `init.claude.hooks.sh`: change `--command` to use `rhachet run --init` pattern
- [ ] update `init.claude.hooks.sh`: add tree output for bound hooks
- [ ] create `init.claude.hooks.integration.test.ts`

### acceptance criteria

```
given('orchestrator updated')
  when('rhachet roles init --role behaver runs on fresh repo')
    then('cleanup runs first')
    then('findsert binds sessionstart.boot-behavior hook')
    then('hook command contains "rhachet run --init"')
    then('tree output shows bound hooks')
  when('rhachet roles init runs twice')
    then('second run is idempotent')
    then('output shows "already bound"')
```

### verification

```sh
npm run build && npm run test:integration -- init.claude.hooks.integration.test
```

---

## phase.4: update gitignore

### depends on

- phase.3 (orchestrator must create settings.json)

### tasks

- [ ] ensure `.claude/settings.json` is NOT in `.gitignore` (repo-level, tracked)
- [ ] ensure `.claude/settings.local.json` IS in `.gitignore` (user-level, ignored)

### acceptance criteria

```
given('gitignore updated')
  then('.claude/settings.json is committable')
  then('.claude/settings.local.json is ignored')
```

### verification

```sh
# check gitignore
grep -E 'settings\.(local\.)?json' .gitignore

# verify settings.json would be tracked
echo '{}' > .claude/settings.json
git status .claude/settings.json  # should show as untracked, not ignored
rm .claude/settings.json

# verify settings.local.json would be ignored
echo '{}' > .claude/settings.local.json
git status .claude/settings.local.json  # should show as ignored
rm .claude/settings.local.json
```

---

## phase.5: acceptance tests

### depends on

- phase.3 (full init flow must work)

### tasks

- [ ] create acceptance test: `rhachet roles init binds hooks to settings.json`
- [ ] create acceptance test: `Claude session receives behavior context`
- [ ] create acceptance test: `stale hooks are cleaned on reinit`

### acceptance criteria

```
given('acceptance tests created')
  then('tests run against consumer repo (blackbox)')
  then('tests verify end-to-end flow')
  then('tests pass')
```

### verification

```sh
npm run test:acceptance -- settings-hooks
```

---

## phase.6: final validation

### depends on

- all prior phases

### tasks

- [ ] run full test suite
- [ ] test manually in consumer repo
- [ ] verify behavior session receives boot context

### acceptance criteria

```
given('all phases complete')
  when('npm run test passes')
    then('all unit tests pass')
    then('all integration tests pass')
    then('all acceptance tests pass')
  when('manual test in consumer repo')
    then('rhachet roles init creates settings.json')
    then('hook command contains rhachet run --init')
    then('Claude session shows behavior context')
```

### verification

```sh
# full test suite
npm run test

# manual test
cd /tmp
mkdir test-consumer && cd test-consumer
git init
npm init -y
npm install rhachet-roles-bhuild
npx rhachet roles link --role behaver
npx rhachet roles init --role behaver
cat .claude/settings.json
```

---

## summary

| phase | description | depends on |
|-------|-------------|------------|
| 0 | create test fixtures | none |
| 1 | update findsert to target settings.json | 0 |
| 2 | create cleanup script | 0, 1 |
| 3 | update orchestrator script | 1, 2 |
| 4 | update gitignore | 3 |
| 5 | acceptance tests | 3 |
| 6 | final validation | all |
