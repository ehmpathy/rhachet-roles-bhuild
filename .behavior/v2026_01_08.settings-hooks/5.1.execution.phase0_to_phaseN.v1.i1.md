# execution: settings-hooks pattern upgrade

## status: complete

---

## phase.0: create test fixtures

### tasks

- [x] create `src/domain.roles/behaver/inits/.test/assets/` directory
- [x] create `repo-empty-hooks/` fixture
- [x] create `repo-stale-hook-ours/` fixture
- [x] create `repo-stale-hook-other-role/` fixture
- [x] create `repo-valid-boot-behavior/` fixture
- [x] create `repo-multiple-matchers/` fixture
- [x] create `repo-with-bound-behavior/` fixture
- [x] create `repo-without-bound-behavior/` fixture

### verification

```
✓ tree -a src/domain.roles/behaver/inits/.test/assets/ shows all 7 fixtures
✓ each fixture has .claude/settings.json and README.md
✓ repo-with-bound-behavior has .behavior/ with .bind/ flag
```

---

## phase.1: update findsert to target settings.json

### tasks

- [x] update `init.claude.hooks.findsert.sh`: change `SETTINGS_FILE` from `settings.local.json` to `settings.json`
- [x] update author format to `repo=bhuild/role=behaver` (already correct)
- [x] create `init.claude.hooks.findsert.integration.test.ts`

### verification

```
✓ npm run test:integration -- findsert.integration.test
  ✓ 6 tests passed
```

---

## phase.2: create cleanup script

### tasks

- [x] create `init.claude.hooks.cleanup.sh`
- [x] implement stale hook detection (command path does not exist)
- [x] filter by author `repo=bhuild/role=behaver` (preserve hooks from other roles)
- [x] create `init.claude.hooks.cleanup.integration.test.ts`

### verification

```
✓ npm run test:integration -- cleanup.integration.test
  ✓ 11 tests passed
  ✓ stale hook removal works
  ✓ other roles preserved
  ✓ idempotent rerun
```

---

## phase.3: update orchestrator script

### tasks

- [x] update `init.claude.hooks.sh`: add cleanup call before findsert calls
- [x] update `init.claude.hooks.sh`: change `--command` to use `rhachet run --init` pattern
- [x] update `init.claude.hooks.sh`: add tree output for bound hooks
- [x] create `init.claude.hooks.integration.test.ts`

### verification

```
✓ npm run test:integration -- init.claude.hooks.integration.test
  ✓ 10 tests passed
  ✓ hooks bind correctly
  ✓ idempotent rerun
  ✓ cleanup + bind flow works
  ✓ preserves other roles
```

---

## phase.4: update gitignore

### tasks

- [x] ensure `.claude/settings.json` is NOT in `.gitignore` (repo-level, tracked)
- [x] ensure `.claude/settings.local.json` IS in `.gitignore` (user-level, ignored)

### verification

```
✓ .gitignore updated with explicit claude settings entries
✓ .claude/settings.local.json is ignored
✓ !.claude/settings.json is tracked (negation pattern)
```

---

## phase.5: acceptance tests

### tasks

- [x] create acceptance test: `rhachet roles init binds hooks to settings.json`
- [x] create acceptance test: `hook command uses rhachet run --init pattern`
- [x] create acceptance test: `stale hooks are cleaned on reinit`

### verification

```
✓ npm run test:acceptance -- role.init.acceptance.test
  ✓ 7 tests passed
  ✓ binds hooks to settings.json (repo-level)
  ✓ hook command uses rhachet run --init pattern
  ✓ hook has correct author tag
  ✓ idempotent - second run also succeeds
  ✓ stale hook is cleaned and replaced
```

---

## phase.6: final validation

### tasks

- [x] run full test suite
- [x] test manually in consumer repo (via acceptance tests)
- [x] verify behavior session receives boot context (via acceptance tests)

### verification

```
✓ npm run test:types - passed
✓ npm run test:lint - passed
✓ npm run test:format - passed
✓ npm run test:integration -- findsert - 6 passed
✓ npm run test:integration -- cleanup - 11 passed
✓ npm run test:integration -- init.claude.hooks - 10 passed
✓ npm run test:acceptance -- role.init - 7 passed
✓ total: 34 tests passed
```
