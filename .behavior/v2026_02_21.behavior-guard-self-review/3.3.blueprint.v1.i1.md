# blueprint: behavior-guard-self-review

## summary

add self-review prompts to guard templates in `rhachet-roles-bhuild` via the new `reviews.self` syntax from `rhachet-roles-bhrain`.

the self-review prompts catch common gaps before peer review runs, via structured self-reflection questions.

---

## filediffs

```
src/domain.operations/behavior/init/templates/
├── [~] 3.3.blueprint.v1.guard        # add reviews.self with 3 prompts
├── [+] 5.1.execution.phase0_to_phaseN.v1.guard    # create with reviews.self (2 prompts)
└── [+] 2.1.criteria.blackbox.guard   # create with reviews.self (1 prompt)
```

**legend:**
- `[+] create` — file to create
- `[~] update` — file to update

---

## codepaths

```
guard template evaluation
├── [○] retain: stone.guard parsed by bhrain driver
├── [○] retain: judges executed for pass/fail
├── [+] create: reviews.self prompts for blueprint stone
│   ├── all-done-self: verify criteria + vision coverage
│   ├── all-done-junior: verify against prior work
│   └── all-simple-junior: check for over-complication
├── [+] create: reviews.self prompts for execution stone
│   ├── all-done-self: verify blueprint + criteria completion
│   └── all-done-junior: verify against prior work
└── [+] create: reviews.self prompts for criteria stone
    └── all-real-junior: verify no unquestioned assumptions
```

**legend:**
- `[+] create` — codepath to create
- `[○] retain` — codepath to retain

---

## contracts

### guard file format (reviews.self)

the `reviews.self` section enables structured self-review before peer review runs.

```yaml
reviews:
  self:
    - slug: <identifier>
      say: |
        <multiline prompt>
    - slug: <identifier>
      say: "@briefs/<path>.md"  # or reference external file
  peer:
    - <shell command>
```

### self-review slug semantics

| slug pattern | target | purpose |
|--------------|--------|---------|
| `all-done-self` | blueprint, execution | verify all requirements completed |
| `all-done-junior` | blueprint, execution | verify prior work has no gaps |
| `all-simple-junior` | blueprint | check for over-complication |
| `all-real-junior` | criteria | verify no unquestioned assumptions |

---

## file specifications

### 1. 3.3.blueprint.v1.guard (update)

**before:**
```yaml
# guard for blueprint stone
# requires human approval before stone can be marked as passed

judges:
  - "npx rhachet run --repo bhrain --skill route.stone.judge --mechanism approved? --stone 3.3.blueprint.v1 --route $BEHAVIOR_DIR_REL"
```

**after:**
```yaml
# guard for blueprint stone
# includes self-review prompts + human approval

reviews:
  self:
    - slug: all-done-self
      say: |
        are you sure all of the criteria and vision was covered?
        emit a report into the .behavior dir on gaps detected. then, fix all gaps.

    - slug: all-done-junior
      say: |
        a junior recently worked on this blueprint. review against the criteria
        and vision and flag any gaps detected. emit a report into the
        .behavior dir if any and fix all gaps.

    - slug: all-simple-junior
      say: |
        a junior recently worked on this blueprint. are there any parts that
        are needlessly over complicated? any opportunities to simplify yet
        still fulfill the full vision and criteria?

judges:
  - "npx rhachet run --repo bhrain --skill route.stone.judge --mechanism approved? --stone 3.3.blueprint.v1 --route $BEHAVIOR_DIR_REL"
```

### 2. 5.1.execution.phase0_to_phaseN.v1.guard (create)

```yaml
# guard for execution stone
# includes self-review prompts

reviews:
  self:
    - slug: all-done-self
      say: |
        are you sure all was completed? review the blueprint and criteria.
        emit a report into the .behavior dir on gaps detected. then, fix all gaps.

    - slug: all-done-junior
      say: |
        a junior recently worked on this branch. review against the blueprint
        and criteria and flag any gaps detected. emit a report into the
        .behavior dir if any and fix all gaps.
```

### 3. 2.1.criteria.blackbox.guard (create)

```yaml
# guard for criteria stone
# includes self-review prompts

reviews:
  self:
    - slug: all-real-junior
      say: |
        a junior recently worked on this criteria. are there any unquestioned
        assumptions the junior took as requirements? any of these need to
        be asked to the wisher instead?
```

---

## domain decomposition

### guard templates (updated)

| stone | guard file | self-review slugs |
|-------|------------|-------------------|
| 3.3.blueprint.v1 | `3.3.blueprint.v1.guard` | `all-done-self`, `all-done-junior`, `all-simple-junior` |
| 5.1.execution | `5.1.execution.phase0_to_phaseN.v1.guard` | `all-done-self`, `all-done-junior` |
| 2.1.criteria.blackbox | `2.1.criteria.blackbox.guard` | `all-real-junior` |

### stones without guards (unchanged)

these stones do not require self-review guards per the wish:

- `1.vision` — remains human-approved only
- `2.2.criteria.blackbox.matrix` — derivative of 2.1, no separate guard needed
- `2.3.criteria.blueprint` — derivative of 2.1, no separate guard needed
- `3.1.research.*` — no guards (research is exploratory)
- `3.2.distill.*` — no guards (distillation is exploratory)
- `4.1.roadmap` — no guards (roadmap is a plan artifact)

---

## test coverage

### unit tests

no unit tests required — guard templates are static yaml files.

### integration tests

the guard template integration is already covered by:
- `rhachet-roles-bhrain` tests for `parseStoneGuard` (validates yaml format)
- `rhachet-roles-bhrain` tests for self-review execution

### acceptance tests

verify via manual test:
1. create a new behavior with `npx rhachet run --skill init.behavior`
2. verify the guard files are created with self-review prompts
3. verify `route.stone.set --as passed` triggers self-review prompts

---

## execution order

1. update `3.3.blueprint.v1.guard` — add `reviews.self` section
2. create `5.1.execution.phase0_to_phaseN.v1.guard` — new file with self-reviews
3. create `2.1.criteria.blackbox.guard` — new file with self-reviews
4. rebuild package (`npm run build`)
5. verify templates are included in `dist/`

---

## risk assessment

| risk | mitigation |
|------|------------|
| yaml indentation errors | use multiline `say: \|` syntax consistently |
| backwards compat with older bhrain | guards without `reviews.self` still work (bhrain ignores absent section) |
| self-review prompt too long | prompts are kept concise; longer prompts can use `@briefs/` reference |

---

## open questions resolved

1. **which criteria stones get guards?**
   - only `2.1.criteria.blackbox` — the primary criteria definition
   - `2.2` and `2.3` are derivatives that don't need separate assumption checks

2. **should execution stone have judges?**
   - no — execution is iterative work, not a gate that requires approval
   - self-review is sufficient to catch gaps mid-execution
