# handoff: bhrain $route variable expansion bug

## the problem

when `runStoneGuardJudges` executes judge commands, it sets `cwd: input.route` and substitutes `$route` with the same path. this causes path errors:

```javascript
// runStoneGuardJudges.js line 60
const result = await execAsync(cmd, { cwd: input.route });

// line 49-54: $route is substituted with input.route
const cmd = substituteVars(input.judgeCmd, {
    stone: input.stone.name,
    route: input.route,  // <-- same value as cwd
    ...
});
```

### example failure

given:
- `input.route = '.behavior/v2026_02_21.my-feature'` (relative path)
- judge command template: `npx rhachet run --repo bhrain --skill route.stone.judge --mechanism approved? --stone $stone --route $route`

execution:
1. cwd is set to `.behavior/v2026_02_21.my-feature`
2. command becomes `... --route .behavior/v2026_02_21.my-feature`
3. judge CLI receives `--route .behavior/v2026_02_21.my-feature`
4. judge CLI looks for stones in `.behavior/v2026_02_21.my-feature/.behavior/v2026_02_21.my-feature` (doubled path)
5. stones not found, judge fails

## proposed fix

option 1: substitute `$route` with `.` since cwd is already set to the route directory:

```javascript
const cmd = substituteVars(input.judgeCmd, {
    stone: input.stone.name,
    route: '.',  // cwd is already input.route
    hash: input.judgeInputHash,
    output: outputPath,
});
```

option 2: run commands from repo root, pass absolute path:

```javascript
// convert to absolute path
const routeAbsolute = path.join(process.cwd(), input.route);
const cmd = substituteVars(input.judgeCmd, {
    stone: input.stone.name,
    route: routeAbsolute,
    hash: input.judgeInputHash,
    output: outputPath,
});
const result = await execAsync(cmd, { cwd: process.cwd() }); // repo root
```

option 3: don't change cwd, rely on path from repo root:

```javascript
// remove cwd override
const result = await execAsync(cmd); // uses process.cwd() (repo root)
```

## recommendation

option 1 is the simplest fix and maintains backwards compatibility with guard files that use `$route`.

## affected files

- `src/domain.operations/route/judges/runStoneGuardJudges.ts` (line ~49-60)

## test case

1. create a consumer repo with relative route path (e.g., `.behavior/my-feature`)
2. add a guard with `$route` variable: `judges: ["npx rhachet run --repo bhrain --skill route.stone.judge --mechanism approved? --stone $stone --route $route"]`
3. attempt to pass the stone with `route.stone.set --as passed`
4. observe judge command failing to find the stone

## workaround

guard files can use `--route .` instead of `--route $route`:

```yaml
judges:
  - npx rhachet run --repo bhrain --skill route.stone.judge --mechanism approved? --stone $stone --route .
```

this works because cwd is already set to the route directory.

---

discovered while implementing behavior-guard-self-review in rhachet-roles-bhuild
