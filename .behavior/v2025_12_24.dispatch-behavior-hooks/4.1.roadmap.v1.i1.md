# roadmap.v1 = dispatch-behavior-hooks

---

## phase 0: create utils directory and utilities

### 0.1 create utils directory structure
- [ ] create `src/domain.roles/behaver/utils/`

**verify:**
```bash
ls -la src/domain.roles/behaver/utils/
```

---

### 0.2 create flattenBranchName.sh
- [ ] create `src/domain.roles/behaver/utils/flattenBranchName.sh`
- [ ] replace `/` with `.`
- [ ] normalize special characters
- [ ] make executable

**acceptance criteria:**
- given branch `vlad/dispatch-behavior-hooks` => output `vlad.dispatch-behavior-hooks`
- given branch `feature/foo/bar` => output `feature.foo.bar`
- given branch `main` => output `main`

**verify:**
```bash
source src/domain.roles/behaver/utils/flattenBranchName.sh
flattenBranchName "vlad/dispatch-behavior-hooks"
# expect: vlad.dispatch-behavior-hooks
```

---

### 0.3 create getBoundBehaviorByBranch.sh
- [ ] create `src/domain.roles/behaver/utils/getBoundBehaviorByBranch.sh`
- [ ] search `.behavior/*/.bind/${flatBranchName}.flag`
- [ ] output behavior directory path if one binding found
- [ ] output empty and exit 0 if no binding found
- [ ] output error to stderr and exit 1 if multiple bindings found
- [ ] make executable

**acceptance criteria:**
- given no bind flag exists => output empty, exit 0
- given one bind flag exists => output behavior dir path, exit 0
- given multiple bind flags exist => stderr error, exit 1

**verify:**
```bash
source src/domain.roles/behaver/utils/getBoundBehaviorByBranch.sh
# test in repo with no .behavior/.bind flags
getBoundBehaviorByBranch && echo "exit 0" || echo "exit non-zero"
```

---

### 0.4 create getLatestBlueprintByBehavior.sh
- [ ] create `src/domain.roles/behaver/utils/getLatestBlueprintByBehavior.sh`
- [ ] find `3.3.blueprint.v*.i*.md` files
- [ ] sort by major version (v3 > v2 > v1)
- [ ] sort by iteration within major (i3 > i2 > i1)
- [ ] output path to latest, or empty if none
- [ ] make executable

**acceptance criteria:**
- given v1.i1, v2.i1, v2.i3 => select v2.i3
- given v1.i1, v1.i2, v1.i3 => select v1.i3
- given no blueprints => output empty

**verify:**
```bash
source src/domain.roles/behaver/utils/getLatestBlueprintByBehavior.sh
getLatestBlueprintByBehavior ".behavior/v2025_12_24.dispatch-behavior-hooks"
# expect: path to latest blueprint
```

---

## phase 1: create bind.behavior skill

### 1.1 create bind.behavior.sh
- [ ] create `src/domain.roles/behaver/skills/bind.behavior.sh`
- [ ] implement argument parsing (--set, --del, --get, --behavior)
- [ ] implement --get: query and output current binding status
- [ ] implement --set: create bind flag with metadata
- [ ] implement --del: remove bind flag
- [ ] implement idempotency for --set and --del
- [ ] implement fail-fast when no action flag provided
- [ ] implement fail-fast when --behavior does not exist
- [ ] implement fail-fast when --set to different behavior
- [ ] make executable

**acceptance criteria (usecase.1b):**
- `--set --behavior X` creates `.behavior/X/.bind/{flatBranchName}.flag`
- `--set` when already bound to same behavior => idempotent success
- `--set` when bound to different behavior => fail fast with suggestion
- `--del` when bound => removes flag, outputs confirmation
- `--del` when not bound => idempotent success
- `--get` when bound => outputs behavior name
- `--get` when not bound => outputs "not bound"
- no action flag => fail fast with usage

**verify:**
```bash
# test --get on unbound branch
./src/domain.roles/behaver/skills/bind.behavior.sh --get
# expect: "not bound"

# test --set
./src/domain.roles/behaver/skills/bind.behavior.sh --set --behavior dispatch-behavior-hooks
# expect: confirmation, flag file created

# test --get after --set
./src/domain.roles/behaver/skills/bind.behavior.sh --get
# expect: behavior name

# test --del
./src/domain.roles/behaver/skills/bind.behavior.sh --del
# expect: confirmation, flag file removed
```

---

## phase 2: update init.behavior.sh

### 2.1 add binding check at start
- [ ] source getBoundBehaviorByBranch utility
- [ ] check if current branch already bound
- [ ] if bound: fail fast with error message
- [ ] error must explain branch is already bound to {behavior}
- [ ] error must suggest git worktree for new branch

**acceptance criteria (usecase.1c):**
- branch already bound => fail fast with clear error and worktree suggestion
- branch not bound => proceed normally

**verify:**
```bash
# bind branch first
./src/domain.roles/behaver/skills/bind.behavior.sh --set --behavior dispatch-behavior-hooks

# attempt init.behavior
./src/domain.roles/behaver/skills/init.behavior.sh --name test-behavior
# expect: fail fast with error about existing binding
```

---

### 2.2 add auto-bind after behavior creation
- [ ] after behavior directory created, create bind flag
- [ ] output confirmation that branch was bound

**acceptance criteria (usecase.1c):**
- new behavior created => bind flag automatically created
- branch immediately bound to newly created behavior

**verify:**
```bash
# unbind first
./src/domain.roles/behaver/skills/bind.behavior.sh --del

# create new behavior
./src/domain.roles/behaver/skills/init.behavior.sh --name test-auto-bind

# check binding
./src/domain.roles/behaver/skills/bind.behavior.sh --get
# expect: test-auto-bind behavior

# cleanup
rm -rf .behavior/v*test-auto-bind
./src/domain.roles/behaver/skills/bind.behavior.sh --del
```

---

## phase 3: create behaver inits structure

### 3.1 create inits directory structure
- [ ] create `src/domain.roles/behaver/inits/`
- [ ] create `src/domain.roles/behaver/inits/claude.hooks/`

**verify:**
```bash
ls -la src/domain.roles/behaver/inits/
ls -la src/domain.roles/behaver/inits/claude.hooks/
```

---

### 3.2 create init.claude.hooks.findsert.sh
- [ ] copy or adapt mechanic's findsert utility
- [ ] set default author to "repo=bhuild/role=behaver"

**verify:**
```bash
ls -la src/domain.roles/behaver/inits/init.claude.hooks.findsert.sh
```

---

### 3.3 create init.claude.hooks.sh
- [ ] create `src/domain.roles/behaver/inits/init.claude.hooks.sh`
- [ ] register SessionStart hook for dispatch-behavior
- [ ] mirror mechanic's init.claude.hooks.sh pattern

**acceptance criteria (usecase.6):**
- hook registered via claude hooks mechanism
- follows established rhachet conventions

**verify:**
```bash
./src/domain.roles/behaver/inits/init.claude.hooks.sh
cat .claude/settings.local.json | jq '.hooks.SessionStart'
# expect: dispatch-behavior hook present
```

---

## phase 4: create dispatch-behavior hook

### 4.1 create sessionstart.dispatch-behavior.sh
- [ ] create `src/domain.roles/behaver/inits/claude.hooks/sessionstart.dispatch-behavior.sh`
- [ ] get current branch name via git
- [ ] call getBoundBehaviorByBranch
- [ ] if not bound: exit 0 silently
- [ ] if multiple bindings: log warning, exit 0
- [ ] collect behavior files (wish, vision, criteria, blueprint)
- [ ] use getLatestBlueprintByBehavior for blueprint selection
- [ ] output formatted context with file headers
- [ ] output files in order: wish, vision, criteria, blueprint
- [ ] handle missing optional files gracefully
- [ ] never block session (exit 0 always)
- [ ] make executable

**acceptance criteria (usecase.2, usecase.7, usecase.8):**
- bound branch => injects wish, vision, criteria, blueprint
- missing optional files => continues without them
- files wrapped with clear path headers
- files appear in logical order
- filesystem errors => log warning, continue
- unbound branch => silent exit 0

**verify:**
```bash
# bind to current behavior
./src/domain.roles/behaver/skills/bind.behavior.sh --set --behavior dispatch-behavior-hooks

# run hook manually
./src/domain.roles/behaver/inits/claude.hooks/sessionstart.dispatch-behavior.sh
# expect: formatted output with wish, vision, criteria, blueprint

# unbind and test silent exit
./src/domain.roles/behaver/skills/bind.behavior.sh --del
./src/domain.roles/behaver/inits/claude.hooks/sessionstart.dispatch-behavior.sh
# expect: no output, exit 0
```

---

## phase 5: test fixtures and integration tests

### 5.1 update existing test fixtures
- [ ] add `.bind/` directory to valid-behavior fixture
- [ ] add `test-branch.flag` for bound branch testing

**verify:**
```bash
ls -la src/domain.roles/behaver/skills/.test/assets/example.repo/valid-behavior/.behavior/v2025_01_01.get-weather-emoji/.bind/
```

---

### 5.2 create bind.behavior integration tests
- [ ] create `src/domain.roles/behaver/skills/bind.behavior.integration.test.ts`
- [ ] test --set creates bind flag
- [ ] test --set idempotency (same behavior)
- [ ] test --set fail fast (different behavior)
- [ ] test --del removes flag
- [ ] test --del idempotency
- [ ] test --get returns behavior name
- [ ] test --get returns "not bound"
- [ ] test no action flag fails fast

**verify:**
```bash
npm run test:integration -- bind.behavior.integration.test.ts
```

---

### 5.3 update init.behavior integration tests
- [ ] add test: fails fast when branch already bound
- [ ] add test: creates bind flag after behavior creation

**verify:**
```bash
npm run test:integration -- init.behavior.integration.test.ts
```

---

## phase 6: end-to-end verification

### 6.1 manual end-to-end test
- [ ] create new worktree with new branch
- [ ] run init.behavior to create behavior and auto-bind
- [ ] verify bind flag created
- [ ] start new claude session
- [ ] verify behavior context injected on session start
- [ ] verify behavior context re-injected after compaction

**verify:**
```bash
# in new worktree
git worktree add ../test-e2e -b test/e2e-verification
cd ../test-e2e

# init behavior
npx rhachet run --repo bhuild --skill init.behavior --name e2e-test

# check binding
npx rhachet run --repo bhuild --skill bind.behavior --get
# expect: e2e-test

# start claude session and observe hook output
claude
# expect: behavior context in session start output

# cleanup
cd ..
git worktree remove test-e2e
git branch -D test/e2e-verification
```

---

### 6.2 verify rhachet integration
- [ ] run `npm run build` to compile
- [ ] verify inits are included in dist
- [ ] verify skills are included in dist
- [ ] verify utils are included in dist

**verify:**
```bash
npm run build
ls -la dist/domain.roles/behaver/inits/
ls -la dist/domain.roles/behaver/skills/
ls -la dist/domain.roles/behaver/utils/
```

---

## completion checklist

- [ ] phase 0: utils created and tested
- [ ] phase 1: bind.behavior skill created and tested
- [ ] phase 2: init.behavior updated and tested
- [ ] phase 3: behaver inits structure created
- [ ] phase 4: dispatch-behavior hook created and tested
- [ ] phase 5: integration tests pass
- [ ] phase 6: end-to-end verification complete
- [ ] all criteria from 2.criteria.md satisfied
