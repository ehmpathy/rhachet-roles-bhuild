# blueprint: Role.hooks migration

## summary

migrate the behaver role from shell-based hook registration to rhachet's declarative `Role.hooks.onBrain` interface, per the pattern in [PR #167](https://github.com/ehmpathy/rhachet-roles-ehmpathy/pull/167).

---

## 1. filediffs treestruct

```
src/domain.roles/behaver/
â”œâ”€â”€ [~] getBehaverRole.ts                              # add hooks property, remove exec
â”œâ”€â”€ [+] getBehaverRole.test.ts                         # unit tests for hooks declaration
â””â”€â”€ inits/
    â”œâ”€â”€ [-] init.claude.hooks.sh                       # DELETE: orchestrator
    â”œâ”€â”€ [-] init.claude.hooks.findsert.sh              # DELETE: jq insert utility
    â”œâ”€â”€ [-] init.claude.hooks.cleanup.sh               # DELETE: cleanup orchestrator
    â”œâ”€â”€ [-] init.claude.hooks.cleanup.repograin.sh     # DELETE: repo-level cleanup
    â”œâ”€â”€ [-] init.claude.hooks.cleanup.localgrain.sh    # DELETE: local-level cleanup
    â”œâ”€â”€ [-] init.claude.hooks.integration.test.ts      # DELETE: tests shell orchestrator
    â”œâ”€â”€ [-] init.claude.hooks.findsert.integration.test.ts    # DELETE: tests findsert
    â”œâ”€â”€ [-] init.claude.hooks.cleanup.integration.test.ts     # DELETE: tests cleanup
    â””â”€â”€ .test/assets/                                  # KEEP: used by skill tests
        â”œâ”€â”€ repo-empty-hooks/
        â”œâ”€â”€ repo-valid-boot-behavior/
        â””â”€â”€ ...
```

**legend:**
- `[+] create` â€” file to create
- `[~] update` â€” file to update
- `[-] delete` â€” file to delete

---

## 2. contracts

### 2.1 Role.hooks contract (from rhachet v1.24.0+)

```typescript
interface RoleHooks {
  onBrain?: RoleHooksOnBrain;
}

interface RoleHooksOnBrain {
  onBoot?: RoleHookOnBrain[];   // SessionStart equivalent
  onTool?: RoleHookOnBrain[];   // PreToolUse/PostToolUse equivalent
  onStop?: RoleHookOnBrain[];   // Stop equivalent
}

interface RoleHookOnBrain {
  command: string;              // command to execute
  timeout: IsoDuration;         // ISO 8601 format: 'PT10S', 'PT60S'
  filter?: BrainHookFilter;     // optional: { what: 'Bash', when: 'before' }
}
```

### 2.2 shell hook â†’ Role.hooks map

| current (shell) | target (Role.hooks) |
|-----------------|---------------------|
| `--hook-type SessionStart` | `hooks.onBrain.onBoot` |
| `--matcher "*"` | (no filter needed for onBoot) |
| `--timeout 10` | `timeout: 'PT10S'` |
| `--author "repo=bhuild/role=behaver"` | (derived automatically by rhachet) |

---

## 3. code changes

### 3.1 getBehaverRole.ts â€” before

```typescript
import { Role } from 'rhachet';

export const ROLE_BEHAVER: Role = Role.build({
  slug: 'behaver',
  name: 'Behaver',
  purpose: 'declare clear, buildable, and testable behaviors',
  readme: { uri: __dirname + '/readme.md' },
  traits: [],
  skills: {
    dirs: [{ uri: __dirname + '/skills' }],
    refs: [],
  },
  briefs: {
    dirs: [{ uri: __dirname + '/briefs' }],
  },
  inits: {
    dirs: { uri: __dirname + '/inits' },
    exec: [{ cmd: __dirname + '/inits/init.claude.hooks.sh' }],
  },
});
```

### 3.2 getBehaverRole.ts â€” after

```typescript
import { Role } from 'rhachet';

export const ROLE_BEHAVER: Role = Role.build({
  slug: 'behaver',
  name: 'Behaver',
  purpose: 'declare clear, buildable, and testable behaviors',
  readme: { uri: __dirname + '/readme.md' },
  traits: [],
  skills: {
    dirs: [{ uri: __dirname + '/skills' }],
    refs: [],
  },
  briefs: {
    dirs: [{ uri: __dirname + '/briefs' }],
  },
  inits: {
    dirs: { uri: __dirname + '/inits' },
    exec: [],  // no shell-based hook registration
  },
  hooks: {
    onBrain: {
      onBoot: [
        {
          command:
            './node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior',
          timeout: 'PT10S',
        },
      ],
      onTool: [],
      onStop: [],
    },
  },
});
```

---

## 4. codepaths treestruct

### 4.1 current codepath (shell-based)

```
npx rhachet roles init --role behaver
  â”‚
  â””â”€â”€ executes: inits.exec[0].cmd
        â”‚
        â””â”€â”€ init.claude.hooks.sh
              â”‚
              â”œâ”€â”€ calls: init.claude.hooks.cleanup.sh
              â”‚     â”œâ”€â”€ init.claude.hooks.cleanup.repograin.sh
              â”‚     â””â”€â”€ init.claude.hooks.cleanup.localgrain.sh
              â”‚
              â””â”€â”€ calls: init.claude.hooks.findsert.sh
                    â”‚
                    â””â”€â”€ jq manipulation of .claude/settings.json
```

**characteristics:**
- ðŸ”´ 5 shell files to maintain
- ðŸ”´ complex jq logic for idempotent findsert
- ðŸ”´ separate cleanup logic for stale hooks
- ðŸ”´ shell test coverage required

### 4.2 target codepath (Role.hooks)

```
npx rhachet roles init --role behaver
  â”‚
  â””â”€â”€ rhachet reads: ROLE_BEHAVER.hooks
        â”‚
        â””â”€â”€ rhachet adapter writes to .claude/settings.json
              â”‚
              â”œâ”€â”€ derives author: "repo=bhuild/role=behaver"
              â”œâ”€â”€ converts timeout: 'PT10S' â†’ 10
              â””â”€â”€ handles idempotency internally
```

**characteristics:**
- ðŸŸ¢ 0 shell files to maintain
- ðŸŸ¢ declarative hooks in typescript
- ðŸŸ¢ rhachet handles cleanup of stale hooks
- ðŸŸ¢ rhachet handles idempotent registration
- ðŸŸ¢ typescript type-safety for hook declarations

---

## 5. test coverage

### 5.1 unit tests

**file**: `src/domain.roles/behaver/getBehaverRole.test.ts`

```typescript
import { given, when, then } from 'test-fns';
import { ROLE_BEHAVER } from './getBehaverRole';

describe('getBehaverRole', () => {
  given('[case1] the behaver role definition', () => {
    when('[t0] hooks property is accessed', () => {
      then('onBrain is defined', () => {
        expect(ROLE_BEHAVER.hooks?.onBrain).toBeDefined();
      });

      then('onBrain.onBoot contains 1 hook', () => {
        expect(ROLE_BEHAVER.hooks?.onBrain?.onBoot).toHaveLength(1);
      });

      then('onBrain.onTool is empty', () => {
        expect(ROLE_BEHAVER.hooks?.onBrain?.onTool).toHaveLength(0);
      });

      then('onBrain.onStop is empty', () => {
        expect(ROLE_BEHAVER.hooks?.onBrain?.onStop).toHaveLength(0);
      });
    });

    when('[t1] onBoot hook is inspected', () => {
      then('command contains sessionstart.boot-behavior', () => {
        const hook = ROLE_BEHAVER.hooks?.onBrain?.onBoot?.[0];
        expect(hook?.command).toContain('sessionstart.boot-behavior');
      });

      then('command uses rhachet run --init pattern', () => {
        const hook = ROLE_BEHAVER.hooks?.onBrain?.onBoot?.[0];
        expect(hook?.command).toContain('./node_modules/.bin/rhachet');
        expect(hook?.command).toContain('run');
        expect(hook?.command).toContain('--init');
      });

      then('timeout is PT10S', () => {
        const hook = ROLE_BEHAVER.hooks?.onBrain?.onBoot?.[0];
        expect(hook?.timeout).toEqual('PT10S');
      });
    });

    when('[t2] inits.exec is inspected', () => {
      then('exec array is empty', () => {
        expect(ROLE_BEHAVER.inits?.exec).toHaveLength(0);
      });
    });
  });
});
```

### 5.2 tests to delete

the tests below become obsolete since they test shell-based hook management:

| file | reason for deletion |
|------|---------------------|
| `init.claude.hooks.integration.test.ts` | tests shell orchestrator |
| `init.claude.hooks.findsert.integration.test.ts` | tests jq findsert utility |
| `init.claude.hooks.cleanup.integration.test.ts` | tests shell cleanup |

### 5.3 acceptance tests

current acceptance tests in `blackbox/role=behaver/` should continue to pass:
- `skill.init.behavior.acceptance.test.ts`
- `skill.bind.behavior.acceptance.test.ts`
- `skill.review.deliverable.acceptance.test.ts`

these tests exercise the role via skills, not hook registration directly.

---

## 6. verification checklist

### 6.1 before migration

- [ ] confirm rhachet version â‰¥ 1.24.0 (current: 1.25.5 âœ“)
- [ ] identify all shell files to delete (5 files)
- [ ] identify all tests to delete (3 files)
- [ ] backup current `.claude/settings.json` state

### 6.2 after migration

- [ ] `npm run build` succeeds
- [ ] `npm run test:types` passes
- [ ] `npm run test:unit -- getBehaverRole` passes
- [ ] `npm run test:integration` passes (rest of tests)
- [ ] `npm run test:acceptance` passes
- [ ] `npx rhachet roles init --role behaver` registers hook correctly
- [ ] `.claude/settings.json` contains `SessionStart` hook with correct author

### 6.3 hook registration verification

```bash
# after migration, verify hook appears in settings
cat .claude/settings.json | jq '.hooks.SessionStart'
```

expected output:
```json
[
  {
    "matcher": "*",
    "hooks": [
      {
        "type": "command",
        "command": "./node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior",
        "timeout": 10,
        "author": "repo=bhuild/role=behaver"
      }
    ]
  }
]
```

---

## 7. risks and mitigations

### 7.1 risk: hook command format change

**observation**: the current shell findsert uses a slightly different command path:
```bash
./node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior
```

**mitigation**: verify command format matches exactly in Role.hooks declaration.

### 7.2 risk: test assets orphaned

**observation**: `.test/assets/` directory contains fixtures used by deleted tests.

**mitigation**: review if any assets are used by other tests before cleanup.

### 7.3 risk: timeout format conversion

**observation**: shell uses seconds (10), Role.hooks uses ISO 8601 ('PT10S').

**mitigation**: rhachet adapter handles conversion; verify via integration test.

---

## 8. implementation sequence

| phase | action |
|-------|--------|
| 1 | add `getBehaverRole.test.ts` with tests for hooks property |
| 2 | update `getBehaverRole.ts` to add `hooks.onBrain` and clear `inits.exec` |
| 3 | verify unit tests pass |
| 4 | delete shell files (5 files) |
| 5 | delete integration tests for shell files (3 files) |
| 6 | run full test suite |
| 7 | verify hook registration via `npx rhachet roles init` |

---

## 9. references

- wish: `.behavior/v2026_01_20.role-hooks/0.wish.md`
- template research: `.behavior/v2026_01_20.role-hooks/3.1.research.templates._.v1.i1.md`
- template PR: [ehmpathy/rhachet-roles-ehmpathy#167](https://github.com/ehmpathy/rhachet-roles-ehmpathy/pull/167)
