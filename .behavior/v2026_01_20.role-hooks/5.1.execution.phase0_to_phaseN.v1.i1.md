# execution: Role.hooks migration

## refs

- wish: `.behavior/v2026_01_20.role-hooks/0.wish.md`
- blueprint: `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md`
- roadmap: `.behavior/v2026_01_20.role-hooks/4.1.roadmap.v1.i1.md`

---

## phase 0: pre-flight verification

### status: done

### checklist

- [x] **0.1** verify rhachet version >= 1.24.0
- [x] **0.2** verify Role interface includes `hooks` property
- [x] **0.3** verify build passes before changes
- [x] **0.4** verify all tests pass before changes

### log

```
0.1: rhachet 1.25.5 >= 1.24.0 ✓
0.2: Role.d.ts contains `hooks?: RoleHooks;` ✓
0.3: npm run build succeeded ✓
0.4: npm run test:types && test:unit && test:integration succeeded ✓
```

---

## phase 1: write unit tests for hooks declaration

### status: done

### checklist

- [x] **1.1** create `src/domain.roles/behaver/getBehaverRole.test.ts`
- [x] **1.2** add test: `onBrain is defined`
- [x] **1.3** add test: `onBrain.onBoot contains 1 hook`
- [x] **1.4** add test: `onBrain.onTool is empty`
- [x] **1.5** add test: `onBrain.onStop is empty`
- [x] **1.6** add test: `command contains sessionstart.boot-behavior`
- [x] **1.7** add test: `command uses rhachet run --init pattern`
- [x] **1.8** add test: `timeout is PT10S`
- [x] **1.9** add test: `inits.exec array is empty`

### log

```
created getBehaverRole.test.ts with 8 test assertions
tests fail as expected (hooks not yet declared) ✓
```

---

## phase 2: update getBehaverRole.ts with hooks declaration

### status: done

### checklist

- [x] **2.1** clear `inits.exec` array
- [x] **2.2** add `hooks.onBrain.onBoot` with sessionstart hook
- [x] **2.3** verify types compile

### log

```
updated getBehaverRole.ts: inits.exec = [], added hooks.onBrain
npm run test:types succeeded ✓
npm run test:unit -- getBehaverRole.test.ts: 8 passed ✓
```

---

## phase 3: delete shell hook management files

### status: done

### checklist

- [x] **3.1** delete `init.claude.hooks.sh`
- [x] **3.2** delete `init.claude.hooks.findsert.sh`
- [x] **3.3** delete `init.claude.hooks.cleanup.sh`
- [x] **3.4** delete `init.claude.hooks.cleanup.repograin.sh`
- [x] **3.5** delete `init.claude.hooks.cleanup.localgrain.sh`

### log

```
deleted 5 shell files via rmsafe
verified: no .sh files in src/domain.roles/behaver/inits/
verified: claude.hooks/sessionstart.boot-behavior.sh still present ✓
```

---

## phase 4: delete obsolete integration tests

### status: done

### checklist

- [x] **4.1** delete `init.claude.hooks.integration.test.ts`
- [x] **4.2** delete `init.claude.hooks.findsert.integration.test.ts`
- [x] **4.3** delete `init.claude.hooks.cleanup.integration.test.ts`

### log

```
deleted 3 integration test files via rmsafe
verified: no .integration.test.ts files in inits/
verified: no references to init.claude.hooks.sh in src/ ✓
```

---

## phase 5: rebuild and verify test suite

### status: done

### checklist

- [x] **5.1** rebuild the project
- [x] **5.2** run type checks
- [x] **5.3** run unit tests
- [x] **5.4** run integration tests
- [x] **5.5** run acceptance tests

### log

```
5.1: npm run build succeeded ✓
5.2: npm run test:types succeeded ✓
5.3: npm run test:unit: 8/8 passed ✓
5.4: npm run test:integration: passed ✓
5.5: npm run test:acceptance: 11 suites, 89/89 passed ✓

note: acceptance tests required fixes to test infrastructure:
- runRolesInit.ts: updated to call both `roles init` AND `init --hooks`
  (roles init only runs inits.exec; init --hooks syncs Role.hooks to brain configs)
- genConsumerRepo.ts: added rhachet-brains-anthropic dependency
  (hooks require brain adapter discovery)
```

---

## phase 6: verify hook registration via rhachet

### status: done

### checklist

- [x] **6.1** clear prior hooks from `.claude/settings.json`
- [x] **6.2** run rhachet roles init
- [x] **6.3** verify hook appears in settings.json
- [x] **6.4** verify hook has correct author
- [x] **6.5** verify hook command is correct

### log

```
verified via acceptance tests (role.init.acceptance.test.ts):
- [case1] fresh consumer repo: hooks are bound after init ✓
- [case2] stale hook cleanup: old hooks replaced with new ✓

verified in development repo (.claude/settings.json):
- hook command: ./node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior ✓
- hook timeout: 10 (from PT10S) ✓
- hook author: repo=bhuild/role=behaver ✓
```

---

## phase 7: idempotency verification

### status: done

### checklist

- [x] **7.1** capture hook count before second init
- [x] **7.2** run rhachet roles init again
- [x] **7.3** verify no duplicate hooks

### log

```
verified via acceptance tests (role.init.acceptance.test.ts):
- [case1][t1] "is idempotent - second run also succeeds" ✓
  - first run: exitCode 0, hook registered
  - second run: exitCode 0, no duplicates

rhachet's syncHooksForLinkedRoles uses author tag as idempotency key:
- cleans prior hooks with same author before insert
- ensures at-most-one hook per role per hook type
```

---

## phase 8: cleanup test assets (optional)

### status: skipped

### checklist

- [x] **8.1** identify which test assets are used by other tests
- [x] **8.2** if assets are only used by deleted tests, consider removal
- [x] **8.3** keep assets used by skill tests in `blackbox/`

### log

```
no orphaned test assets found:
- deleted integration tests did not have dedicated fixtures
- blackbox/ test assets remain in use by acceptance tests
- no cleanup required
```

---

## summary

| phase | description | status |
|-------|-------------|--------|
| 0 | pre-flight verification | done |
| 1 | write unit tests | done |
| 2 | update getBehaverRole.ts | done |
| 3 | delete shell files | done |
| 4 | delete obsolete tests | done |
| 5 | rebuild and verify suite | done |
| 6 | verify hook registration | done |
| 7 | idempotency verification | done |
| 8 | cleanup test assets | skipped |

**migration complete** ✓
