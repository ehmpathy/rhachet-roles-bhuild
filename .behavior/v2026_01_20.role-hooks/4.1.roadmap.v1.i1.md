# roadmap: Role.hooks migration

## refs

- wish: `.behavior/v2026_01_20.role-hooks/0.wish.md`
- templates: `.behavior/v2026_01_20.role-hooks/3.1.research.templates._.v1.i1.md`
- blueprint: `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md`

---

## phase 0: pre-flight verification

### depends on
- (none — first phase)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/0.wish.md`
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md`

### checklist

- [ ] **0.1** verify rhachet version ≥ 1.24.0
  ```bash
  npm list rhachet --depth=0
  ```

- [ ] **0.2** verify Role interface includes `hooks` property
  ```bash
  grep -A3 "hooks?:" node_modules/rhachet/dist/domain.objects/Role.d.ts
  ```

- [ ] **0.3** verify build passes before changes
  ```bash
  npm run build
  ```

- [ ] **0.4** verify all tests pass before changes
  ```bash
  npm run test:types && npm run test:unit && npm run test:integration
  ```

### acceptance criteria
- rhachet version is 1.24.0 or higher
- Role interface includes `hooks?: RoleHooks` property
- build completes without errors
- all tests pass

### verification
```bash
# all commands should succeed with exit code 0
npm list rhachet --depth=0 | grep "1.2[4-9]\|1.[3-9]"
npm run build
npm run test
```

---

## phase 1: write unit tests for hooks declaration

### depends on
- phase 0 (pre-flight verification)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 5.1)
- `.behavior/v2026_01_20.role-hooks/3.1.research.templates._.v1.i1.md` (section 2.1)

### checklist

- [ ] **1.1** create `src/domain.roles/behaver/getBehaverRole.test.ts`

- [ ] **1.2** add test: `onBrain is defined`

- [ ] **1.3** add test: `onBrain.onBoot contains 1 hook`

- [ ] **1.4** add test: `onBrain.onTool is empty`

- [ ] **1.5** add test: `onBrain.onStop is empty`

- [ ] **1.6** add test: `command contains sessionstart.boot-behavior`

- [ ] **1.7** add test: `command uses rhachet run --init pattern`

- [ ] **1.8** add test: `timeout is PT10S`

- [ ] **1.9** add test: `inits.exec array is empty`

### acceptance criteria
- test file exists at `src/domain.roles/behaver/getBehaverRole.test.ts`
- tests use `given`, `when`, `then` from `test-fns`
- tests fail (hooks not yet declared)

### verification
```bash
# tests should FAIL at this point (expected)
npm run test:unit -- getBehaverRole.test.ts
# exit code should be non-zero
```

---

## phase 2: update getBehaverRole.ts with hooks declaration

### depends on
- phase 1 (unit tests written)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 3.2)
- `.behavior/v2026_01_20.role-hooks/3.1.research.templates._.v1.i1.md` (section 2.1, 2.3)

### checklist

- [ ] **2.1** clear `inits.exec` array (remove shell hook registration)
  ```typescript
  exec: [],  // was: [{ cmd: __dirname + '/inits/init.claude.hooks.sh' }]
  ```

- [ ] **2.2** add `hooks.onBrain.onBoot` with sessionstart hook
  ```typescript
  hooks: {
    onBrain: {
      onBoot: [
        {
          command: './node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior',
          timeout: 'PT10S',
        },
      ],
      onTool: [],
      onStop: [],
    },
  },
  ```

- [ ] **2.3** verify types compile
  ```bash
  npm run test:types
  ```

### acceptance criteria
- `ROLE_BEHAVER.hooks.onBrain.onBoot` contains 1 hook
- `ROLE_BEHAVER.inits.exec` is empty array
- hook command matches pattern from template
- hook timeout uses ISO 8601 format

### verification
```bash
# types should pass
npm run test:types

# unit tests should now PASS
npm run test:unit -- getBehaverRole.test.ts
```

---

## phase 3: delete shell hook management files

### depends on
- phase 2 (role updated with hooks)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 1)

### checklist

- [ ] **3.1** delete `src/domain.roles/behaver/inits/init.claude.hooks.sh`

- [ ] **3.2** delete `src/domain.roles/behaver/inits/init.claude.hooks.findsert.sh`

- [ ] **3.3** delete `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.sh`

- [ ] **3.4** delete `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.repograin.sh`

- [ ] **3.5** delete `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.localgrain.sh`

### acceptance criteria
- 5 shell files removed from `src/domain.roles/behaver/inits/`
- only `claude.hooks/sessionstart.boot-behavior.sh` remains in inits/

### verification
```bash
# should show only claude.hooks/ directory and no init.claude.hooks*.sh files
ls src/domain.roles/behaver/inits/*.sh 2>&1 | grep -v "No such file"
# expected: empty or error

# should show the hook executable still exists
ls src/domain.roles/behaver/inits/claude.hooks/
# expected: sessionstart.boot-behavior.sh
```

---

## phase 4: delete obsolete integration tests

### depends on
- phase 3 (shell files deleted)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 5.2)

### checklist

- [ ] **4.1** delete `src/domain.roles/behaver/inits/init.claude.hooks.integration.test.ts`

- [ ] **4.2** delete `src/domain.roles/behaver/inits/init.claude.hooks.findsert.integration.test.ts`

- [ ] **4.3** delete `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.integration.test.ts`

### acceptance criteria
- 3 integration test files removed
- no test files reference deleted shell files

### verification
```bash
# should show no integration test files for hook management
ls src/domain.roles/behaver/inits/*.integration.test.ts 2>&1
# expected: "No such file or directory"

# should not find references to deleted files
grep -r "init.claude.hooks.sh" src/ --include="*.ts" || echo "OK: no references found"
```

---

## phase 5: rebuild and verify test suite

### depends on
- phase 4 (tests deleted)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 6.2)

### checklist

- [ ] **5.1** rebuild the project
  ```bash
  npm run build
  ```

- [ ] **5.2** run type checks
  ```bash
  npm run test:types
  ```

- [ ] **5.3** run unit tests
  ```bash
  npm run test:unit
  ```

- [ ] **5.4** run integration tests
  ```bash
  npm run test:integration
  ```

- [ ] **5.5** run acceptance tests
  ```bash
  npm run test:acceptance
  ```

### acceptance criteria
- build succeeds
- all type checks pass
- all unit tests pass
- all integration tests pass
- all acceptance tests pass

### verification
```bash
# full test suite should pass
npm run build && npm run test:types && npm run test:unit && npm run test:integration && npm run test:acceptance
```

---

## phase 6: verify hook registration via rhachet

### depends on
- phase 5 (test suite passes)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 6.3)
- `.behavior/v2026_01_20.role-hooks/3.1.research.templates._.v1.i1.md` (section 4.2)

### checklist

- [ ] **6.1** clear prior hooks from `.claude/settings.json` (if any)
  ```bash
  # backup first
  cp .claude/settings.json .claude/settings.json.bak

  # remove hooks with our author
  cat .claude/settings.json | jq 'del(.hooks.SessionStart[] | select(.hooks[].author == "repo=bhuild/role=behaver"))' > .claude/settings.json.tmp && mv .claude/settings.json.tmp .claude/settings.json
  ```

- [ ] **6.2** run rhachet roles init
  ```bash
  npx rhachet roles init --repo bhuild --role behaver
  ```

- [ ] **6.3** verify hook appears in settings.json
  ```bash
  cat .claude/settings.json | jq '.hooks.SessionStart'
  ```

- [ ] **6.4** verify hook has correct author
  ```bash
  cat .claude/settings.json | jq '.hooks.SessionStart[].hooks[] | select(.author == "repo=bhuild/role=behaver")'
  ```

- [ ] **6.5** verify hook command is correct
  ```bash
  cat .claude/settings.json | jq '.hooks.SessionStart[].hooks[] | select(.command | contains("sessionstart.boot-behavior"))'
  ```

### acceptance criteria
- `SessionStart` hook present in `.claude/settings.json`
- hook has `author: "repo=bhuild/role=behaver"`
- hook command contains `sessionstart.boot-behavior`
- hook timeout is `10` (converted from PT10S)

### verification
```bash
# should output the hook with correct structure
cat .claude/settings.json | jq '.hooks.SessionStart[] | select(.hooks[].author == "repo=bhuild/role=behaver")'
```

expected output:
```json
{
  "matcher": "*",
  "hooks": [
    {
      "type": "command",
      "command": "./node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior",
      "timeout": 10,
      "author": "repo=bhuild/role=behaver"
    }
  ]
}
```

---

## phase 7: idempotency verification

### depends on
- phase 6 (hook registered)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 4.2)

### checklist

- [ ] **7.1** capture hook count before second init
  ```bash
  cat .claude/settings.json | jq '[.hooks.SessionStart[].hooks[] | select(.author == "repo=bhuild/role=behaver")] | length'
  ```

- [ ] **7.2** run rhachet roles init again
  ```bash
  npx rhachet roles init --repo bhuild --role behaver
  ```

- [ ] **7.3** verify no duplicate hooks
  ```bash
  cat .claude/settings.json | jq '[.hooks.SessionStart[].hooks[] | select(.author == "repo=bhuild/role=behaver")] | length'
  ```

### acceptance criteria
- hook count remains 1 after second init
- no duplicate hooks with same author

### verification
```bash
# count should be exactly 1
HOOK_COUNT=$(cat .claude/settings.json | jq '[.hooks.SessionStart[].hooks[] | select(.author == "repo=bhuild/role=behaver")] | length')
[ "$HOOK_COUNT" -eq 1 ] && echo "✓ idempotent" || echo "✗ duplicates found"
```

---

## phase 8: cleanup test assets (optional)

### depends on
- phase 7 (idempotency verified)

### briefs to read
- `.behavior/v2026_01_20.role-hooks/3.3.blueprint.v1.i1.md` (section 7.2)

### checklist

- [ ] **8.1** identify which test assets are used by other tests
  ```bash
  grep -r "repo-empty-hooks\|repo-valid-boot-behavior" src/ blackbox/ --include="*.ts"
  ```

- [ ] **8.2** if assets are only used by deleted tests, consider removal
  - `repo-empty-hooks/` — check usage
  - `repo-valid-boot-behavior/` — check usage
  - `repo-stale-hook-ours/` — check usage
  - `repo-stale-hook-other-role/` — check usage
  - `repo-multiple-matchers/` — check usage
  - etc.

- [ ] **8.3** keep assets used by skill tests in `blackbox/`

### acceptance criteria
- no orphaned test assets (or documented why kept)
- skill tests in blackbox/ continue to pass

### verification
```bash
# acceptance tests should still pass
npm run test:acceptance
```

---

## summary checklist

| phase | description | status |
|-------|-------------|--------|
| 0 | pre-flight verification | [ ] |
| 1 | write unit tests | [ ] |
| 2 | update getBehaverRole.ts | [ ] |
| 3 | delete shell files | [ ] |
| 4 | delete obsolete tests | [ ] |
| 5 | rebuild and verify suite | [ ] |
| 6 | verify hook registration | [ ] |
| 7 | idempotency verification | [ ] |
| 8 | cleanup test assets (optional) | [ ] |

---

## rollback plan

if migration fails at any phase:

1. restore `getBehaverRole.ts` to prior state via git
   ```bash
   git checkout -- src/domain.roles/behaver/getBehaverRole.ts
   ```

2. restore deleted shell files via git
   ```bash
   git checkout -- src/domain.roles/behaver/inits/init.claude.hooks*.sh
   ```

3. restore deleted test files via git
   ```bash
   git checkout -- src/domain.roles/behaver/inits/*.integration.test.ts
   ```

4. restore `.claude/settings.json` from backup
   ```bash
   mv .claude/settings.json.bak .claude/settings.json
   ```
