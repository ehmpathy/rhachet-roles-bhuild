# research: templates for Role.hooks migration

## summary

the primary template for this migration is [PR #167 in rhachet-roles-ehmpathy](https://github.com/ehmpathy/rhachet-roles-ehmpathy/pull/167) [1], which demonstrates the complete pattern for migrating from shell-based hook registration to rhachet's declarative `Role.hooks` interface.

---

## 1. template source

### 1.1 pr reference

| attribute | value |
|-----------|-------|
| repository | `ehmpathy/rhachet-roles-ehmpathy` |
| pr number | #167 |
| title | `fix(hooks): leverage Role.hooks.onBrain interface from rhachet` [1] |
| status | merged (2026-01-20) |
| branch | `vlad/role-hooks` |

### 1.2 scope of changes

the pr modified 25 files with +1813 additions and -819 deletions [1], including:
- role definition updates (`getMechanicRole.ts`)
- deprecation of shell-based hook management executables
- research documentation (`.behavior/` artifacts)
- blueprint and roadmap for the migration

---

## 2. key patterns from template

### 2.1 pattern: declarative Role.hooks structure

the template shows hooks declared directly on the Role object [2]:

```typescript
export const ROLE_MECHANIC: Role = Role.build({
  slug: 'mechanic',
  name: 'Mechanic',
  purpose: 'write code',
  readme: { uri: `${__dirname}/readme.md` },
  traits: [],
  briefs: {
    dirs: { uri: `${__dirname}/briefs` },
  },
  skills: {
    dirs: { uri: `${__dirname}/skills` },
    refs: [],
  },
  inits: {
    dirs: { uri: `${__dirname}/inits` },
    exec: [{ cmd: `${__dirname}/inits/init.claude.sh` }],
  },
  hooks: {
    onBrain: {
      onBoot: [
        {
          command:
            './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/sessionstart.notify-permissions',
          timeout: 'PT5S',
        },
        {
          command:
            './node_modules/.bin/rhachet roles boot --repo .this --role any --if-present',
          timeout: 'PT60S',
        },
        {
          command:
            './node_modules/.bin/rhachet roles boot --repo ehmpathy --role mechanic',
          timeout: 'PT60S',
        },
      ],
      onTool: [
        {
          command:
            './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.forbid-stderr-redirect',
          timeout: 'PT5S',
          filter: { what: 'Bash', when: 'before' },
        },
        {
          command:
            './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.forbid-terms.gerunds',
          timeout: 'PT5S',
          filter: { what: 'Write|Edit', when: 'before' },
        },
        {
          command:
            './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.forbid-terms.blocklist',
          timeout: 'PT5S',
          filter: { what: 'Write|Edit', when: 'before' },
        },
        {
          command:
            './node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/pretooluse.check-permissions',
          timeout: 'PT5S',
          filter: { what: 'Bash', when: 'before' },
        },
      ],
      onStop: [],
    },
  },
});
```

### 2.2 pattern: hook event mapping

the template establishes a clear mapping from shell-based hook types to Role.hooks events [3]:

| shell hook type | Role.hooks event | filter.when |
|----------------|------------------|-------------|
| `SessionStart` | `onBrain.onBoot` | n/a |
| `PreToolUse` | `onBrain.onTool` | `'before'` |
| `PostToolUse` | `onBrain.onTool` | `'after'` |
| `Stop` | `onBrain.onStop` | n/a |

### 2.3 pattern: timeout format

the template uses ISO 8601 duration format for timeouts [3]:

| seconds | ISO 8601 |
|---------|----------|
| 5 | `'PT5S'` |
| 10 | `'PT10S'` |
| 60 | `'PT60S'` |

### 2.4 pattern: filter specification

for `onTool` hooks, the template specifies filters [3]:

```typescript
{
  command: '...',
  timeout: 'PT5S',
  filter: { what: 'Bash', when: 'before' },
}
```

| filter.what | maps to shell matcher |
|-------------|----------------------|
| `'Bash'` | `--matcher "Bash"` |
| `'Write\|Edit'` | `--matcher "Write\|Edit"` |
| `'*'` | `--matcher "*"` (all tools) |

### 2.5 pattern: command format

commands use the `./node_modules/.bin/rhachet` path prefix [2]:

```typescript
'./node_modules/.bin/rhachet run --repo ehmpathy --role mechanic --init claude.hooks/sessionstart.notify-permissions'
```

this ensures:
- commands work from any directory via relative path from repo root
- no reliance on global npm installations
- consistent behavior across environments

### 2.6 pattern: deprecation of shell-based hook management

the template deprecates these files [3]:
- `init.claude.hooks.sh` — orchestrator executable
- `init.claude.hooks.findsert.sh` — jq-based hook insertion utility
- `init.claude.hooks.cleanup.sh` — stale hook removal
- `init.claude.hooks.cleanup.repograin.sh`
- `init.claude.hooks.cleanup.localgrain.sh`

the `inits.exec` array is simplified to only run non-hook initialization [2]:
```typescript
inits: {
  dirs: { uri: `${__dirname}/inits` },
  exec: [{ cmd: `${__dirname}/inits/init.claude.sh` }],
},
```

---

## 3. relation to wish

### 3.1 wish statement

from `.behavior/v2026_01_20.role-hooks/0.wish.md` [4]:

> "like was done in https://github.com/ehmpathy/rhachet-roles-ehmpathy/pull/167
>
> we want to drop the adhoc hooks management from this repo
>
> and instead leverage rhachet's new Role.hooks.onBrain interface
>
> upgrade to it and remove all the current hook management logic"

### 3.2 template fulfills wish via

1. **demonstrates the target architecture** — the mechanic role in rhachet-roles-ehmpathy shows exactly how hooks should be declared
2. **provides migration map** — the blueprint documents how each shell hook type maps to Role.hooks events
3. **establishes timeout format** — ISO 8601 durations replace numeric seconds
4. **shows filter specification** — `filter: { what, when }` replaces `--matcher` arguments
5. **identifies files to deprecate** — the shell executables for hook management become unnecessary

### 3.3 differences from this repo

| aspect | template (ehmpathy) | this repo (bhuild) |
|--------|--------------------|--------------------|
| role slug | `mechanic` | `behaver` |
| registry slug | `ehmpathy` | `bhuild` |
| hook count | 7 (3 onBoot + 4 onTool) | 1 (SessionStart only) |
| shell executables to deprecate | 5 files | 5 files (same pattern) |

---

## 4. application to this repo

### 4.1 current state (this repo)

the behaver role currently registers hooks via shell [5]:

```typescript
// src/domain.roles/behaver/getBehaverRole.ts
export const ROLE_BEHAVER: Role = Role.build({
  slug: 'behaver',
  // ...
  inits: {
    dirs: { uri: __dirname + '/inits' },
    exec: [{ cmd: __dirname + '/inits/init.claude.hooks.sh' }],
  },
});
```

the shell executable registers one hook [6]:

```bash
# SessionStart hook: boot behavior context
run_findsert "sessionstart.boot-behavior" \
  --hook-type SessionStart \
  --matcher "*" \
  --command "$RHACHET_INIT claude.hooks/sessionstart.boot-behavior" \
  --name "sessionstart.boot-behavior" \
  --timeout 10
```

### 4.2 target state (after migration)

```typescript
export const ROLE_BEHAVER: Role = Role.build({
  slug: 'behaver',
  // ...
  inits: {
    dirs: { uri: __dirname + '/inits' },
    // no exec for hooks — rhachet handles registration via Role.hooks
  },
  hooks: {
    onBrain: {
      onBoot: [
        {
          command:
            './node_modules/.bin/rhachet run --repo bhuild --role behaver --init claude.hooks/sessionstart.boot-behavior',
          timeout: 'PT10S',
        },
      ],
      onTool: [],
      onStop: [],
    },
  },
});
```

### 4.3 files to deprecate

following the template pattern, these files become unnecessary [3]:
- `src/domain.roles/behaver/inits/init.claude.hooks.sh`
- `src/domain.roles/behaver/inits/init.claude.hooks.findsert.sh`
- `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.sh`
- `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.repograin.sh`
- `src/domain.roles/behaver/inits/init.claude.hooks.cleanup.localgrain.sh`

---

## 5. rhachet version verification

the Role.hooks interface requires rhachet v1.24.0+ [3].

current installed version: **1.25.5** [7] — ✓ compatible

---

## 6. citations

[1] PR metadata — fetched via `gh api -X GET repos/ehmpathy/rhachet-roles-ehmpathy/pulls/167`:
> `"title":"fix(hooks): leverage Role.hooks.onBrain interface from rhachet"`, `"state":"closed"`, `"merged":true`, `"additions":1813`, `"deletions":819`, `"changed_files":25`

[2] `getMechanicRole.ts` content — fetched via `gh api -X GET repos/ehmpathy/rhachet-roles-ehmpathy/contents/src/domain.roles/mechanic/getMechanicRole.ts`:
> complete role definition with `hooks: { onBrain: { onBoot: [...], onTool: [...], onStop: [] } }` structure

[3] PR #167 blueprint — from `gh pr diff 167 --repo ehmpathy/rhachet-roles-ehmpathy`:
> `.behavior/v2026_01_19.role-hooks/3.3.blueprint.v1.i1.md` contains migration map, timeout format, and deprecation list

[4] this repo's wish — `.behavior/v2026_01_20.role-hooks/0.wish.md`:
> "like was done in https://github.com/ehmpathy/rhachet-roles-ehmpathy/pull/167 we want to drop the adhoc hooks management from this repo and instead leverage rhachet's new Role.hooks.onBrain interface"

[5] this repo's `getBehaverRole.ts` — `src/domain.roles/behaver/getBehaverRole.ts`:
> `exec: [{ cmd: __dirname + '/inits/init.claude.hooks.sh' }]`

[6] this repo's `init.claude.hooks.sh` — `src/domain.roles/behaver/inits/init.claude.hooks.sh`:
> `run_findsert "sessionstart.boot-behavior" --hook-type SessionStart --matcher "*" --command "$RHACHET_INIT claude.hooks/sessionstart.boot-behavior" --name "sessionstart.boot-behavior" --timeout 10`

[7] rhachet version — fetched via `npm list rhachet --depth=0`:
> `rhachet 1.25.5`

---

## 7. sources

- [PR #167: fix(hooks): leverage Role.hooks.onBrain interface from rhachet](https://github.com/ehmpathy/rhachet-roles-ehmpathy/pull/167)
- [rhachet-roles-ehmpathy repository](https://github.com/ehmpathy/rhachet-roles-ehmpathy)
- [rhachet npm package](https://www.npmjs.com/package/rhachet)
