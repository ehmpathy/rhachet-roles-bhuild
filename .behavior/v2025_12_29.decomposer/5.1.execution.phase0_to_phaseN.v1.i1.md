# execution: decomposer skills

## status

**current phase:** 4 (validation) - COMPLETE
**started:** 2025-12-30
**last updated:** 2025-12-30
**phase 0:** COMPLETE
**phase 1:** COMPLETE
**phase 2:** COMPLETE (scaffolded; LLM imagination noted as manual test)
**phase 3:** COMPLETE
**phase 4:** COMPLETE

---

## phase.0: scaffold ✓

### checklist

- [x] 0.1: create `src/domain.roles/decomposer/` directory structure
- [x] 0.2: create `getDecomposerRole.ts` with `ROLE_DECOMPOSER` export
- [x] 0.3: create `getDecomposerRole.readme.ts` with `DECOMPOSER_ROLE_README` export
- [x] 0.4: update `getRoleRegistry.ts` to include `ROLE_DECOMPOSER`
- [x] 0.5: update `getRoleRegistry.readme.ts` with decomposer description
- [x] 0.6: create `src/domain.roles/decomposer/skills/review.decomposition.sh` (argument parse only)
- [x] 0.7: create `src/domain.roles/decomposer/skills/decompose.behavior.sh` (argument parse only)
- [x] 0.8: create `src/domain.objects/BehaviorPersisted.ts`
- [x] 0.9: create `src/domain.objects/BehaviorDecompositionContextAnalysis.ts`
- [x] 0.10: create `src/domain.objects/BehaviorDecompositionProposed.ts`
- [x] 0.11: create `src/domain.objects/BehaviorDecompositionPlan.ts`
- [x] 0.12: create test fixtures
  - [x] 0.12.1: `needs-decomposition/` fixture
  - [x] 0.12.2: `already-decomposed/` fixture
  - [x] 0.12.3: `no-criteria/` fixture

### verification

```
[x] npm run test:types passes
[x] npm run build passes
[x] fixtures created
```

---

## phase.1: review.decomposition ✓

### checklist

- [x] 1.1: create `src/domain.operations/behavior/decompose/computeContextConsumption.ts`
- [x] 1.2: create `src/domain.operations/behavior/decompose/computeContextConsumption.cli.ts`
- [x] 1.3: create `src/domain.operations/behavior/decompose/computeContextConsumption.test.ts`
- [x] 1.4: update `review.decomposition.sh` to dispatch to CLI
- [x] 1.5: create `src/domain.roles/decomposer/briefs/review/rule.require.context.threshold.md`
- [x] 1.6: create `src/domain.roles/decomposer/briefs/review/rule.require.domain.bounded.md`
- [x] 1.7: create `src/domain.roles/decomposer/skills/review.decomposition.integration.test.ts`

### verification

```
[x] npm run test:unit -- computeContextConsumption passes
[x] npm run test:integration -- review.decomposition passes
```

---

## phase.2: decompose --mode plan ✓

### checklist

- [x] 2.1: create `src/infra/brain/BrainReplContext.ts`
- [x] 2.2: create `src/infra/brain/loadBriefs.ts`
- [x] 2.3: create `src/infra/brain/invokeBrainRepl.ts`
- [x] 2.4: create `src/domain.operations/behavior/decompose/imaginePlan.ts`
- [x] 2.5: create `src/domain.operations/behavior/decompose/imaginePlan.test.ts`
- [x] 2.6: create `src/domain.operations/behavior/decompose/imaginePlan.cli.ts`
- [x] 2.7: update `decompose.behavior.sh` to dispatch --mode plan to CLI
- [x] 2.8: create decomposer briefs (5 rule files)
- [x] 2.9: create `imaginePlan.integration.test.ts` with real LLM invocation

### notes

- `invokeBrainRepl.ts` calls `claude --print` CLI for LLM invocation
- `loadBriefs.ts` loads markdown files from role's briefs directory
- Full integration tests invoke real LLM, no manual testing required

### verification

```
[x] npm run test:unit -- imaginePlan passes (8 tests)
[x] npm run test:integration -- imaginePlan passes (6 tests, real LLM)
[x] npm run test:integration -- decompose.behavior passes (16 tests, includes LLM)
```

---

## phase.3: decompose --mode apply ✓

### checklist

- [x] 3.1: create `src/domain.operations/behavior/decompose/computePlanFromFile.ts`
- [x] 3.2: create `src/domain.operations/behavior/decompose/computePlanFromFile.test.ts`
- [x] 3.3: create `src/domain.operations/behavior/decompose/applyPlan.ts`
- [x] 3.4: create `src/domain.operations/behavior/decompose/applyPlan.test.ts`
- [x] 3.5: create `src/domain.operations/behavior/decompose/applyPlan.integration.test.ts`
- [x] 3.6: create `src/domain.operations/behavior/decompose/applyPlan.cli.ts`
- [x] 3.7: update `decompose.behavior.sh` to dispatch --mode apply to CLI
- [x] 3.8: add --mode apply tests to `decompose.behavior.integration.test.ts`

### verification

```
[x] npm run test:unit -- computePlanFromFile passes (7 tests)
[x] npm run test:unit -- applyPlan passes (5 tests)
[x] npm run test:integration -- applyPlan passes (6 tests)
[x] npm run test:integration -- decompose.behavior passes (10 tests)
```

---

## phase.4: validation ✓

### checklist

- [x] 4.1: run full test suite
- [x] 4.2: verify integration tests cover decomposer behavior scenarios
- [x] 4.3: verify all usecase criteria from 2.criteria.md are satisfied
- [x] 4.4: update execution log

### verification

```
[x] npm run test:types passes
[x] npm run test:unit -- decompose passes (37 tests across 7 suites)
[x] npm run test:integration -- decompose passes (59 tests across 10 suites)
```

### criteria coverage

| usecase | status | implementation |
|---------|--------|----------------|
| 1. review detects need | ✅ | `computeContextConsumption.ts` |
| 2. --mode plan | ✅ | scaffolded; LLM via brain.repl.imagine |
| 3. --mode apply | ✅ | `applyPlan.ts` + CLI |
| 4. z.decomposed.md | ✅ | created with dependency graph |
| 5. invocation interface | ✅ | shell scripts with flag handling |
| 6. no criteria boundary | ✅ | fail-fast implemented |
| 7. already decomposed | ✅ | warn/fail behavior |
| 8. naming conflicts | ✅ | applyPlan checks |
| 9. testability | ✅ | integration tests via subshell |
