# roadmap: decomposer skills

## overview

execute the blueprint in phases with behavioral verification at each step.

**dependencies flow:**
```
phase.0 (scaffold)
    ↓
phase.1 (review.decomposition)
    ↓
phase.2 (decompose --mode plan)
    ↓
phase.3 (decompose --mode apply)
    ↓
phase.4 (validation)
```

---

## phase.0: scaffold

**depends on:** none

### checklist

- [ ] 0.1: create `src/domain.roles/decomposer/` directory structure
- [ ] 0.2: create `getDecomposerRole.ts` with `ROLE_DECOMPOSER` export
- [ ] 0.3: create `getDecomposerRole.readme.ts` with `DECOMPOSER_ROLE_README` export
- [ ] 0.4: update `getRoleRegistry.ts` to include `ROLE_DECOMPOSER`
- [ ] 0.5: update `getRoleRegistry.readme.ts` with decomposer description
- [ ] 0.6: create `src/domain.roles/decomposer/skills/review.decomposition.sh` (argument parse only)
- [ ] 0.7: create `src/domain.roles/decomposer/skills/decompose.behavior.sh` (argument parse only)
- [ ] 0.8: create `src/domain.objects/BehaviorPersisted.ts`
- [ ] 0.9: create `src/domain.objects/BehaviorDecompositionContextAnalysis.ts`
- [ ] 0.10: create `src/domain.objects/BehaviorDecompositionProposed.ts`
- [ ] 0.11: create `src/domain.objects/BehaviorDecompositionPlan.ts`
- [ ] 0.12: create test fixtures in `src/domain.roles/decomposer/skills/.test/assets/example.repo/`
  - [ ] 0.12.1: `needs-decomposition/` fixture (>30% context)
  - [ ] 0.12.2: `already-decomposed/` fixture (has z.decomposed.md)
  - [ ] 0.12.3: `no-criteria/` fixture (no 2.criteria.md)

### acceptance criteria

```
given('phase.0 complete')
  when('getRoleRegistry() invoked')
    then('registry includes ROLE_DECOMPOSER')
      verify('npm run test:types passes')

given('phase.0 complete')
  when('review.decomposition.sh --help invoked')
    then('skill outputs usage info without error')
      verify('bash src/domain.roles/decomposer/skills/review.decomposition.sh --help')

given('phase.0 complete')
  when('decompose.behavior.sh --help invoked')
    then('skill outputs usage info without error')
      verify('bash src/domain.roles/decomposer/skills/decompose.behavior.sh --help')

given('phase.0 complete')
  when('test fixtures inspected')
    then('needs-decomposition has >30% context worth of artifacts')
    then('already-decomposed has z.decomposed.md')
    then('no-criteria has no 2.criteria.md')
      verify('ls -la src/domain.roles/decomposer/skills/.test/assets/example.repo/*/')
```

### verification command

```sh
npm run test:types && \
bash src/domain.roles/decomposer/skills/review.decomposition.sh --help && \
bash src/domain.roles/decomposer/skills/decompose.behavior.sh --help
```

---

## phase.1: review.decomposition

**depends on:** phase.0

### checklist

- [ ] 1.1: create `src/contract/cli/review.decomposition.ts`
- [ ] 1.2: create `src/domain.operations/behavior/decompose/computeContextConsumption.ts`
- [ ] 1.3: create `src/domain.operations/behavior/decompose/computeContextConsumption.test.ts`
- [ ] 1.4: update `review.decomposition.sh` to dispatch to CLI
- [ ] 1.5: create `src/domain.roles/decomposer/briefs/review/rule.require.context.threshold.md`
- [ ] 1.6: create `src/domain.roles/decomposer/briefs/review/rule.require.domain.bounded.md`
- [ ] 1.7: create `src/domain.roles/decomposer/skills/review.decomposition.integration.test.ts`

### acceptance criteria

```
given('[case1] behavior with criteria + research + distill under 30%')
  when('[t0] review.decomposition invoked')
    then('reports actual context consumption percentage')
    then('recommendation is DECOMPOSE_UNNEEDED')
      verify('run review.decomposition against valid-behavior fixture')

given('[case2] behavior with artifacts over 30%')
  when('[t0] review.decomposition invoked')
    then('flags hazard with percentage')
    then('recommendation is DECOMPOSE_REQUIRED')
      verify('run review.decomposition against needs-decomposition fixture')

given('[case3] behavior without criteria')
  when('[t0] review.decomposition invoked')
    then('fails fast with "criteria required for decomposition analysis"')
      verify('run review.decomposition against no-criteria fixture')
```

### verification command

```sh
npm run test:unit -- computeContextConsumption && \
npm run test:integration -- review.decomposition
```

---

## phase.2: decompose --mode plan

**depends on:** phase.1

### checklist

- [ ] 2.1: create `src/infra/brain/BrainReplContext.ts`
- [ ] 2.2: create `src/infra/brain/loadBriefs.ts`
- [ ] 2.3: create `src/infra/brain/invokeBrainRepl.ts`
- [ ] 2.4: create `src/domain.operations/behavior/decompose/imaginePlan.ts`
- [ ] 2.5: create `src/domain.operations/behavior/decompose/imaginePlan.test.ts`
- [ ] 2.6: create `src/contract/cli/decompose.behavior.ts` (--mode plan only)
- [ ] 2.7: update `decompose.behavior.sh` to dispatch to CLI
- [ ] 2.8: create `src/domain.roles/decomposer/briefs/decompose/rule.require.contexts.bounded.md`
- [ ] 2.9: create `src/domain.roles/decomposer/briefs/decompose/rule.require.dependencies.directional.md`
- [ ] 2.10: create `src/domain.roles/decomposer/briefs/decompose/rule.require.names.ubiquitous.md`
- [ ] 2.11: create `src/domain.roles/decomposer/briefs/decompose/rule.require.wish.scoped.md`
- [ ] 2.12: create `src/domain.roles/decomposer/briefs/decompose/rule.require.vision.scoped.md`
- [ ] 2.13: add --mode plan tests to `decompose.behavior.integration.test.ts`

### acceptance criteria

```
given('[case1] behavior that needs decomposition')
  when('[t0] --mode plan invoked')
    then('emits plan file to z.plan.decomposition.v1.json')
    then('plan includes proposed behavior names')
    then('plan includes dependency graph')
    then('plan includes decomposed wish per behavior')
    then('plan includes decomposed vision per behavior (or null)')
      verify('run decompose.behavior --mode plan against needs-decomposition fixture')

given('[case2] behavior without criteria')
  when('[t0] --mode plan invoked')
    then('fails fast with "criteria required for decomposition"')
      verify('run decompose.behavior --mode plan against no-criteria fixture')

given('[case3] behavior already decomposed')
  when('[t0] --mode plan invoked')
    then('warns "behavior already decomposed"')
    then('shows behaviors found')
      verify('run decompose.behavior --mode plan against already-decomposed fixture')
```

### verification command

```sh
npm run test:unit -- imaginePlan && \
npm run test:integration -- decompose.behavior
```

---

## phase.3: decompose --mode apply

**depends on:** phase.2

### checklist

- [ ] 3.1: create `src/domain.operations/behavior/decompose/computePlanFromFile.ts`
- [ ] 3.2: create `src/domain.operations/behavior/decompose/computePlanFromFile.test.ts`
- [ ] 3.3: create `src/domain.operations/behavior/decompose/applyPlan.ts`
- [ ] 3.4: create `src/domain.operations/behavior/decompose/applyPlan.test.ts`
- [ ] 3.5: create `src/domain.operations/behavior/decompose/applyPlan.integration.test.ts`
- [ ] 3.6: update `src/contract/cli/decompose.behavior.ts` to support --mode apply
- [ ] 3.7: add --mode apply tests to `decompose.behavior.integration.test.ts`

### acceptance criteria

```
given('[case1] valid plan file')
  when('[t0] --mode apply invoked with --plan')
    then('creates behavior directories via init.behavior')
    then('behavior 0.wish.md contains decomposed wish')
    then('behavior 1.vision.md contains decomposed vision or empty')
    then('behavior 2.criteria.md contains template only (NOT copied)')
    then('creates z.decomposed.md in parent')
      verify('run decompose.behavior --mode apply with generated plan')

given('[case2] --mode apply without --plan flag')
  when('[t0] skill invoked')
    then('fails fast with "--plan required"')
      verify('run decompose.behavior --mode apply without --plan')

given('[case3] behavior already decomposed')
  when('[t0] --mode apply invoked')
    then('fails fast with "remove z.decomposed.md to re-decompose"')
      verify('run decompose.behavior --mode apply against already-decomposed fixture')

given('[case4] plan with behavior name conflict')
  when('[t0] --mode apply invoked')
    then('fails fast with "behavior {name} already exists"')
      verify('run decompose.behavior --mode apply with conflicted plan')
```

### verification command

```sh
npm run test:unit -- computePlanFromFile && \
npm run test:unit -- applyPlan && \
npm run test:integration -- applyPlan && \
npm run test:integration -- decompose.behavior
```

---

## phase.4: validation

**depends on:** phase.3

### checklist

- [ ] 4.1: run full test suite
- [ ] 4.2: run review.decomposition against this decomposer behavior (meta-test)
- [ ] 4.3: verify all usecase criteria from 2.criteria.md are satisfied
- [ ] 4.4: update root readme.md with decomposer role
- [ ] 4.5: commit and open PR

### acceptance criteria

```
given('all phases complete')
  when('npm run test invoked')
    then('all tests pass')
      verify('npm run test')

given('all phases complete')
  when('review.decomposition run against .behavior/v2025_12_29.decomposer/')
    then('outputs context analysis')
    then('recommendation reflects actual artifact size')
      verify('bash src/domain.roles/decomposer/skills/review.decomposition.sh --for.behavior decomposer')

given('all phases complete')
  when('2.criteria.md usecases reviewed')
    then('usecase.1 (review skill) is satisfied')
    then('usecase.2 (decompose --mode plan) is satisfied')
    then('usecase.3 (decompose --mode apply) is satisfied')
    then('usecase.4 (z.decomposed.md) is satisfied')
    then('usecase.5 (skill invocation interface) is satisfied')
    then('usecase.6 (boundary: no criteria) is satisfied')
    then('usecase.7 (boundary: already decomposed) is satisfied')
    then('usecase.8 (boundary: name conflicts) is satisfied')
    then('usecase.9 (testability) is satisfied')
      verify('manual review of criteria coverage')
```

### verification command

```sh
npm run test && \
bash src/domain.roles/decomposer/skills/review.decomposition.sh --for.behavior decomposer --dir .
```

---

## summary

| phase | items | depends on | key deliverable |
|-------|-------|------------|-----------------|
| 0 | 12 | - | scaffold + fixtures |
| 1 | 7 | 0 | review.decomposition skill |
| 2 | 13 | 1 | decompose --mode plan |
| 3 | 7 | 2 | decompose --mode apply |
| 4 | 5 | 3 | validation + release |

**total items:** 44
