# blueprint: catch.dream ğŸŒ™

## summary

implement `catch.dream` skill for the dreamer role â€” a lightweight findsert operation that captures transient ideas without loss of focus.

**core flow:**
```
user invokes: npx rhachet run --skill catch.dream --name "config-reload" --open codium

1. normalize dream name â†’ "config-reload"
2. bootstrap .dream/ folder if absent (findsert .readme.md)
3. findsert dream file (find prior or create new)
4. open in editor (if --open provided)
5. fuzzy match prompt (if similar dreams from past week)
6. output: ğŸŒ™ dream caught|found
```

---

## 1. filediffs treestruct

```
src/
â”œâ”€â”€ domain.objects/
â”‚   â””â”€â”€ dreamer/
â”‚       â”œâ”€â”€ [+] DreamArtifact.ts                    # literal: persisted dream
â”‚       â”œâ”€â”€ [+] DreamArtifact.test.ts               # unit: identity, unique keys
â”‚       â””â”€â”€ [+] DreamCandidate.ts                   # literal: fuzzy match result
â”‚
â”œâ”€â”€ domain.operations/
â”‚   â””â”€â”€ dreamer/
â”‚       â”œâ”€â”€ dreams/
â”‚       â”‚   â”œâ”€â”€ [+] normalizeDreamName.ts           # pure: kebab-case transform
â”‚       â”‚   â”œâ”€â”€ [+] normalizeDreamName.test.ts      # unit: edge cases
â”‚       â”‚   â”œâ”€â”€ [+] getOneDreamByName.ts            # getOne by unique
â”‚       â”‚   â”œâ”€â”€ [+] getOneDreamByName.test.ts       # unit: glob, parse
â”‚       â”‚   â”œâ”€â”€ [+] getAllDreamsFromPastWeek.ts     # getAll filtered
â”‚       â”‚   â”œâ”€â”€ [+] getAllDreamsFromPastWeek.test.ts
â”‚       â”‚   â”œâ”€â”€ [+] getAllDreamsBySimilarity.ts     # fuzzy search
â”‚       â”‚   â”œâ”€â”€ [+] getAllDreamsBySimilarity.test.ts
â”‚       â”‚   â”œâ”€â”€ [+] setDream.ts                     # findsert operation
â”‚       â”‚   â”œâ”€â”€ [+] setDream.test.ts                # unit: findsert logic
â”‚       â”‚   â”œâ”€â”€ [+] setDream.integration.test.ts    # integration: fs operations
â”‚       â”‚   â”œâ”€â”€ [+] genDreamDir.ts                  # idempotent bootstrap
â”‚       â”‚   â”œâ”€â”€ [+] genDreamDir.test.ts
â”‚       â”‚   â”œâ”€â”€ [+] appendOntoDream.ts              # content merge
â”‚       â”‚   â”œâ”€â”€ [+] appendOntoDream.test.ts
â”‚       â”‚   â”œâ”€â”€ [+] deleteDream.ts                  # cleanup operation
â”‚       â”‚   â””â”€â”€ [+] deleteDream.test.ts
â”‚       â”‚
â”‚       â””â”€â”€ catch/
â”‚           â”œâ”€â”€ [+] runCatchDream.ts                # main composer
â”‚           â”œâ”€â”€ [+] runCatchDream.test.ts           # unit: composition logic
â”‚           â””â”€â”€ [+] runCatchDream.integration.test.ts
â”‚
â”œâ”€â”€ domain.roles/
â”‚   â””â”€â”€ [+] dreamer/
â”‚       â”œâ”€â”€ [+] getDreamerRole.ts                   # role definition
â”‚       â”œâ”€â”€ [+] getDreamerRole.test.ts
â”‚       â”œâ”€â”€ [+] readme.md                           # role readme
â”‚       â””â”€â”€ skills/
â”‚           â””â”€â”€ [+] catch.dream.sh                  # shell dispatcher
â”‚
â”œâ”€â”€ contract/
â”‚   â””â”€â”€ cli/
â”‚       â”œâ”€â”€ [+] catch.dream.ts                      # CLI entry point
â”‚       â””â”€â”€ [+] catch.dream.test.ts                 # unit: arg parse, validation
â”‚
â”œâ”€â”€ [~] index.ts                                    # add cli.catchDream export
â”‚
â””â”€â”€ infra/
    â””â”€â”€ [â†] shell/
        â””â”€â”€ openFileWithOpener.ts                   # REUSE: editor open
```

**legend:**
- `[+] create` â€” file to create
- `[~] update` â€” file to update
- `[-] delete` â€” file to delete
- `[â†]` â€” reuse from elsewhere

---

## 2. contracts

### 2.1 CLI contract

```typescript
// src/contract/cli/catch.dream.ts

const schemaOfArgs = z.object({
  named: z.object({
    name: z.string(),
    open: z.string().optional(),
    // rhachet passthrough args (optional, ignored)
    repo: z.string().optional(),
    role: z.string().optional(),
    skill: z.string().optional(),
    s: z.string().optional(),
  }),
  ordered: z.array(z.string()).default([]),
});
```

### 2.2 runCatchDream contract

```typescript
// src/domain.operations/dreamer/catch/runCatchDream.ts

/**
 * .what = catches a dream via findsert pattern
 * .why = enables transient idea capture without focus loss
 */
const runCatchDream = async (
  input: {
    name: string;
    open?: string;
  },
  context: {
    repoRoot: string;
    log: LogMethods;
  },
): Promise<{
  dream: DreamArtifact;
  outcome: 'caught' | 'found';
  candidates: DreamCandidate[];
}> => { ... };
```

### 2.3 domain object contracts

```typescript
// src/domain.objects/dreamer/DreamArtifact.ts
interface DreamArtifact {
  path: string;               // .dream/2026_01_27.config-reload.dream.md
  name: string;               // config-reload
  date: IsoDateStamp;         // 2026_01_27
  filename: string;           // 2026_01_27.config-reload.dream.md
}
class DreamArtifact extends DomainLiteral<DreamArtifact> implements DreamArtifact {
  public static primary = ['path'] as const;
  public static unique = ['path'] as const;
}

// src/domain.objects/dreamer/DreamCandidate.ts
interface DreamCandidate {
  dream: DreamArtifact;
  distance: number;           // edit distance (lower = closer)
}
class DreamCandidate extends DomainLiteral<DreamCandidate> implements DreamCandidate {
  public static nested = { dream: DreamArtifact };
}
```

---

## 3. codepaths treestruct

### 3.1 happy path: new dream

```
npx rhachet run --skill catch.dream --name "config-reload" --open codium
  â”‚
  â””â”€â”€ catch.dream.sh                                             [+] create
        â”‚
        â””â”€â”€ node -e "import('rhachet-roles-bhuild').then(m => m.cli.catchDream())"
              â”‚
              â””â”€â”€ catch.dream.ts                                 [+] create
                    â”‚
                    â”œâ”€â”€ getCliArgs({ schema })                   [â†] reuse
                    â”œâ”€â”€ validate --open has value                [+] create
                    â”‚
                    â””â”€â”€ runCatchDream({ name, open }, context)   [+] create
                          â”‚
                          â”œâ”€â”€ normalizeDreamName({ raw })        [+] create
                          â”‚     â””â”€â”€ returns "config-reload"
                          â”‚
                          â”œâ”€â”€ genDreamDir({ repoRoot })          [+] create
                          â”‚     â”œâ”€â”€ mkdir .dream/ (idempotent)
                          â”‚     â””â”€â”€ findsert .readme.md
                          â”‚
                          â”œâ”€â”€ setDream({ findsert })             [+] create
                          â”‚     â”œâ”€â”€ getOneDreamByName()          [+] create
                          â”‚     â”‚     â””â”€â”€ glob: .dream/*.config-reload.dream.md
                          â”‚     â”‚     â””â”€â”€ returns null (not found)
                          â”‚     â”‚
                          â”‚     â””â”€â”€ creates .dream/2026_01_27.config-reload.dream.md
                          â”‚           â””â”€â”€ content: "dream = \n\n"
                          â”‚
                          â”œâ”€â”€ openFileWithOpener()               [â†] reuse
                          â”‚     â””â”€â”€ execSync("codium .dream/...")
                          â”‚
                          â””â”€â”€ getAllDreamsBySimilarity()         [+] create
                                â”œâ”€â”€ getAllDreamsFromPastWeek()   [+] create
                                â””â”€â”€ computeEditDistance()        [+] create
                                      â””â”€â”€ returns [] (no matches)
```

### 3.2 happy path: prior dream found

```
npx rhachet run --skill catch.dream --name "config-reload"
  â”‚
  â””â”€â”€ ...same dispatch...
        â”‚
        â””â”€â”€ runCatchDream()
              â”‚
              â””â”€â”€ setDream({ findsert })
                    â”‚
                    â””â”€â”€ getOneDreamByName()
                          â””â”€â”€ glob matches .dream/2026_01_20.config-reload.dream.md
                          â””â”€â”€ returns DreamArtifact { path, name, date, filename }
                    â”‚
                    â””â”€â”€ returns { dream: dreamFound, outcome: 'found' }
```

### 3.3 fuzzy match recovery path

```
runCatchDream({ name: "config-relod" })  # typo
  â”‚
  â”œâ”€â”€ setDream() â†’ creates new file, outcome: 'caught'
  â”‚
  â”œâ”€â”€ openFileWithOpener() â†’ editor opens immediately (no latency)
  â”‚
  â””â”€â”€ getAllDreamsBySimilarity({ name, dreamDir })
        â”‚
        â”œâ”€â”€ getAllDreamsFromPastWeek()
        â”‚     â””â”€â”€ returns [{ name: "config-reload", ... }]
        â”‚
        â””â”€â”€ computeEditDistance("config-relod", "config-reload")
              â””â”€â”€ distance = 1 (< threshold 3)
              â””â”€â”€ returns [DreamCandidate { dream, distance: 1 }]
```

**legend:**
- `[+]` create â€” codepath to create
- `[~]` update â€” codepath to update
- `[â—‹]` retain â€” codepath to retain
- `[â†]` reuse â€” codepath to reuse from elsewhere

---

## 4. reuse matrix

| component                  | status     | source                                     |
| -------------------------- | ---------- | ------------------------------------------ |
| `openFileWithOpener`       | [â†] reuse  | `src/infra/shell/openFileWithOpener.ts`    |
| `getCliArgs`               | [â†] reuse  | `src/infra/cli/getCliArgs.ts`              |
| `withEmojiSpaceShim`       | [â†] reuse  | `src/infra/shell/withEmojiSpaceShim.ts`    |
| `toIsoDateStamp`           | [â†] reuse  | `iso-time` package                         |
| `BehaviorArtifact` pattern | [â†] reuse  | `src/domain.objects/BehaviorArtifact.ts`   |
| `init.behavior.ts` pattern | [â†] reuse  | `src/contract/cli/init.behavior.ts`        |
| `OpenerUnavailableError`   | [â†] reuse  | `src/infra/shell/openFileWithOpener.ts`    |
| `normalizeDreamName`       | [+] create | â€”                                          |
| `getOneDreamByName`        | [+] create | â€”                                          |
| `getAllDreamsFromPastWeek` | [+] create | â€”                                          |
| `getAllDreamsBySimilarity` | [+] create | â€”                                          |
| `setDream`                 | [+] create | findsert pattern from `initBehaviorDir.ts` |
| `genDreamDir`              | [+] create | mkdir pattern from `initBehaviorDir.ts`    |
| `appendOntoDream`          | [+] create | â€”                                          |
| `deleteDream`              | [+] create | â€”                                          |
| `computeEditDistance`      | [+] create | levenshtein distance                       |

---

## 5. test coverage

### 5.1 unit tests

| file                               | covers              | assertions                                    |
| ---------------------------------- | ------------------- | --------------------------------------------- |
| `DreamArtifact.test.ts`            | literal identity    | primary/unique keys, build()                  |
| `DreamCandidate.test.ts`           | literal with nested | nested hydration                              |
| `normalizeDreamName.test.ts`       | pure transform      | spaces, uppercase, special chars, edge dashes |
| `getOneDreamByName.test.ts`        | glob parse          | found, not found, multiple error              |
| `getAllDreamsFromPastWeek.test.ts` | date filter         | within week, outside week, empty              |
| `getAllDreamsBySimilarity.test.ts` | edit distance       | threshold, sort order, skip exact             |
| `setDream.test.ts`                 | findsert logic      | find prior, create new                        |
| `genDreamDir.test.ts`              | idempotent mkdir    | create, skip prior, readme findsert           |
| `appendOntoDream.test.ts`          | content merge       | separator, order                              |
| `deleteDream.test.ts`              | file removal        | exists, not exists                            |
| `runCatchDream.test.ts`            | composition         | delegates correctly, error handlers           |
| `catch.dream.test.ts`              | CLI arg parse       | name required, open optional, empty open      |

### 5.2 integration tests

| file                                | covers     | real boundaries        |
| ----------------------------------- | ---------- | ---------------------- |
| `setDream.integration.test.ts`      | findsert   | filesystem glob, write |
| `runCatchDream.integration.test.ts` | end-to-end | fs, editor spawn       |
| `genDreamDir.integration.test.ts`   | bootstrap  | mkdir, writeFile       |

### 5.3 acceptance tests

| file                             | covers     | blackbox criteria |
| -------------------------------- | ---------- | ----------------- |
| `catch.dream.acceptance.test.ts` | full skill | episode.1-6       |

```typescript
// blackbox/role=dreamer/skill.catch.dream.acceptance.test.ts

describe('catch.dream skill', () => {
  given('[case1] repo with no prior dreams', () => {
    when('[t0] catch.dream --name "config-reload" --open echo', () => {
      then('file .dream/YYYY_MM_DD.config-reload.dream.md is created', ...);
      then('file contains "dream = " template', ...);
      then('output shows "ğŸŒ™ dream caught"', ...);
    });
  });

  given('[case2] repo with prior dream', () => {
    when('[t0] catch.dream --name "config-reload"', () => {
      then('no new file is created', ...);
      then('output shows "ğŸŒ™ dream found"', ...);
    });
  });

  given('[case3] input with spaces', () => {
    when('[t0] catch.dream --name "Config Hot Reload"', () => {
      then('file is created as config-hot-reload', ...);
    });
  });

  given('[case4] outside git repo', () => {
    when('[t0] catch.dream --name "idea"', () => {
      then('error shows "no git repo found"', ...);
    });
  });

  given('[case5] no --name provided', () => {
    when('[t0] catch.dream', () => {
      then('error shows "--name is required"', ...);
    });
  });

  given('[case6] .dream/ folder does not exist', () => {
    when('[t0] catch.dream --name "first-idea"', () => {
      then('.dream/ folder is created', ...);
      then('.dream/.readme.md is created', ...);
    });
  });
});
```

---

## 6. implementation sequence

| phase | action                                       | depends on                               |
| ----- | -------------------------------------------- | ---------------------------------------- |
| 1     | create `DreamArtifact.ts` + tests            | â€”                                        |
| 2     | create `DreamCandidate.ts` + tests           | DreamArtifact                            |
| 3     | create `normalizeDreamName.ts` + tests       | â€”                                        |
| 4     | create `genDreamDir.ts` + tests              | â€”                                        |
| 5     | create `getOneDreamByName.ts` + tests        | DreamArtifact                            |
| 6     | create `setDream.ts` + tests                 | getOneDreamByName, DreamArtifact         |
| 7     | create `getAllDreamsFromPastWeek.ts` + tests | DreamArtifact                            |
| 8     | create `getAllDreamsBySimilarity.ts` + tests | getAllDreamsFromPastWeek, DreamCandidate |
| 9     | create `appendOntoDream.ts` + tests          | DreamArtifact                            |
| 10    | create `deleteDream.ts` + tests              | DreamArtifact                            |
| 11    | create `runCatchDream.ts` + tests            | all above                                |
| 12    | create `catch.dream.ts` CLI + tests          | runCatchDream                            |
| 13    | create `catch.dream.sh` shell skill          | catch.dream.ts                           |
| 14    | create `getDreamerRole.ts` + tests           | catch.dream.sh                           |
| 15    | update `src/index.ts` exports                | catch.dream.ts                           |
| 16    | create acceptance tests                      | all above                                |

---

## 7. dependencies

### 7.1 external packages (all are prior)

| package          | usage                   |
| ---------------- | ----------------------- |
| `domain-objects` | DomainLiteral base      |
| `iso-time`       | IsoDateStamp type       |
| `zod`            | CLI arg validation      |
| `glob`           | file pattern match      |
| `helpful-errors` | UnexpectedCodePathError |

### 7.2 internal dependencies

| operation                  | depends on                                                                              |
| -------------------------- | --------------------------------------------------------------------------------------- |
| `runCatchDream`            | normalizeDreamName, genDreamDir, setDream, getAllDreamsBySimilarity, openFileWithOpener |
| `setDream`                 | getOneDreamByName                                                                       |
| `getAllDreamsBySimilarity` | getAllDreamsFromPastWeek                                                                |

---

## 8. risks and mitigations

### 8.1 risk: glob pattern edge cases

**risk:** dream names with dots may conflict with glob pattern
**mitigation:** escape dots in name when the glob pattern is built; test with edge case names

### 8.2 risk: edit distance threshold calibration

**risk:** threshold too high = noise; too low = no recovery
**mitigation:** default threshold = 3; make configurable; test with realistic typos

### 8.3 risk: fuzzy match prompt UX

**risk:** interactive prompt may not work in all terminal contexts
**mitigation:** prompt appears after editor opens; user can ignore via timeout

---

## 9. verification checklist

### 9.1 before implementation

- [ ] confirm domain distillation approved
- [ ] confirm reuse sources are stable

### 9.2 after implementation

- [ ] `npm run build` succeeds
- [ ] `npm run test:types` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run test:integration` passes
- [ ] `npm run test:acceptance` passes
- [ ] skill executes: `npx rhachet run --skill catch.dream --name test`
- [ ] dream file created in `.dream/`
- [ ] prior dream reused on second run
- [ ] output format matches criteria

---

## 10. references

- wish: `.behavior/v2026_01_27.catch-dream/0.wish.md`
- vision: `.behavior/v2026_01_27.catch-dream/1.vision.md`
- criteria: `.behavior/v2026_01_27.catch-dream/2.1.criteria.blackbox.md`
- coverage matrix: `.behavior/v2026_01_27.catch-dream/2.2.criteria.blackbox.matrix.md`
- prod patterns: `.behavior/v2026_01_27.catch-dream/3.1.research.patterns._.code.prod.v1.i1.md`
- domain distill: `.behavior/v2026_01_27.catch-dream/3.2.distill.domain._.v1.i1.md`

---

ğŸŒ™
